<!--

 -----------------
< 终于等到你 >
 -----------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
----------------------------------

我正在构建一个基于网络协作的虚拟团队，
喜欢你这种没事喜欢翻源码的人
如果你恰好也热爱技术、喜欢折腾，来啊，互相伤害，一起捣鼓好玩的东西吧
联系我咯: wuwenjie718@gmail.com
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>使用backup异地备份edX数据</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="writing for time">
    <meta name="author" content="wwj">

    <!-- Le styles -->
    <link href="//cdn.bootcss.com/twitter-bootstrap/2.0.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="//7kttuq.com1.z0.glb.clouddn.com/just4fun.png?imageView2/2/w/50" type="image/x-icon">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
	
	.tag-1 {
		font-size: 13pt;
	}
	
	.tag-2 {
		font-size: 10pt;
	}
	
	.tag-2 {
		font-size: 8pt;
	}

	.tag-4 {
		font-size: 6pt;
	}

  #footer img{
    visibility: hidden;
  }
	
    </style>
    <link href="//cdn.bootcss.com/twitter-bootstrap/2.0.4/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="//cdn.bootcss.com/font-awesome/3.0.0/css/font-awesome.min.css" rel="stylesheet">
	
    <link href="/theme/css/pygments.css" rel="stylesheet">
	<link href="/theme/css/mystyle.css" rel="stylesheet">
    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->


  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/index.html">writing for time </a>
          <div class="nav-collapse">
            <ul class="nav">
			  <li class="divider-vertical"></li>
                  <li >
                    <a href="/category/编程.html">
						<i class="icon-folder-open icon-large"></i>编程
					</a>
                  </li>
                  <li >
                    <a href="/category/读书.html">
						<i class="icon-folder-open icon-large"></i>读书
					</a>
                  </li>
                  <li class="active">
                    <a href="/category/edx.html">
						<i class="icon-folder-open icon-large"></i>edx
					</a>
                  </li>
                  <li >
                    <a href="/category/工具.html">
						<i class="icon-folder-open icon-large"></i>工具
					</a>
                  </li>
                  <li >
                    <a href="/category/观念.html">
						<i class="icon-folder-open icon-large"></i>观念
					</a>
                  </li>
                  <li >
                    <a href="/category/技术.html">
						<i class="icon-folder-open icon-large"></i>技术
					</a>
                  </li>
                  <li >
                    <a href="/category/架构.html">
						<i class="icon-folder-open icon-large"></i>架构
					</a>
                  </li>
                  <li >
                    <a href="/category/空想.html">
						<i class="icon-folder-open icon-large"></i>空想
					</a>
                  </li>
                  <li >
                    <a href="/category/诗词.html">
						<i class="icon-folder-open icon-large"></i>诗词
					</a>
                  </li>
                  <li >
                    <a href="/category/数据.html">
						<i class="icon-folder-open icon-large"></i>数据
					</a>
                  </li>
                  <li >
                    <a href="/category/算法.html">
						<i class="icon-folder-open icon-large"></i>算法
					</a>
                  </li>
                  <li >
                    <a href="/category/随笔.html">
						<i class="icon-folder-open icon-large"></i>随笔
					</a>
                  </li>
                  <li >
                    <a href="/category/瓦碎集.html">
						<i class="icon-folder-open icon-large"></i>瓦碎集
					</a>
                  </li>
                  <li >
                    <a href="/category/硬件.html">
						<i class="icon-folder-open icon-large"></i>硬件
					</a>
                  </li>
			  
			  <ul class="nav pull-right">
				<li><a href="/archives.html"><i class="icon-th-list"></i>Archives</a></li>
			  </ul>
			  
            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>





    <div class="container-fluid">
      <div class="row">

        <div class="span8 offset1" id="content">
            <!--<div class="alert alert-success" style="font-size:18px;">>  你那里天气好吗，有什么新闻可以当做笑话</div>-->
<section id="content">    
	<article>
		<header>
			<h1>
				<a href=""
					rel="bookmark" 
					title="Permalink to 使用backup异地备份edX数据">
					使用backup异地备份edX数据 
				</a>
			</h1> 
		</header>
		<div class="entry-content">
		<div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2015-06-04T00:00:00+00:00">
	<i class="icon-calendar"></i>四 04 六月 2015
</abbr>
<span class="label">By</span>
<a href="/author/wuwenjie.html"><i class="icon-user"></i>wuwenjie</a>
<span class="label">Category</span>
<a href="/category/edx.html"><i class="icon-folder-open"></i>edx</a>. 

	
<span class="label">Tags</span> 
	<a href="/tag/edx.html"><i class="icon-tag"></i>edx</a>
</footer><!-- /.post-info -->		</div>
		<blockquote>
<p>Don't put all your eggs in one basket</p>
</blockquote>
<p>为了提升逼格，我决定使用英文版的的这句作为开头，尽管我最初想到的是中文版orz</p>
<p>天灾人祸这种事，总归是有的。尽管服务器的灾难性故障不常发生，概率也比遇到鬼或是遇到爱情来得高些，将风险考虑在内总归是好的，所谓有备无患。如果你已经在自己的架构中将单点故障考虑进去了，就不必往下拉啦，继续舔酸奶盖去吧~如果你的云服务商已经考虑了单点故障，你也没啥好做啦。</p>
<p>如果两者都没有，你应该请我喝杯星冰乐再往下拉。</p>
<p>ps：我最近多是在处理性能优化，数据迁移，安全策略，系统稳定性这类事，简直是伪装成开发的运维orz</p>
<h1>策略</h1>
<p>采用异地备份来应对单点故障导致的数据丢失</p>
<h1>最初的思路</h1>
<p>首先明确我们需要备份哪些数据,关于edX数据，可以参考我此前的<a href="http://wwj718.github.io/edx-data-migrate.html">这篇文章</a></p>
<p>一番深(hu)思(si)熟(luan)虑(xiang)之后，你会发现，我们关心的数据无非是数据库(mongodb/mysql)里存的，以及静态文件(/edx/var/edxapp/staticfiles)</p>
<p>思路很简单，每天定时备份数据库和静态文件，将其同步到远程服务器。只保存最近3，5天的备份文件，逾期的删除</p>
<p>这里需要注意的问题可能有三点：</p>
<ul>
<li>不要影响到用户使用，备份是消耗服务器资源的，会造成服务器压力，写个定时任务，让其在凌晨做</li>
<li>采用增量同步的方式节省带宽</li>
<li>任务完成后，给自己发个邮件，确定成功执行了</li>
</ul>
<p>那么写个shell脚本基本就完事啦，主要可能涉及的工具：</p>
<ul>
<li>mongodump</li>
<li>mysqldump</li>
<li>tar  </li>
<li>scp/rsync</li>
<li>crontab</li>
</ul>
<h1>backup闪亮登场</h1>
<p>就在我shell脚本快写完的时候，在github上发现了这个东西：<a href="https://github.com/backup/backup">backup</a></p>
<p>一言话概括就是</p>
<blockquote>
<p>Easy full stack backup operations on UNIX-like systems</p>
</blockquote>
<p>稍微扫一眼<a href="http://backup.github.io/backup/v4/">Overview</a>,分分钟爱不释手啊。</p>
<p>从文档中不难发现，backup本质上是对以上我们提到的工具做了封装。</p>
<p>能不写shell，我是尽量不写shell的。</p>
<p>先读下<a href="http://backup.github.io/backup/v4/getting-started/">文档</a>吧。</p>
<h2>install backup</h2>
<p>backup是ruby写的，使用gem安装。不得不说ruby的DSL能力真强啊</p>
<p><code>sudo gem install backup</code></p>
<p>哦，顺便说下，我在ruby1.8.7和ruby1.9.3下都没成功，之后在ubuntu12.04上手动编译了ruby2.0.0才安装好backup。也是蛮诡异的，可能是我机器的问题，文档里说ruby1.8.7和ruby1.9.3应该都是没有问题的</p>
<p>安装新版本的ruby建议用rvm，可以参考<a href="http://blog.just4fun.site/language-version.html">Ruby/Nodejs解释器版本依赖笔记</a></p>
<h2>backup demo</h2>
<p>从一个简单的案例开始。  </p>
<p>任务描述：备份我的home目录下的所有文件，同步到远程服务器的<code>~/backup_my_home</code>目录，只保留最近的5个备份</p>
<p>在shell里执行</p>
<div class="highlight"><pre><span></span>backup generate:model --trigger backup_my_home \
  --archives --storages=&#39;scp&#39;  --compressor=&#39;gzip&#39;
</pre></div>


<p>会生成:<code>Generated model file: '/home/USERNAME/Backup/models/backup_my_home.rb'</code></p>
<p>编辑以上文件就行</p>
<div class="highlight"><pre><span></span><span class="c1"># encoding: utf-8</span>
<span class="no">Model</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:backup_my_home</span><span class="p">,</span> <span class="s1">&#39;Description for backup_my_home&#39;</span><span class="p">)</span> <span class="k">do</span>

  <span class="n">archive</span> <span class="ss">:my_archive</span> <span class="k">do</span> <span class="o">|</span><span class="n">archive</span><span class="o">|</span>
    <span class="c1"># Run the `tar` command using `sudo`</span>
    <span class="c1"># archive.use_sudo</span>
    <span class="n">archive</span><span class="o">.</span><span class="n">add</span> <span class="s2">&quot;/home/USERNAME&quot;</span>
  <span class="k">end</span>

  <span class="c1"># SCP (Secure Copy) [Storage]</span>
  <span class="c1">#</span>
  <span class="n">store_with</span> <span class="no">SCP</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
    <span class="n">server</span><span class="o">.</span><span class="n">username</span>   <span class="o">=</span> <span class="s2">&quot;my_username&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">password</span>   <span class="o">=</span> <span class="s2">&quot;my_password&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">ip</span>         <span class="o">=</span> <span class="s2">&quot;123.45.678.90&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">port</span>       <span class="o">=</span> <span class="mi">22</span>
    <span class="n">server</span><span class="o">.</span><span class="n">path</span>       <span class="o">=</span> <span class="s2">&quot;~/backup_my_home/&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">keep</span>       <span class="o">=</span> <span class="mi">5</span>
  <span class="k">end</span>

  <span class="c1"># Gzip [Compressor]</span>
  <span class="n">compress_with</span> <span class="no">Gzip</span>

<span class="k">end</span>
</pre></div>


<p>几乎无需解释对吧:)</p>
<p>开始备份:<code>backup perform -t backup_my_home</code></p>
<h1>开始备份edX</h1>
<h2>静态文件</h2>
<div class="highlight"><pre><span></span>backup generate:model --trigger edx_staticfile_backup \
  --archives --storages=&#39;scp&#39;  --compressor=&#39;gzip&#39;
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># encoding: utf-8</span>
<span class="no">Model</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:edx_staticfile_backup</span><span class="p">,</span> <span class="s1">&#39;Description for edx_staticfile_backup&#39;</span><span class="p">)</span> <span class="k">do</span>


  <span class="c1">#   archive.root &#39;/path/to/archive/root&#39;</span>
  <span class="c1">#</span>
  <span class="n">archive</span> <span class="ss">:my_archive</span> <span class="k">do</span> <span class="o">|</span><span class="n">archive</span><span class="o">|</span>
    <span class="c1"># Run the `tar` command using `sudo`</span>
    <span class="c1"># archive.use_sudo</span>
    <span class="c1">#archive.add &quot;/path/to/a/file.rb&quot;</span>
    <span class="n">archive</span><span class="o">.</span><span class="n">add</span> <span class="s2">&quot;/edx/var/edxapp/staticfiles&quot;</span>
    <span class="c1">#archive.exclude &quot;/path/to/a/excluded_file.rb&quot;</span>
    <span class="c1">#archive.exclude &quot;/path/to/a/excluded_folder&quot;</span>
  <span class="k">end</span>


  <span class="c1">##</span>
  <span class="c1"># SCP (Secure Copy) [Storage]</span>
  <span class="c1">#你需要先去目标服务器建立~/edx_backups/staticfile目录</span>
  <span class="n">store_with</span> <span class="no">SCP</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
    <span class="n">server</span><span class="o">.</span><span class="n">username</span>   <span class="o">=</span> <span class="s2">&quot;my_username&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">password</span>   <span class="o">=</span> <span class="s2">&quot;my_password&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">ip</span>         <span class="o">=</span> <span class="s2">&quot;123.45.678.90&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">port</span>       <span class="o">=</span> <span class="mi">22</span>
    <span class="n">server</span><span class="o">.</span><span class="n">path</span>       <span class="o">=</span> <span class="s2">&quot;~/edx_backups/staticfile&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">keep</span>       <span class="o">=</span> <span class="mi">5</span>

    <span class="c1"># Additional options for the SSH connection.</span>
    <span class="c1"># server.ssh_options = {}</span>
  <span class="k">end</span>

  <span class="c1">##</span>
  <span class="c1"># Gzip [Compressor]</span>
  <span class="c1">#</span>
  <span class="n">compress_with</span> <span class="no">Gzip</span> 

<span class="k">end</span>
</pre></div>


<h2>备份mongo</h2>
<h2>databases</h2>
<div class="highlight"><pre><span></span>&gt;mongo
&gt;show dbs
admin                            
cs_comments_service_development  
edxapp                           
local                            
</pre></div>


<h2>为mongo添加用户</h2>
<div class="highlight"><pre><span></span>&gt;mongo
&gt;use edxapp
&gt;db.addUser(“wwj”, “xxx”)
</pre></div>


<div class="highlight"><pre><span></span>backup generate:model --trigger edx_mongodb_backup \
  --databases=&quot;mongodb&quot; --storages=&#39;scp&#39;  --compressor=&#39;gzip&#39; --notifiers=&#39;mail&#39;
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># encoding: utf-8</span>
<span class="no">Model</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:edx_mongodb_backup</span><span class="p">,</span> <span class="s1">&#39;Description for edx_mongodb_backup&#39;</span><span class="p">)</span> <span class="k">do</span>

  <span class="c1">##</span>
  <span class="c1"># MongoDB [Database]</span>
  <span class="c1">#</span>
  <span class="n">database</span> <span class="no">MongoDB</span> <span class="k">do</span> <span class="o">|</span><span class="n">db</span><span class="o">|</span>
    <span class="n">db</span><span class="o">.</span><span class="n">name</span>              <span class="o">=</span> <span class="s2">&quot;edxapp&quot;</span>
    <span class="c1">#db.name                        = :all</span>
    <span class="n">db</span><span class="o">.</span><span class="n">username</span>           <span class="o">=</span> <span class="s2">&quot;wwj&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">password</span>           <span class="o">=</span> <span class="s2">&quot;xxx&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">host</span>               <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">port</span>               <span class="o">=</span> <span class="mi">27017</span>
    <span class="n">db</span><span class="o">.</span><span class="n">ipv6</span>               <span class="o">=</span> <span class="kp">false</span>
    <span class="c1">#db.only_collections   = [&quot;only&quot;, &quot;these&quot;, &quot;collections&quot;]</span>
    <span class="c1">#db.additional_options = []</span>
    <span class="n">db</span><span class="o">.</span><span class="n">lock</span>               <span class="o">=</span> <span class="kp">false</span>
    <span class="n">db</span><span class="o">.</span><span class="n">oplog</span>              <span class="o">=</span> <span class="kp">false</span>
  <span class="k">end</span>

  <span class="c1">##</span>
  <span class="c1"># SCP (Secure Copy) [Storage]</span>
  <span class="c1">#</span>
  <span class="n">store_with</span> <span class="no">SCP</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
    <span class="n">server</span><span class="o">.</span><span class="n">username</span>   <span class="o">=</span> <span class="s2">&quot;my_username&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">password</span>   <span class="o">=</span> <span class="s2">&quot;my_password&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">ip</span>         <span class="o">=</span> <span class="s2">&quot;123.45.678.90&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">port</span>       <span class="o">=</span> <span class="mi">22</span>
    <span class="n">server</span><span class="o">.</span><span class="n">path</span>       <span class="o">=</span> <span class="s2">&quot;~/edx_backups/mongo&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">keep</span>       <span class="o">=</span> <span class="mi">5</span>

    <span class="c1"># Additional options for the SSH connection.</span>
    <span class="c1"># server.ssh_options = {}</span>
  <span class="k">end</span>

  <span class="c1">##</span>
  <span class="c1"># Gzip [Compressor]</span>
  <span class="c1">#</span>
  <span class="n">compress_with</span> <span class="no">Gzip</span>

  <span class="n">notify_by</span> <span class="no">Mail</span> <span class="k">do</span> <span class="o">|</span><span class="n">mail</span><span class="o">|</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">on_success</span>           <span class="o">=</span> <span class="kp">true</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">on_warning</span>           <span class="o">=</span> <span class="kp">true</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">on_failure</span>           <span class="o">=</span> <span class="kp">true</span>

    <span class="n">mail</span><span class="o">.</span><span class="n">from</span>                 <span class="o">=</span> <span class="s2">&quot;sender@email.com&quot;</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">to</span>                   <span class="o">=</span> <span class="s2">&quot;receiver@email.com&quot;</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">address</span>              <span class="o">=</span> <span class="s2">&quot;smtp.gmail.com&quot;</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">port</span>                 <span class="o">=</span> <span class="mi">587</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">domain</span>               <span class="o">=</span> <span class="s2">&quot;your.host.name&quot;</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">user_name</span>            <span class="o">=</span> <span class="s2">&quot;sender@email.com&quot;</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">password</span>             <span class="o">=</span> <span class="s2">&quot;my_password&quot;</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">authentication</span>       <span class="o">=</span> <span class="s2">&quot;plain&quot;</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">encryption</span>           <span class="o">=</span> <span class="ss">:starttls</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>


<h2>备份mysql</h2>
<h3>databases</h3>
<div class="highlight"><pre><span></span>text
&gt;mysql -u root
&gt;show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| edxapp             |
| mysql              |
| ora                |
| performance_schema |
| test               |
| xqueue             |
+--------------------+
</pre></div>


<div class="highlight"><pre><span></span>backup generate:model --trigger edx_mysql_backup \
  --databases=&quot;mysql&quot; --storages=&#39;scp&#39;  --compressor=&#39;gzip&#39;
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># encoding: utf-8</span>

<span class="no">Model</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:edx_mysql_backup</span><span class="p">,</span> <span class="s1">&#39;Description for edx_mysql_backup&#39;</span><span class="p">)</span> <span class="k">do</span>

  <span class="c1">##</span>
  <span class="c1"># MySQL [Database]</span>
  <span class="c1">#</span>
  <span class="n">database</span> <span class="no">MySQL</span> <span class="k">do</span> <span class="o">|</span><span class="n">db</span><span class="o">|</span>
    <span class="c1"># To dump all databases, set `db.name = :all` (or leave blank)</span>
    <span class="c1">#db.name              = &quot;my_database_name&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">name</span>               <span class="o">=</span> <span class="s2">&quot;edxapp&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">username</span>           <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">password</span>           <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">host</span>               <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">port</span>               <span class="o">=</span> <span class="mi">3306</span>
    <span class="c1">#mysql.sock  位置有变</span>
    <span class="c1">#db.socket             = &quot;/tmp/mysql.sock&quot;</span>
    <span class="c1"># Note: when using `skip_tables` with the `db.name = :all` option,</span>
    <span class="c1"># table names should be prefixed with a database name.</span>
    <span class="c1"># e.g. [&quot;db_name.table_to_skip&quot;, ...]</span>
    <span class="c1">#db.skip_tables        = [&quot;skip&quot;, &quot;these&quot;, &quot;tables&quot;]</span>
    <span class="c1">#db.only_tables        = [&quot;only&quot;, &quot;these&quot;, &quot;tables&quot;]</span>
    <span class="n">db</span><span class="o">.</span><span class="n">additional_options</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;--quick&quot;</span><span class="p">,</span> <span class="s2">&quot;--single-transaction&quot;</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="c1">##</span>
  <span class="c1"># SCP (Secure Copy) [Storage]</span>
  <span class="c1">#</span>
  <span class="n">store_with</span> <span class="no">SCP</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
    <span class="n">server</span><span class="o">.</span><span class="n">username</span>   <span class="o">=</span> <span class="s2">&quot;my_username&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">password</span>   <span class="o">=</span> <span class="s2">&quot;my_password&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">ip</span>         <span class="o">=</span> <span class="s2">&quot;123.45.678.90&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">port</span>       <span class="o">=</span> <span class="mi">22</span>
    <span class="n">server</span><span class="o">.</span><span class="n">path</span>       <span class="o">=</span> <span class="s2">&quot;~/edx_backups/mysql&quot;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">keep</span>       <span class="o">=</span> <span class="mi">5</span>

    <span class="c1"># Additional options for the SSH connection.</span>
    <span class="c1"># server.ssh_options = {}</span>
  <span class="k">end</span>

  <span class="c1">##</span>
  <span class="c1"># Gzip [Compressor]</span>
  <span class="c1">#</span>
  <span class="n">compress_with</span> <span class="no">Gzip</span> 
<span class="k">end</span>
</pre></div>


<h2>开始备份</h2>
<div class="highlight"><pre><span></span>backup perform -t edx_staticfile_backup
backup perform -t edx_mongodb_backup
backup perform -t edx_mysql_backup
</pre></div>


<h2>定时任务</h2>
<p>每天凌晨3:00</p>
<p><code>sudo crontab -e</code>写入</p>
<div class="highlight"><pre><span></span>00 03 * * * /usr/local/bin/backup perform -t edx_staticfile_backup
00 03 * * * /usr/local/bin/backup perform -t edx_mongodb_backup
00 03 * * * /usr/local/bin/backup perform -t edx_mysql_backup
</pre></div>


<h1>后续</h1>
<p>之后我们还是采用<a href="http://backup.github.io/backup/v4/storage-rsync/">rsync</a>的做法吧，不然数据大到一定程度，太浪费带宽了</p>
<p>只要更改store_with就行</p>
<p>注意：数据服务器到备份服务器应当配置好ssh免登陆</p>
<div class="highlight"><pre><span></span>  <span class="n">compress_with</span> <span class="no">Gzip</span> <span class="k">do</span> <span class="o">|</span><span class="n">gzip</span><span class="o">|</span>
    <span class="n">gzip</span><span class="o">.</span><span class="n">rsyncable</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>

  <span class="n">store_with</span> <span class="no">RSync</span> <span class="k">do</span> <span class="o">|</span><span class="n">storage</span><span class="o">|</span>
    <span class="n">time</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
    <span class="n">storage</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="ss">:ssh</span>
    <span class="n">storage</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;123.45.67.89&quot;</span>
    <span class="n">storage</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="mi">22</span>
    <span class="n">storage</span><span class="o">.</span><span class="n">ssh_user</span> <span class="o">=</span> <span class="s2">&quot;wwj&quot;</span>
    <span class="c1">#免密码ssh</span>
    <span class="c1">#每周为一轮，使用的是同名覆盖</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span> <span class="s1">&#39;%A&#39;</span>
    <span class="n">storage</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;~/edx_backups/staticfile/</span><span class="si">#{</span> <span class="n">path</span> <span class="si">}</span><span class="s2">&quot;</span>

  <span class="k">end</span>
</pre></div>


<h1>注意</h1>
<p>~/Backup/log/backup.log 中的时间是ruby的时间，与本地差（晚）8个小时。时区的问题</p>
		</div><!-- /.entry-content -->
<!--
<p style="font-size:16px" class="alert alert-info">此文对我有价值，打赏杯茶喝^_^  <a target="_blank" class="btn btn-primary btn-large" href="https://me.alipay.com/wuwj">支付宝打赏</a> </p>
-->
<hr>
<div class="alert alert-success">版权声明：<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">自由转载-非商用-非衍生-保持署名</a></div>
<hr>
<!-- Duoshuo Comment BEGIN -->
<!--
	<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"wwj718blog"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
    -->
    <!-- Duoshuo Comment END -->
	</article>
</section>
        </div><!--/span-->
      
		<div style="margin-left:70px;" class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
    <!--<a href="/others/startedx.html"><h3>Open edX相关咨询</h3></a>-->
<hr/>
<!--
<h3>我的服务<h3>
    <a href="http://olk8jbdzi.bkt.clouddn.com/index.html"><h4>开源在线表单设计工具</h4></a>
    <a href="#kinto.jsut4fun.site"><h4>kinto server(施工中)</h4></a>
    <a href="#"><h4></h4></a>
-->
<!--<a href="/join-us"><h3>招兵买马(招实习!)<h3></a>-->
</hr>
</hr>

<li style="text-align: center;"><a target="_blank"  href="https://www.e-ducation.cn/?utm_source=zgblog&utm_medium=ads&utm_campaign=marketing_01"><img src="http://os54tv4fc.bkt.clouddn.com/education.png" width="100%" max-width="250px" /> </a></li>
<hr/>

<h4>站内搜索(基于google，你可能看不到)</h4>
<div>
<script>
  (function() {
       var cx = '004056624884628766270:aaifcpik-ua';
	       var gcse = document.createElement('script');
		       gcse.type = 'text/javascript';
			       gcse.async = true;
				       gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					           '//www.google.com/cse/cse.js?cx=' + cx;
							       var s = document.getElementsByTagName('script')[0];
								       s.parentNode.insertBefore(gcse, s);
									     })();
</script>
<gcse:search></gcse:search>
</div>
<hr>
<h4>手机访问：</h4>
<li style="text-align: center;">
<img src="http://os54tv4fc.bkt.clouddn.com/1514204585.png" width="150px" /> 
</li>

    <li><i class="icon-external-link"></i><a href="/aboutme.html">关于我</a></li>
    <li><i class="icon-external-link"></i><a href="https://github.com/wwj718">my github</a></li>
    <li><i class="icon-external-link"></i><a href="#">my gmail：wuwenjie718@gmail.com</a></li>
<hr>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>分类</h4></li>
<li>
<a href="/category/编程.html">
    <i class="icon-folder-open icon-large"></i>编程
</a>
</li>
<li>
<a href="/category/读书.html">
    <i class="icon-folder-open icon-large"></i>读书
</a>
</li>
<li>
<a href="/category/edx.html">
    <i class="icon-folder-open icon-large"></i>edx
</a>
</li>
<li>
<a href="/category/工具.html">
    <i class="icon-folder-open icon-large"></i>工具
</a>
</li>
<li>
<a href="/category/观念.html">
    <i class="icon-folder-open icon-large"></i>观念
</a>
</li>
<li>
<a href="/category/技术.html">
    <i class="icon-folder-open icon-large"></i>技术
</a>
</li>
<li>
<a href="/category/架构.html">
    <i class="icon-folder-open icon-large"></i>架构
</a>
</li>
<li>
<a href="/category/空想.html">
    <i class="icon-folder-open icon-large"></i>空想
</a>
</li>
<li>
<a href="/category/诗词.html">
    <i class="icon-folder-open icon-large"></i>诗词
</a>
</li>
<li>
<a href="/category/数据.html">
    <i class="icon-folder-open icon-large"></i>数据
</a>
</li>
<li>
<a href="/category/算法.html">
    <i class="icon-folder-open icon-large"></i>算法
</a>
</li>
<li>
<a href="/category/随笔.html">
    <i class="icon-folder-open icon-large"></i>随笔
</a>
</li>
<li>
<a href="/category/瓦碎集.html">
    <i class="icon-folder-open icon-large"></i>瓦碎集
</a>
</li>
<li>
<a href="/category/硬件.html">
    <i class="icon-folder-open icon-large"></i>硬件
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>
<hr>

<a target="_blank" href="http://wwj718.github.io/feeds/all.rss.xml">订阅feed</a>

</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer id="footer">
        <address id="about">
            被误解是表达者的宿命<hr>
              powered by Pelican 
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F18db4b662c04fbd6cc2851d246c51b3f' type='text/javascript'%3E%3C/script%3E"));
</script>        </address><!-- /#about -->
      </footer>

    </div><!--/.fluid-container-->
<a href="https://github.com/wwj718"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/567c3a48d796e2fc06ea80409cc9dd82bf714434/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png"></a>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://libs.baidu.com/jquery/1.8.2/jquery.min.js"></script>
    <script src="/theme/js/bootstrap-transition.js"></script>
    <script src="/theme/js/bootstrap-dropdown.js"></script>
    <script src="/theme/js/bootstrap-collapse.js"></script>
	
	<!--<script src="/theme/js/autosidebar.js"></script>-->
  </body>
</html>
