<!--

 -----------------
< 终于等到你 >
 -----------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
----------------------------------

我正在构建一个基于网络协作的虚拟团队，
喜欢你这种没事喜欢翻源码的人
如果你恰好也热爱技术、喜欢折腾，来啊，互相伤害，一起捣鼓好玩的东西吧
联系我咯: wuwenjie718@gmail.com
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>基于tracking logs的数据分析</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="writing for time">
    <meta name="author" content="wwj">

    <!-- Le styles -->
    <link href="http://cdn.bootcss.com/twitter-bootstrap/2.0.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="http://7kttuq.com1.z0.glb.clouddn.com/just4fun.png?imageView2/2/w/50" type="image/x-icon">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
	
	.tag-1 {
		font-size: 13pt;
	}
	
	.tag-2 {
		font-size: 10pt;
	}
	
	.tag-2 {
		font-size: 8pt;
	}

	.tag-4 {
		font-size: 6pt;
	}

  #footer img{
    visibility: hidden;
  }
	
    </style>
    <link href="http://cdn.bootcss.com/twitter-bootstrap/2.0.4/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="http://cdn.bootcss.com/font-awesome/3.0.0/css/font-awesome.min.css" rel="stylesheet">
	
    <link href="/theme/css/pygments.css" rel="stylesheet">
	<link href="/theme/css/mystyle.css" rel="stylesheet">
    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->


  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/index.html">writing for time </a>
          <div class="nav-collapse">
            <ul class="nav">
			  <li class="divider-vertical"></li>
                  <li >
                    <a href="/category/编程.html">
						<i class="icon-folder-open icon-large"></i>编程
					</a>
                  </li>
                  <li >
                    <a href="/category/读书.html">
						<i class="icon-folder-open icon-large"></i>读书
					</a>
                  </li>
                  <li class="active">
                    <a href="/category/edx.html">
						<i class="icon-folder-open icon-large"></i>edx
					</a>
                  </li>
                  <li >
                    <a href="/category/工具.html">
						<i class="icon-folder-open icon-large"></i>工具
					</a>
                  </li>
                  <li >
                    <a href="/category/观念.html">
						<i class="icon-folder-open icon-large"></i>观念
					</a>
                  </li>
                  <li >
                    <a href="/category/技术.html">
						<i class="icon-folder-open icon-large"></i>技术
					</a>
                  </li>
                  <li >
                    <a href="/category/架构.html">
						<i class="icon-folder-open icon-large"></i>架构
					</a>
                  </li>
                  <li >
                    <a href="/category/空想.html">
						<i class="icon-folder-open icon-large"></i>空想
					</a>
                  </li>
                  <li >
                    <a href="/category/诗词.html">
						<i class="icon-folder-open icon-large"></i>诗词
					</a>
                  </li>
                  <li >
                    <a href="/category/数据.html">
						<i class="icon-folder-open icon-large"></i>数据
					</a>
                  </li>
                  <li >
                    <a href="/category/算法.html">
						<i class="icon-folder-open icon-large"></i>算法
					</a>
                  </li>
                  <li >
                    <a href="/category/随笔.html">
						<i class="icon-folder-open icon-large"></i>随笔
					</a>
                  </li>
                  <li >
                    <a href="/category/瓦碎集.html">
						<i class="icon-folder-open icon-large"></i>瓦碎集
					</a>
                  </li>
                  <li >
                    <a href="/category/硬件.html">
						<i class="icon-folder-open icon-large"></i>硬件
					</a>
                  </li>
			  
			  <ul class="nav pull-right">
				<li><a href="/archives.html"><i class="icon-th-list"></i>Archives</a></li>
			  </ul>
			  
            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>





    <div class="container-fluid">
      <div class="row">

        <div class="span8 offset1" id="content">
            <!--<div class="alert alert-success" style="font-size:18px;">>  你那里天气好吗，有什么新闻可以当做笑话</div>-->
<section id="content">    
	<article>
		<header>
			<h1>
				<a href=""
					rel="bookmark" 
					title="Permalink to 基于tracking logs的数据分析">
					基于tracking logs的数据分析 
				</a>
			</h1> 
		</header>
		<div class="entry-content">
		<div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2015-05-06T00:00:00+00:00">
	<i class="icon-calendar"></i>三 06 五月 2015
</abbr>
<span class="label">By</span>
<a href="/author/wuwenjie.html"><i class="icon-user"></i>wuwenjie</a>
<span class="label">Category</span>
<a href="/category/edx.html"><i class="icon-folder-open"></i>edx</a>. 

	
<span class="label">Tags</span> 
	<a href="/tag/edx.html"><i class="icon-tag"></i>edx</a>
</footer><!-- /.post-info -->		</div>
		<p>最近打算写edX数据相关的文章，这一块庞大繁杂，资料分散，近来在这块花了大量时间，收集了大量资料源码以及阅读了基本所有可读的文档，决定将其整理出来，目的有二：</p>
<ul>
<li>整理一下自己的资料，不至于让数据成为坟墓，为下次深入留下线索，不至于重头开始</li>
<li>也希望能帮助到后来的人，不会像我此前一般毫无头绪，备受煎熬</li>
</ul>
<p>还没想好怎么组织这些文档资料和心得，先从一个具体的需求入手好了。</p>
<h1>任务描述</h1>
<p>统计每个学生在每门课上的花费的学习时间</p>
<h1>Tracking Logs</h1>
<p>为了完成以上任务，首先想到了<a href="http://edx.readthedocs.org/projects/devdata/en/latest/internal_data_formats/tracking_logs.html">Tracking Logs</a></p>
<p>这是个什么东西呢，文档中是这样介绍的</p>
<blockquote>
<p>Events are emitted by the server, the browser, or the mobile device to capture information about interactions with the courseware and the Instructor Dashboard in the LMS, and are stored in JSON documents. In the data package, event data is delivered in a log file.</p>
</blockquote>
<p>就是说这是个日志文件，内容为json格式，记录着用户与平台交互时发生的特定事件，事件可能由浏览器/后台系统或是手机端触发。</p>
<p>那么都有哪些行为会被记录呢？</p>
<p>这是所有的<a href="http://edx.readthedocs.org/projects/devdata/en/latest/internal_data_formats/event_list.html">事件列表</a></p>
<p>其中比较有趣的是学生观看视频的许多行为都被记录，比如</p>
<ul>
<li>edx.video.loaded</li>
<li>edx.video.paused</li>
<li>edx.video.played</li>
<li>edx.video.position.changed</li>
<li>edx.video.stopped</li>
<li>edx.video.transcript.hidden</li>
<li>edx.video.transcript.shown</li>
<li>and so on...</li>
</ul>
<p>从这里可能挖掘出大量对改良教学本身有所助益的数据，好比学生反复回看某个视频段，那么团队可能发现这里也许讲解的不够清晰，更多有趣的行为分析，大家可以发挥想象，我觉得这也是edX最有趣的地方之一</p>
<p>最后给一个日志例子，我们就结束对Tracking Logs的介绍</p>
<pre>
{
    "username": "AAAAAAAAAA",
    "event_source": "server",
    "name": "edx.course.enrollment.deactivated",
    "referer": "http:\/\/localhost:8001\/container\/i4x:\/\/edX\/DemoX\/vertical\/69dedd38233a46fc89e4d7b5e8da1bf4?action=new",
    "accept_language": "en-US,en;q=0.8",
    "time": "2014-01-26T00:28:28.388782+00:00",
    "agent": "Mozilla\/5.0 (Windows NT 6.1; WOW64; Trident\/7.0; rv:11.0) like Gecko",
    "page": null
    "host": "courses.edx.org",
    "session": "a14j3ifhskngw0gfgn230g",
    "context": {
      "user_id": 9999999,
      "org_id": "edX",
      "course_id": "edX\/DemoX\/Demo_Course",
      "path": "\/change_enrollment",
    },
    "ip": "NN.NN.NNN.NNN",
    "event": {
      "course_id": "edX\/DemoX\/Demo_Course",
      "user_id": 9999999,
      "mode": "honor"
    },
    "event_type": "edx.course.enrollment.deactivated"
  }
</pre>

<p>更多的信息大家可自行去看日志文件,在<code>/edx/var/log/tracking</code></p>
<p>对tracking log结构有兴趣的同学可以查看edx admin中的<code>/admin/track/trackinglog/add/</code></p>
<h1>思路</h1>
<p>既然<a href="http://edx.readthedocs.org/projects/devdata/en/latest/internal_data_formats/tracking_logs.html">tracking_logs</a>跟踪记录了学生的所有行为数据，那么我们就从这里入手。看看能否从中挖掘出每个学生在每一门课所花的时间。<br />
那么接下去的工作自然就变成对日志文本的解读，了解每个数据项的含义，这部分的文档也都在<a href="http://edx.readthedocs.org/projects/devdata/en/latest/internal_data_formats/tracking_logs.html#video-interaction-events">这里</a>。此外我们知道，了解用户是否在线，sessions往往是关键。 <br />
而后设计计算用户在线时长的算法，再往后使用splunk或是hadoop来计算。<br />
此后我去edx社区发了个求助帖，看看社区的建议，大家回复也基本是从sessions入手，@Alexander的回复让我很是开心，他说</p>
<blockquote>
<p>The million dollar question</p>
</blockquote>
<p>哈哈，我也觉得这是件很有价值的数据挖掘工作，此外@Kristin女神提到</p>
<blockquote>
<p>and as far as I know there is no hearbeat event...</p>
</blockquote>
<p>她还提到些session的细节，诸如粒度只到半小时（没有心跳检测），她似乎对这块很了解，还提出记录鼠标移动点击页面之类的事件，以此作为心跳检测，这是个很有趣的思路，这种思路也可以用来防作弊用。有兴趣的同学可以进一步挖掘，或是自定义事件来观察用户行为。</p>
<h1>just do it</h1>
<p>而后我就开始阅读理解这些数据，和思考算法。<br />
这个过程中，我也在github上搜索相关的项目，发现McGill大学也在做了<a href="https://github.com/McGillX/edx_data_research">这方面的工作</a>，McGill是edX用户，这是加拿大的一所顶级名校，被誉为“加拿大的哈佛”。<br />
随后翻了他们的源码库，发现他们在数据分析这块，可能是除了edx核心源码库之外走的最远的了，而且更棒的是，他们的分析多是以脚本形式，耦合度很低。读了几个脚本，发现和我此前的思路基本一致，很容易理解，那么我们就跟着McGill做好啦！！<br />
所有功劳归McGill！</p>
<h1>步骤细节</h1>
<p>建议数据分析在单独的机器上做，避免影响服务器性能</p>
<h2>导出tracking logs</h2>
<p>tracking Logs位于<code>/edx/var/log/tracking</code><br />
使用rsync同步这些文件，好处是rsync效率很高，每次只同步新增的部分。</p>
<h2>导入到mongo</h2>
<p>使用以下脚本：<a href="https://raw.githubusercontent.com/wwj718/edx_data_research/master/parsing/tracking_logs/load_tracking_logs_to_mongo.py">load_tracking_logs_to_mongo</a>  将log加载到mongo里</p>
<p><code>python load_tracking_logs_to_mongo.py db_name collection_name &lt;path_to_directory&gt;</code></p>
<p>当然也可以选择性地处理日志文件</p>
<p><code>python load_tracking_logs_to_mongo.py db_name collection_name &lt;path_to_file_1&gt; &lt;path_to_file_2&gt;</code></p>
<p>此外还可以选择性地加载课程相关的日志，并且指定时间段。可参考<a href="https://github.com/wwj718/edx_data_research/tree/master/parsing/tracking_logs">这里</a></p>
<p>以上是我从Mcgill大学fork的仓库，他们的<a href="https://github.com/wwj718/edx_data_research/tree/master/reporting_scripts">reporting_scripts</a>里有一个小bug,我修复了，顺便提了个pull request,好像上游仓库还没处理，所以大家可以先用我的</p>
<h2>查看课程</h2>
<p>现在可以在mongo里查下都有哪些课程<br />
<code>db.tracking.distinct('context.course_id')</code><br />
通过以上command可以得到log里的所有course_id</p>
<h2>归并文档</h2>
<p><code>db.tracking.aggregate([{$match :{ 'context.course_id' : 'your_course_id' }}, {$out : 'your_course_id'}])</code><br />
以上指令根据你指定的course_id，归并文档成为一个collection。</p>
<h2>统计用户在线时间</h2>
<p>下载<a href="https://raw.githubusercontent.com/wwj718/edx_data_research/master/reporting_scripts/session_info.py">session_info</a>脚本，修改里边的参数（DATABASE_NAME和collection_name）<br />
执行<code>python session_info.py</code>，就可以得到所有用户这门课中每个session期间的在线时长，结果以一份csv报表(session_info.csv)呈现，
报表内容为<code>['Username', 'Session ID', 'Number of Events', 'Start Time', 'End Time', 'Time Spent']</code>,</p>
<p>如果需要统计同个用户在该课程下的花费的所有时长，只需要做个累加就行。使用pandas可能很方便~</p>
<h1>后记</h1>
<p>以上只是一个可行方案，并没考虑效率，今天我翻了下我在5月4号发的帖子，@Alexander回复说</p>
<blockquote>
<p>we created that script to get an initial idea but found it a very poor proxy and not helpful.</p>
</blockquote>
<p>我这才得知他便是McGill大学<a href="https://github.com/McGillX/edx_data_research">edx_data_research</a>项目的开发者。的确这只是个零时的不够优雅的解决方案。</p>
<p>如果要生产环境使用，必须考虑效率问题，可能以下几个内容会被考虑到：</p>
<ul>
<li>使用单独的计算资源，不要影响主服务器</li>
<li>定时计划任务(cron)</li>
<li>考虑并发</li>
<li>使用hadoop或者spark</li>
<li>将计算结果存回数据库</li>
<li>新建一个页面向课程团队展示分析结果</li>
</ul>
		</div><!-- /.entry-content -->
<!--
<p style="font-size:16px" class="alert alert-info">此文对我有价值，打赏杯茶喝^_^  <a target="_blank" class="btn btn-primary btn-large" href="https://me.alipay.com/wuwj">支付宝打赏</a> </p>
-->
<hr>
<div class="alert alert-success">版权声明：<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">自由转载-非商用-非衍生-保持署名</a></div>
<hr>
<!-- Duoshuo Comment BEGIN -->
<!--
	<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"wwj718blog"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
    -->
    <!-- Duoshuo Comment END -->
	</article>
</section>
        </div><!--/span-->
      
		<div style="margin-left:70px;" class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
    <!--<a href="/others/startedx.html"><h3>Open edX相关咨询</h3></a>-->
<hr/>
<!--
<h3>我的服务<h3>
    <a href="http://olk8jbdzi.bkt.clouddn.com/index.html"><h4>开源在线表单设计工具</h4></a>
    <a href="#kinto.jsut4fun.site"><h4>kinto server(施工中)</h4></a>
    <a href="#"><h4></h4></a>
-->
<!--<a href="/join-us"><h3>招兵买马(招实习!)<h3></a>-->
</hr>
</hr>

<li style="text-align: center;"><a  href="https://www.e-ducation.cn/?utm_source=zgblog&utm_medium=ads&utm_campaign=marketing_01"><img src="http://os54tv4fc.bkt.clouddn.com/education.png" width="150px" /> </a></li>
<hr/>

<h4>站内搜索(基于google，你可能看不到)</h4>
<div>
<script>
  (function() {
       var cx = '004056624884628766270:aaifcpik-ua';
	       var gcse = document.createElement('script');
		       gcse.type = 'text/javascript';
			       gcse.async = true;
				       gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					           '//www.google.com/cse/cse.js?cx=' + cx;
							       var s = document.getElementsByTagName('script')[0];
								       s.parentNode.insertBefore(gcse, s);
									     })();
</script>
<gcse:search></gcse:search>
</div>
<hr>
<h4>手机访问：</h4>
<li style="text-align: center;">
<img src="http://os54tv4fc.bkt.clouddn.com/1514204585.png" width="150px" /> 
</li>

    <li><i class="icon-external-link"></i><a href="/aboutme.html">关于我</a></li>
    <li><i class="icon-external-link"></i><a href="https://github.com/wwj718">my github</a></li>
    <li><i class="icon-external-link"></i><a href="#">my gmail：wuwenjie718@gmail.com</a></li>
<hr>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>分类</h4></li>
<li>
<a href="/category/编程.html">
    <i class="icon-folder-open icon-large"></i>编程
</a>
</li>
<li>
<a href="/category/读书.html">
    <i class="icon-folder-open icon-large"></i>读书
</a>
</li>
<li>
<a href="/category/edx.html">
    <i class="icon-folder-open icon-large"></i>edx
</a>
</li>
<li>
<a href="/category/工具.html">
    <i class="icon-folder-open icon-large"></i>工具
</a>
</li>
<li>
<a href="/category/观念.html">
    <i class="icon-folder-open icon-large"></i>观念
</a>
</li>
<li>
<a href="/category/技术.html">
    <i class="icon-folder-open icon-large"></i>技术
</a>
</li>
<li>
<a href="/category/架构.html">
    <i class="icon-folder-open icon-large"></i>架构
</a>
</li>
<li>
<a href="/category/空想.html">
    <i class="icon-folder-open icon-large"></i>空想
</a>
</li>
<li>
<a href="/category/诗词.html">
    <i class="icon-folder-open icon-large"></i>诗词
</a>
</li>
<li>
<a href="/category/数据.html">
    <i class="icon-folder-open icon-large"></i>数据
</a>
</li>
<li>
<a href="/category/算法.html">
    <i class="icon-folder-open icon-large"></i>算法
</a>
</li>
<li>
<a href="/category/随笔.html">
    <i class="icon-folder-open icon-large"></i>随笔
</a>
</li>
<li>
<a href="/category/瓦碎集.html">
    <i class="icon-folder-open icon-large"></i>瓦碎集
</a>
</li>
<li>
<a href="/category/硬件.html">
    <i class="icon-folder-open icon-large"></i>硬件
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>
<hr>

<a target="_blank" href="http://wwj718.github.io/feeds/all.rss.xml">订阅feed</a>

</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer id="footer">
        <address id="about">
            被误解是表达者的宿命<hr>
              powered by Pelican 
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F18db4b662c04fbd6cc2851d246c51b3f' type='text/javascript'%3E%3C/script%3E"));
</script>        </address><!-- /#about -->
      </footer>

    </div><!--/.fluid-container-->
<a href="https://github.com/wwj718"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/567c3a48d796e2fc06ea80409cc9dd82bf714434/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png"></a>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://libs.baidu.com/jquery/1.8.2/jquery.min.js"></script>
    <script src="/theme/js/bootstrap-transition.js"></script>
    <script src="/theme/js/bootstrap-dropdown.js"></script>
    <script src="/theme/js/bootstrap-collapse.js"></script>
	
	<!--<script src="/theme/js/autosidebar.js"></script>-->
  </body>
</html>
