<!--

 -----------------
< 终于等到你 >
 -----------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
----------------------------------

我正在构建一个基于网络协作的虚拟团队，
喜欢你这种没事喜欢翻源码的人
如果你恰好也热爱技术、喜欢折腾，来啊，互相伤害，一起捣鼓好玩的东西吧
联系我咯: wuwenjie718@gmail.com
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>分析scratch3.0与micro:bit的通信</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="writing for time">
    <meta name="author" content="wwj">

    <!-- Le styles -->
    <link href="//cdn.bootcss.com/twitter-bootstrap/2.0.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="//7kttuq.com1.z0.glb.clouddn.com/just4fun.png?imageView2/2/w/50" type="image/x-icon">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
	
	.tag-1 {
		font-size: 13pt;
	}
	
	.tag-2 {
		font-size: 10pt;
	}
	
	.tag-2 {
		font-size: 8pt;
	}

	.tag-4 {
		font-size: 6pt;
	}

  #footer img{
    visibility: hidden;
  }
	
    </style>
    <link href="//cdn.bootcss.com/twitter-bootstrap/2.0.4/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="//cdn.bootcss.com/font-awesome/3.0.0/css/font-awesome.min.css" rel="stylesheet">
	
    <link href="/theme/css/pygments.css" rel="stylesheet">
	<link href="/theme/css/mystyle.css" rel="stylesheet">
    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="shortcut icon" href="http://os54tv4fc.bkt.clouddn.com/favicon.ico">
    <!-- Le fav and touch icons -->


  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/index.html">writing for time </a>
          <div class="nav-collapse">
            <ul class="nav">
			  <li class="divider-vertical"></li>
                  <li >
                    <a href="/category/编程.html">
						<i class="icon-folder-open icon-large"></i>编程
					</a>
                  </li>
                  <li >
                    <a href="/category/codelab.html">
						<i class="icon-folder-open icon-large"></i>codelab
					</a>
                  </li>
                  <li >
                    <a href="/category/读书.html">
						<i class="icon-folder-open icon-large"></i>读书
					</a>
                  </li>
                  <li >
                    <a href="/category/edx.html">
						<i class="icon-folder-open icon-large"></i>edx
					</a>
                  </li>
                  <li >
                    <a href="/category/工具.html">
						<i class="icon-folder-open icon-large"></i>工具
					</a>
                  </li>
                  <li >
                    <a href="/category/公众号.html">
						<i class="icon-folder-open icon-large"></i>公众号
					</a>
                  </li>
                  <li >
                    <a href="/category/观念.html">
						<i class="icon-folder-open icon-large"></i>观念
					</a>
                  </li>
                  <li >
                    <a href="/category/技术.html">
						<i class="icon-folder-open icon-large"></i>技术
					</a>
                  </li>
                  <li >
                    <a href="/category/架构.html">
						<i class="icon-folder-open icon-large"></i>架构
					</a>
                  </li>
                  <li >
                    <a href="/category/空想.html">
						<i class="icon-folder-open icon-large"></i>空想
					</a>
                  </li>
                  <li class="active">
                    <a href="/category/少儿编程.html">
						<i class="icon-folder-open icon-large"></i>少儿编程
					</a>
                  </li>
                  <li >
                    <a href="/category/诗词.html">
						<i class="icon-folder-open icon-large"></i>诗词
					</a>
                  </li>
                  <li >
                    <a href="/category/数据.html">
						<i class="icon-folder-open icon-large"></i>数据
					</a>
                  </li>
                  <li >
                    <a href="/category/算法.html">
						<i class="icon-folder-open icon-large"></i>算法
					</a>
                  </li>
                  <li >
                    <a href="/category/随笔.html">
						<i class="icon-folder-open icon-large"></i>随笔
					</a>
                  </li>
                  <li >
                    <a href="/category/瓦碎集.html">
						<i class="icon-folder-open icon-large"></i>瓦碎集
					</a>
                  </li>
                  <li >
                    <a href="/category/硬件.html">
						<i class="icon-folder-open icon-large"></i>硬件
					</a>
                  </li>
			  
			  <ul class="nav pull-right">
				<li><a href="/archives.html"><i class="icon-th-list"></i>Archives</a></li>
			  </ul>
			  
            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>





    <div class="container-fluid">
      <div class="row">

        <div class="span8 offset1" id="content">
            <!--<div class="alert alert-success" style="font-size:18px;">>  你那里天气好吗，有什么新闻可以当做笑话</div>-->
<section id="content">    
	<article>
		<header>
			<h1>
				<a href=""
					rel="bookmark" 
					title="Permalink to 分析scratch3.0与micro:bit的通信">
					分析scratch3.0与micro:bit的通信 
				</a>
			</h1> 
		</header>
		<div class="entry-content">
		<div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2018-08-01T00:00:00+00:00">
	<i class="icon-calendar"></i>三 01 八月 2018
</abbr>
<span class="label">By</span>
<a href="/author/wuwenjie.html"><i class="icon-user"></i>wuwenjie</a>
<span class="label">Category</span>
<a href="/category/shao-er-bian-cheng.html"><i class="icon-folder-open"></i>少儿编程</a>. 

	
<span class="label">Tags</span> 
	<a href="/tag/scratch.html"><i class="icon-tag"></i>scratch</a>
</footer><!-- /.post-info -->		</div>
		<p><img src="http://wwj-fig-bed.just4fun.site/scratch_microbit_0f5be12b.png" width=600 /> </p>
<p>Scratch在七月底举行了一个大会:<a href="https://scratch.mit.edu/conference">conference</a>, 大会上, scratch团队向大家介绍了即将推出的Scratch 3.0, 赶在会议开始之前，scratch团队完成了对micro:bit的官方支持，项目页连同使用说明也正式上线:<a href="[scratch.mit.edu/microbit](https://scratch.mit.edu/microbit)">microbit</a></p>
<p>scratch与micro:bit作为全球最有名的两个少儿编程项目（分别是软件和硬件），能够结合在一起，太振奋人心。之前社区里大家就围绕这块在做许多探索，如：</p>
<ul>
<li>基于<a href="https://github.com/WebBluetoothCG/web-bluetooth/blob/gh-pages/implementation-status.md#chrome">web bluetooth</a>的<a href="https://blog.just4fun.site/scratch3-microbit.html">scratch3.0 + micro:bit</a></li>
<li><a href="https://scratch3-adapter-docs.just4fun.site/user_guide/usage/">scratch3-adapter</a></li>
</ul>
<h1 id="_1">尝鲜</h1>
<p>只要你手边有micro:bit就可以开始体验了.</p>
<p>按照<a href="https://scratch.mit.edu/microbit">使用说明</a>，将micro:bit接入scratch3.0毫无障碍:</p>
<p><img src="http://wwj-fig-bed.just4fun.site/scratch_microbit_0f5be12b.png" width=600 /> </p>
<p>完成连接后就可以开始你的创作了，<a href="https://scratch.mit.edu/microbit">使用说明</a>页面里给出了几个例子,大家可以从这儿入手</p>
<p><img src="http://wwj-fig-bed.just4fun.site/scratch_heart_a30a52b1.png" width=600 /> </p>
<h1 id="_2">原理</h1>
<p>体验完scratch与micro:bit的互动，我们来分析一下官方是如何做到的。</p>
<p>回顾<a href="https://scratch.mit.edu/microbit">使用说明</a>和体验过程，容易猜到Scratch Link起代理的作用，Scratch Link在内部跑了一个websocket服务，允许网页与其交互，同时在启动时扫描周围的BLE设备</p>
<p>思路和<a href="https://scratch3-adapter-docs.just4fun.site/">scratch3-adapter</a>几乎完全一致</p>
<p>Scratch Link与<a href="https://scratch3-adapter-docs.just4fun.site/">scratch3-adapter</a>的不同之处有：</p>
<ul>
<li>Scratch Link目前不支持扩展，似乎也没计划开源，原因可能我猜测是Scratch Link将支持乐高机器人，而乐高机器人是闭源商业项目。<a href="https://scratch3-adapter-docs.just4fun.site/">scratch3-adapter</a>允许你自行扩展</li>
<li>Scratch Link在使用上更为简易</li>
<li><a href="https://scratch3-adapter-docs.just4fun.site/">scratch3-adapter</a>兼容更多的系统环境以及支持所有的开源硬件</li>
</ul>
<p>Scratch Link在易用性上做得非常好，这也<a href="https://scratch3-adapter-docs.just4fun.site/">scratch3-adapter</a>准备向它学习的地方。<a href="https://scratch3-adapter-docs.just4fun.site/">scratch3-adapter</a>的目标之一是完全兼容Scratch Link的功能</p>
<p>这篇文章就来分析一下官方在这块的巧思。以便于我们可以将其用到其他地方。</p>
<h1 id="_3">分析</h1>
<h3 id="_4">推断</h3>
<p>从scratch的<a href="https://github.com/LLK/scratch-vm/blob/develop/src/extensions/scratch3_microbit/index.js">micro:bit extension</a>来看，Scratch Link仅仅只是一个代理，scratch与micro:bit的交互逻辑都在<a href="https://github.com/LLK/scratch-vm/blob/develop/src/extensions/scratch3_microbit/index.js">micro:bit extension</a>中。</p>
<p>所以我们暂时不必使用<a href="https://www.wireshark.org/download.html">wireshark</a>抓包分析，而仅仅通过阅读<a href="https://github.com/LLK/scratch-vm/blob/develop/src/extensions/scratch3_microbit/index.js">micro:bit extension</a>，应该就能知道通信的细节，之后我们使用gatttool来验证。</p>
<p>如果你对BLE/GATT相关的概念不熟悉，可以看看我之前的文章:<a href="https://blog.just4fun.site/ble-notes.html">BLE学习笔记</a></p>
<!--adapter与硬件直接是不是只是代理  建立连接，转发消息-->

<h3 id="bleuuid"><a href="https://github.com/LLK/scratch-vm/blob/develop/src/extensions/scratch3_microbit/index.js#L35">BLEUUID</a></h3>
<p>从<a href="https://github.com/LLK/scratch-vm/blob/develop/src/extensions/scratch3_microbit/index.js">micro:bit extension源码</a>里我们可以找到micro:bit里跑的服务和属性的uuid，也正是这个证据，让我们猜测Scratch Link只是个透明代理</p>
<div class="highlight"><pre><span></span>const BLEUUID = {
    service: 0xf005,
    rxChar: &#39;5261da01-fa7e-42ab-850b-7c80220097cc&#39;,
    txChar: &#39;5261da02-fa7e-42ab-850b-7c80220097cc&#39;
};
</pre></div>


<p>对比lancaster大学的<a href="https://lancaster-university.github.io/microbit-docs/resources/bluetooth/bluetooth_profile.html">Bluetooth Developer Studio Level 3 Profile Report</a>,可知scratch自己重写了很多东西，而没有使用现成的UART service，这点我颇为不解。</p>
<h3 id="_5">展开追踪</h3>
<p>我们接着来跟踪一下<code>A button pressed？</code>这个积木涉及的通信过程，从一个具体例子里突破。经过这个例子，我们对整个通信流程应该会有一个整体的了解，之后我们再对不同类型的积木逐类探索。</p>
<p>GATT 通信的双方是 C/S 关系, 为了知道micr:bit上A按钮的状态，一般采用两种方式：</p>
<ul>
<li>其一是利用GATT的通知机制，每当按钮状态变化时，通知给电脑(Scratch Link会把消息代理给scratch)</li>
<li>其二是每当<code>A button pressed？</code>积木被触发时，主动去read相应的属性值。</li>
</ul>
<p><a href="https://llk.github.io/scratch-gui/microbit">scratch-gui/microbit</a>应该是用这两种方式中的一种</p>
<p>但<a href="https://github.com/LLK/scratch-vm/blob/develop/src/extensions/scratch3_microbit/index.js">micro:bit extension</a>有些特殊，它构建了UART service，之后的的数据都走UART service，逻辑上这更像经典的串口通信。只是实现在GATT上而已。</p>
<p>从源码中可以看到buttonA是否按下取决于 <a href="https://github.com/LLK/scratch-vm/blob/develop/src/extensions/scratch3_microbit/index.js#L491">this._device.buttonA</a></p>
<p>而<a href="https://github.com/LLK/scratch-vm/blob/develop/src/extensions/scratch3_microbit/index.js#L323">this._device = new MicroBit(this.runtime, Scratch3MicroBitBlocks.EXTENSION_ID);</a></p>
<p>顺藤摸瓜，可以跟踪到</p>
<div class="highlight"><pre><span></span>    <span class="cm">/**</span>
<span class="cm">     * Process the sensor data from the incoming BLE characteristic.</span>
<span class="cm">     * @param {object} base64 - the incoming BLE data.</span>
<span class="cm">     * @private</span>
<span class="cm">     */</span>
    <span class="nx">_processSessionData</span> <span class="p">(</span><span class="nx">base64</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// parse data</span>
        <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">Base64Util</span><span class="p">.</span><span class="nx">base64ToUint8Array</span><span class="p">(</span><span class="nx">base64</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">tiltX</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">tiltX</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">tiltX</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">tiltY</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">tiltY</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">tiltY</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">buttonA</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">buttonB</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">touchPins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">touchPins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">touchPins</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">gestureState</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>

        <span class="c1">// cancel disconnect timeout and start a new one</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">clearInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_timeoutID</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_timeoutID</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">disconnectSession</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">BLETimeout</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>


<p>注释里说得很清楚:</p>
<div class="highlight"><pre><span></span>     * Process the sensor data from the incoming BLE characteristic.
     * @param {object} base64 - the incoming BLE data.
</pre></div>


<p>从逻辑和语义上，可以看出<code>_processSessionData</code>是个回调函数，micro:bit会通过串口源源不断把它自身的状态数据(sensor data)不断发给<code>_processSessionData</code>,  如此一来，scratch就能得知microbit的A按钮是否按下，为了验证我们的想法，我们得继续跟踪:<code>this._ble.read(BLEUUID.service, BLEUUID.rxChar, true, callback);</code></p>
<div class="highlight"><pre><span></span>    <span class="cm">/**</span>
<span class="cm">     * Starts reading data from device after BLE has connected to it.</span>
<span class="cm">     */</span>
    <span class="nx">_onSessionConnect</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">callback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_processSessionData</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_ble</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">BLEUUID</span><span class="p">.</span><span class="nx">service</span><span class="p">,</span> <span class="nx">BLEUUID</span><span class="p">.</span><span class="nx">rxChar</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_timeoutID</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">disconnectSession</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">BLETimeout</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>


<p>_ble看去是个通用的抽象io(BLESession)，<code>_ble.read</code>在语义上类似UART read，只是实现上是基于GATT的，如果你熟悉GATT，至此应该基本都猜到了。当然我们会继续剖析。</p>
<div class="highlight"><pre><span></span>    /**
     * Called by the runtime when user wants to scan for a device.
     */
    startDeviceScan () {
        this._ble = new BLESession(this._runtime, {
            filters: [
                {services: [BLEUUID.service]}
            ]
        }, this._onSessionConnect.bind(this));
    }
</pre></div>


<p>跟踪到BLESession类里， <code>BLESession</code>继承自<code>JSONRPCWebSocket</code>, 这里提示我们scratch与Scratch Link是如何通信的，基于WebSocket，同时使用远程调用的概念, RPC使用起来要比流简单很多。这是scratch官方很聪明的举措之一，我们在文末的tips里还将列出官方其他的聪明做法</p>
<p>如果你不打算自己实现类似Scratch Link的东西，JSONRPCWebSocket不必太关注。我实现了类似Scratch Link的<a href="https://scratch3-adapter-docs.just4fun.site/">scratch3-adapter</a>，但使用的是消息通信，策略上和scratch团队不大一样。这块我们先不细说</p>
<p>回到BLESession上边，我们前头关注<code>_ble.read</code>,在此将看到它的实现:</p>
<div class="highlight"><pre><span></span>    <span class="nx">read</span> <span class="p">(</span><span class="nx">serviceId</span><span class="p">,</span> <span class="nx">characteristicId</span><span class="p">,</span> <span class="nx">optStartNotifications</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">onCharacteristicChanged</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">serviceId</span><span class="p">,</span>
            <span class="nx">characteristicId</span>
        <span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">optStartNotifications</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">params</span><span class="p">.</span><span class="nx">startNotifications</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_characteristicDidChangeCallback</span> <span class="o">=</span> <span class="nx">onCharacteristicChanged</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">sendRemoteRequest</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">_sendError</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
            <span class="p">});</span>
    <span class="p">}</span>
</pre></div>


<p><a href="https://github.com/LLK/scratch-vm/blob/develop/src/extensions/scratch3_microbit/index.js">micro:bit extension</a>对它的调用是:</p>
<p><code>this._ble.read(BLEUUID.service, BLEUUID.rxChar, true, callback);</code></p>
<p>至此，我们就搞懂了<code>A button pressed？</code>是如何实现的，optStartNotifications被设置为True，语义上是接受通知，当micro:bit上数据变化时，及时通知给scratch。技术层面使用了GATT的</p>
<blockquote>
<p>客户端可以请求服务器通知一项特征</p>
</blockquote>
<p>关于这点，我们在<a href="https://blog.just4fun.site/ble-notes.html">BLE学习笔记</a>有提到</p>
<p>因为弄懂了<code>A button pressed？</code>，所以<code>When A button pressed</code>积木也不难理解，当然这需要你熟悉：scatch的HAT类型的积木(事件风格)。源码一目了然</p>
<div class="highlight"><pre><span></span>    <span class="nx">whenButtonPressed</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">BTN</span> <span class="o">===</span> <span class="s1">&#39;any&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_device</span><span class="p">.</span><span class="nx">buttonA</span> <span class="o">|</span> <span class="k">this</span><span class="p">.</span><span class="nx">_device</span><span class="p">.</span><span class="nx">buttonB</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">BTN</span> <span class="o">===</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_device</span><span class="p">.</span><span class="nx">buttonA</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">BTN</span> <span class="o">===</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_device</span><span class="p">.</span><span class="nx">buttonB</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>


<h3 id="write">关于write</h3>
<p>既然我们分析完read，顺手看一下write的实现,直接上源码</p>
<div class="highlight"><pre><span></span>    <span class="nx">write</span> <span class="p">(</span><span class="nx">serviceId</span><span class="p">,</span> <span class="nx">characteristicId</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">encoding</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">serviceId</span><span class="p">,</span> <span class="nx">characteristicId</span><span class="p">,</span> <span class="nx">message</span><span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">encoding</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">params</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">=</span> <span class="nx">encoding</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">sendRemoteRequest</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">_sendError</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
            <span class="p">});</span>
    <span class="p">}</span>
</pre></div>


<p>没什么需要特别说的</p>
<p>我们以一个使用write的积木为例，来看看具体的细节,以display text为例：</p>
<div class="highlight"><pre><span></span>    <span class="nx">displayText</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">output</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_writeSessionData</span><span class="p">(</span><span class="nx">BLECommand</span><span class="p">.</span><span class="nx">CMD_DISPLAY_TEXT</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">_writeSessionData</span> <span class="p">(</span><span class="nx">command</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">getPeripheralIsConnected</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>
        <span class="kr">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nx">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">command</span><span class="p">;</span> <span class="c1">// attach command to beginning of message</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">message</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">output</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">message</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">Base64Util</span><span class="p">.</span><span class="nx">uint8ArrayToBase64</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_ble</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">BLEUUID</span><span class="p">.</span><span class="nx">service</span><span class="p">,</span> <span class="nx">BLEUUID</span><span class="p">.</span><span class="nx">txChar</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;base64&#39;</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>


<p>使用display text打印<code>hello</code>字符串，观察websocket传输的数据:</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;write&quot;</span><span class="p">,</span><span class="nt">&quot;params&quot;</span><span class="p">:{</span><span class="nt">&quot;serviceId&quot;</span><span class="p">:</span><span class="mi">61445</span><span class="p">,</span><span class="nt">&quot;characteristicId&quot;</span><span class="p">:</span><span class="s2">&quot;5261da02-fa7e-42ab-850b-7c80220097cc&quot;</span><span class="p">,</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;gWhlbGxv&quot;</span><span class="p">,</span><span class="nt">&quot;encoding&quot;</span><span class="p">:</span><span class="s2">&quot;base64&quot;</span><span class="p">},</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">}</span>
</pre></div>


<p>这里值得一提的是编码方式:<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array">Uint8Array</a>:  Uint8Array 数组类型表示一个8位无符号整型数组，创建时内容被初始化为0</p>
<p><a href="http://www.w3school.com.cn/js/jsref_charCodeAt.asp">charCodeAt</a>: 方法可返回指定位置的字符的 Unicode 编码。这个返回值是 0 - 65535 之间的整数。</p>
<p>硬件的通信使用的编码可能部位web开发者熟悉，我对底层编码也不熟，多是现学现用，基本也够用.说到编码，想起一本书特别赞:<a href="https://book.douban.com/subject/4822685/">编码</a></p>
<h3 id="gatttool">使用gatttool做些实验</h3>
<p>我在<a href="https://blog.just4fun.site/ble-notes.html">BLE学习笔记</a>有演示gatttool的使用</p>
<p>我们在分析了Scratch/Scratch Link与micro:bit的通信之后，使用ble工具来做些分析，我在树莓派里使用gatttool，你可可以选择其他工具</p>
<p>首先扫描micro:bit的地址</p>
<div class="highlight"><pre><span></span>pi@cozmo1:~ $ sudo hcitool lescan
DF:48:87:86:93:20 BBC micro:bit [zuzop]
</pre></div>


<p>连接它并进入交互模式:</p>
<div class="highlight"><pre><span></span>pi@cozmo1:~ $ gatttool -I -b DF:48:87:86:93:20 -t random
[DF:48:87:86:93:20][LE]&gt; connect
Attempting to connect to DF:48:87:86:93:20
Connection successful
</pre></div>


<p>连接成功！</p>
<p>接着我们来看一下UART service的相关信息:</p>
<div class="highlight"><pre><span></span>[DF:48:87:86:93:20][LE]&gt; primary 0xf005 # 输入0xf005和f005相同，都被处理为16进制
Starting handle: 0x0013 Ending handle: 0xffff
[DF:48:87:86:93:20][LE]&gt; char-desc 0x0013 0xffff
handle: 0x0013, uuid: 00002800-0000-1000-8000-00805f9b34fb
handle: 0x0014, uuid: 00002803-0000-1000-8000-00805f9b34fb
handle: 0x0015, uuid: 5261da01-fa7e-42ab-850b-7c80220097cc
handle: 0x0016, uuid: 00002902-0000-1000-8000-00805f9b34fb
handle: 0x0017, uuid: 00002803-0000-1000-8000-00805f9b34fb
handle: 0x0018, uuid: 5261da02-fa7e-42ab-850b-7c80220097cc
</pre></div>


<p>前头我们从源码里读到:</p>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">BLEUUID</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">service</span><span class="o">:</span> <span class="mh">0xf005</span><span class="p">,</span>
    <span class="nx">rxChar</span><span class="o">:</span> <span class="s1">&#39;5261da01-fa7e-42ab-850b-7c80220097cc&#39;</span><span class="p">,</span>
    <span class="nx">txChar</span><span class="o">:</span> <span class="s1">&#39;5261da02-fa7e-42ab-850b-7c80220097cc&#39;</span>
<span class="p">};</span>
</pre></div>


<p>可知我们的猜测完全正确！Scratch Link是个透明代理。</p>
<p>接着让我们来读取micro:bit的sensor数据,<code>rxChar: '5261da01-fa7e-42ab-850b-7c80220097cc'</code>对应的handle为<code>0x0015</code></p>
<div class="highlight"><pre><span></span>[DF:48:87:86:93:20][LE]&gt; char-read-hnd 0x0015
Characteristic value/descriptor: 00 5f ff f3 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</pre></div>


<p>当我们按住按钮A时读到的数据为</p>
<div class="highlight"><pre><span></span>[DF:48:87:86:93:20][LE]&gt; char-read-hnd 0x0015
Characteristic value/descriptor: 00 44 fe 57 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</pre></div>


<p>多次按下和松开，并观察，我们猜测按钮存储在<code>00 44 fe 57 01</code>中的<code>1</code>这个位置上</p>
<p>回忆一下前头的<code>_processSessionData</code>函数，据此我们就弄懂了数据的编解码方式，我们可以还原出从rxChar读到的经base64编码的数据</p>
<div class="highlight"><pre><span></span>    <span class="nx">_processSessionData</span> <span class="p">(</span><span class="nx">base64</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// parse data</span>
        <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">Base64Util</span><span class="p">.</span><span class="nx">base64ToUint8Array</span><span class="p">(</span><span class="nx">base64</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">tiltX</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">tiltX</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">tiltX</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">tiltY</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">tiltY</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">tiltY</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">buttonA</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">buttonB</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">touchPins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">touchPins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">touchPins</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_sensors</span><span class="p">.</span><span class="nx">gestureState</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>

        <span class="c1">// cancel disconnect timeout and start a new one</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">clearInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_timeoutID</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_timeoutID</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">disconnectSession</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">BLETimeout</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>


<p>我们也可以开启通知 <!--0100还是0200完全是猜的，有依据吗--></p>
<div class="highlight"><pre><span></span>[DF:48:87:86:93:20][LE]&gt; char-write-req 0x0016 0100
Characteristic value was written successfully
Notification handle = 0x0015 value: 00 29 00 8b 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Notification handle = 0x0015 value: 00 2d 00 85 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Notification handle = 0x0015 value: 00 2d 00 85 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Notification handle = 0x0015 value: 00 2d 00 86 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Notification handle = 0x0015 value: 00 2d 00 8b 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Notification handle = 0x0015 value: 00 2c 00 8d 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Notification handle = 0x0015 value: 00 2a 00 8d 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Notification handle = 0x0015 value: 00 2c 00 89 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
</pre></div>


<!--使用pygatt读取数据，使用BLED112 跨平台， 使用scratch3-adapter
mac下使用BLED112 https://github.com/peplin/pygatt/issues/159
 vim /usr/local/lib/python3.6/site-packages/pygatt/backends/bgapi/bgapi.py
adapter.scan() ok
但connect有问题
python  Byte Array to Hex String

https://stackoverflow.com/questions/19210414/byte-array-to-hex-string
-->

<p>接着试试使用pygatt+BLED112在macOS下与micro:bit通信，使用BLED112，我们可以在mac/windows/linux下与ble设备通信</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pygatt</span>
<span class="n">adapter</span> <span class="o">=</span> <span class="n">pygatt</span><span class="o">.</span><span class="n">BGAPIBackend</span><span class="p">()</span> <span class="c1"># 使用BLED112</span>
<span class="n">adapter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="c1"># pygatt在macOS下有bug需要hack start函数: https://github.com/peplin/pygatt/issues/159， 也可以参考：https://github.com/jannopet/LEGO-WeDo-2.0-Python-SDK/blob/master/wedo2/smarthub.py#L20</span>

<span class="n">DEVICE_ADDRESS</span> <span class="o">=</span> <span class="s2">&quot;DF:48:87:86:93:20&quot;</span>
<span class="n">ADDRESS_TYPE</span> <span class="o">=</span> <span class="n">pygatt</span><span class="o">.</span><span class="n">BLEAddressType</span><span class="o">.</span><span class="n">random</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DEVICE_ADDRESS</span><span class="p">,</span> <span class="n">address_type</span><span class="o">=</span><span class="n">ADDRESS_TYPE</span><span class="p">)</span>
<span class="c1">#value = device.char_read(&quot;5261da01-fa7e-42ab-850b-7c80220097cc&quot;)</span>

<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">hexlify</span>
<span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    handle -- integer, characteristic read handle the data was received on</span>
<span class="sd">    value -- bytearray, the data returned in the notification</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Received data: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">hexlify</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="c1"># todo 模仿前头js源码，对数据进行解包</span>

<span class="n">device</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">&quot;5261da01-fa7e-42ab-850b-7c80220097cc&quot;</span><span class="p">,</span>
                     <span class="n">callback</span><span class="o">=</span><span class="n">handle_data</span><span class="p">)</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>


<p>运行后，输出为:</p>
<div class="highlight"><pre><span></span>Received data: b&#39;00ab003600000000000000000000000000000000&#39;
Received data: b&#39;00ad003200000000000000000000000000000000&#39;
Received data: b&#39;00ad003000000000000000000000000000000000&#39;
Received data: b&#39;00ad003700000000000000000000000000000000&#39;
Received data: b&#39;00ad003700000000000000000000000000000000&#39;
Received data: b&#39;00ad003900000000000000000000000000000000&#39;
Received data: b&#39;00ad003900000000000000000000000000000000&#39;
Received data: b&#39;00ad003c00000000000000000000000000000000&#39;
Received data: b&#39;00ad003900000000000000000000000000000000&#39;
Received data: b&#39;00ad003700000000000000000000000000000000&#39;
Received data: b&#39;00ad003900000000000000000000000000000000&#39;
Received data: b&#39;00ad003c00000000000000000000000000000000&#39;
Received data: b&#39;00a9003d00000000000000000000000000000000&#39;
</pre></div>


<p>如此一来我们就可以自己写Scratch Link了，而不必使用官方的！例如在scratch3-adapter中将microbit作为一个extension. 我最近正在将这部分写为一个python库。感兴趣的同学可以一起参与:<a href="https://github.com/wwj718/scratch-microbit-python-sdk">scratch-microbit-python-sdk</a></p>
<hr />
<p>接着我们来实验往microbit中写数据，我们前头提道display text积木，我们对其稍作调整,使其可在console运行，观察编码后的内容是什么:</p>
<div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Enum for micro:bit BLE command protocol.</span>
<span class="cm"> * https://github.com/LLK/scratch-microbit-firmware/blob/master/protocol.md</span>
<span class="cm"> * @readonly</span>
<span class="cm"> * @enum {number}</span>
<span class="cm"> */</span>

<span class="kd">var</span> <span class="nx">CMD_DISPLAY_TEXT</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>


<span class="kd">function</span> <span class="nx">Uint8ToBase64</span><span class="p">(</span><span class="nx">u8Arr</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">CHUNK_SIZE</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span> <span class="c1">//arbitrary number</span>
  <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">u8Arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">slice</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">slice</span> <span class="o">=</span> <span class="nx">u8Arr</span><span class="p">.</span><span class="nx">subarray</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="nx">CHUNK_SIZE</span><span class="p">,</span> <span class="nx">length</span><span class="p">));</span> 
    <span class="nx">result</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">slice</span><span class="p">);</span>
    <span class="nx">index</span> <span class="o">+=</span> <span class="nx">CHUNK_SIZE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">btoa</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">displayText</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">output</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">_writeSessionData</span><span class="p">(</span><span class="nx">CMD_DISPLAY_TEXT</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
    <span class="p">}</span>

<span class="kd">function</span>  <span class="nx">_writeSessionData</span> <span class="p">(</span><span class="nx">command</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nx">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">command</span><span class="p">;</span> <span class="c1">// attach command to beginning of message</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">message</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">output</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">message</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="c1">// const data = Base64Util.uint8ArrayToBase64(output);</span>
        <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">Uint8ToBase64</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">output</span><span class="p">)</span>

        <span class="c1">// return this._ble.write(BLEUUID.service, BLEUUID.txChar, data, &#39;base64&#39;);</span>
    <span class="p">}</span>

<span class="nx">displayText</span> <span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span> 
</pre></div>


<p><code>hello</code>被编码后的为<code>gWhlbGxv</code>，发现和前头websocket捕获的一致:<code>gWhlbGxv</code></p>
<p>但base64应该是Scratch Link与scratch通信时的编解码方式，为了使用gatttool与micro:bit通信，我们需要猜测Scratch Linkmicro:bit里的固件是如何如何约定编解码的，关于这点，官方采取了闭源的策略，估计是有意为之，我们稍后来hack它</p>
<p><code>hello</code> 被编码后分别为：</p>
<div class="highlight"><pre><span></span>gWhlbGxv //base64
Uint8Array(6) [129, 104, 101, 108, 108, 111]  //Uint8Array
</pre></div>


<p>试着以几种方式将他们转为16进制，都没有成功在micro:bit中显示</p>
<div class="highlight"><pre><span></span>char-write-cmd 0x0018  xxx
</pre></div>


<!--
const resetEnergyExpended = new Uint8Array([1]);
    // resetEnergyExpended 的值是'1'，表示重置
    return characteristic.writeValue(resetEnergyExpended);

    是啥 会变为16进制吗

function buf2hex(buffer) { // buffer is an ArrayBuffer
  return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
}

// EXAMPLE:
const buffer = new Uint8Array([129, 97]).buffer;
console.log(buf2hex(buffer)); // = 8161
-->

<p>这导致我们需要使用一些嗅探工具抓包(BLE Sniffer)，之后用<a href="https://www.wireshark.org/download.html">wireshark</a>来分析，不过我手边暂时没有相应硬件，准备淘宝上买一个</p>
<p>破解纯粹出于好玩，我们理解了官方的思路之后，自己重写一个micro:bit固件和是适配器也许比破解来得简单.使用makecode可以很轻松把gatt服务都搭了出来, 参考:<a href="https://github.com/jaafreitas/scratch-microbit-extension/tree/master/firmware">scratch-microbit-extension</a></p>
<hr />
<p>---2018年8月2号更新---</p>
<hr />
<p>我昨晚回去路上一致在想如何在没买到嗅探工具之前，进行破解，网购到货得几天，路上想到几个策略，洗澡的时候又想到几个策略，兴奋不易，可惜晚上没带电脑和树莓派回去，没法做实验</p>
<p>我想到的策略有：</p>
<ul>
<li>观察micro:bit ble 的extension是如何将Uint8Array数据write到txChar，这个extension不包含Scratch Link，源码都在js中，所以即便加密，策略也可以被看出，而micro:bit固件不太可能重写，如果弄清楚micro:bit ble 的extension的机制，估计就能hack官方的机制</li>
<li>使用树莓派伪装成micro:bit，从js可以可以看出，只要能自定义service uuid就可以骗过官方插件，于是引诱它将数据写入树莓派中，如果有加密，有了加密前后的数据，就可以猜测加密的规则。但这样做的一个风险是Scratch Link可能会检验sensor数据的合法性（我在scratch3-adapter中就考虑了这个机制），如果不合法，可能会断开连接。当然这些需要做实验才知道</li>
<li>等待官方完成wedo2的插件，由于它们共用Scratch Link，如果有加密，加密的机制很可能被抽象得一样，而wedo2已经被破解了，所以可以逆向分析出micro:bit部分的加密方式</li>
</ul>
<p>今早一来试了下第一条猜想就成功了，事实证明我想多了，官方并没有做加密</p>
<p>我们来看看在micro:bit ble extension中，官方是如何发送display text数据的</p>
<div class="highlight"><pre><span></span><span class="nx">displayText</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">TEXT</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
        <span class="kr">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nx">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">BLECommand</span><span class="p">.</span><span class="nx">CMD_DISPLAY_TEXT</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">output</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="nx">buffer</span><span class="o">:</span> <span class="nx">output</span><span class="p">},</span> <span class="s1">&#39;*&#39;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;command&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">txChar</span><span class="p">.</span><span class="nx">writeValue</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="s1">&#39;connected&#39;</span><span class="p">)</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;gui.menuBar.bluetoothIndicator&#39;</span><span class="p">).</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">greenIndicatorIcon</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="s1">&#39;disconnected&#39;</span><span class="p">)</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;gui.menuBar.bluetoothIndicator&#39;</span><span class="p">).</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">orangeIndicatorIcon</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
</pre></div>


<p>可以看出官方啥也没做: <code>txChar.writeValue(event.data.buffer);</code></p>
<p>我们从简单的字符串分析入手，先试试<code>a</code></p>
<p>websocket显示从前端发往Scratch Link的是：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;write&quot;</span><span class="p">,</span><span class="nt">&quot;params&quot;</span><span class="p">:{</span><span class="nt">&quot;serviceId&quot;</span><span class="p">:</span><span class="mi">61445</span><span class="p">,</span><span class="nt">&quot;characteristicId&quot;</span><span class="p">:</span><span class="s2">&quot;5261da02-fa7e-42ab-850b-7c80220097cc&quot;</span><span class="p">,</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;gWE=&quot;</span><span class="p">,</span><span class="nt">&quot;encoding&quot;</span><span class="p">:</span><span class="s2">&quot;base64&quot;</span><span class="p">},</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
</pre></div>


<p>在前端被编码后结果分别为：</p>
<div class="highlight"><pre><span></span>gWE= //base64
Uint8Array(2) [129, 97]  //Uint8Array
</pre></div>


<p>我们只需要把buffer转为hex就行</p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">buf2hex</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// buffer is an ArrayBuffer</span>
  <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">),</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="s1">&#39;00&#39;</span> <span class="o">+</span> <span class="nx">x</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)).</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// EXAMPLE:</span>
<span class="kr">const</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">([</span><span class="mi">129</span><span class="p">,</span> <span class="mi">97</span><span class="p">]).</span><span class="nx">buffer</span><span class="p">;</span> <span class="c1">// display a -&gt; [129, 97]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">buf2hex</span><span class="p">(</span><span class="nx">buffer</span><span class="p">));</span> <span class="c1">// = 8161</span>
</pre></div>


<p>在树莓派的gatttool中：</p>
<div class="highlight"><pre><span></span>[DF:48:87:86:93:20][LE]&gt; char-write-cmd 0x0018 8161
</pre></div>


<p><img src="http://wwj-fig-bed.just4fun.site/microbit_scratch_2de5e6c9.png" width=500 /></p>
<p>大功告成！</p>
<!--
read和write都是sendRemoteRequest 到 scratch link，关注语义，所以在scratch link中只需要关注read write！使用jsonrpc确实更合适，比消息简单-->

<h1 id="tips">tips</h1>
<p>记录一些scratch团队的机智做法</p>
<h3 id="_6">连接设备</h3>
<p><a href="https://github.com/LLK/scratch-vm/blob/develop/src/extensions/scratch3_microbit/index.js#L116">startDeviceScan</a></p>
<p>用户选中extesion之后开始连接，只扫描出extension对应的设备，而不是把周围的BLE都扫描出来，体验十分友好</p>
<h3 id="https">https校验问题</h3>
<p>由于网站都逐渐过渡到https，而Scratch Link是个本地websocker server，要让Scratch Link与浏览器通信，需要使用wss协议。而本地websocker server采用openssl本地自生成的证书的话，浏览器要让用户在一个新页面里点击高级设置才行，体验很不友好</p>
<p>scratch团队的解决方案十分聪明, 让<code>device-manager.scratch.mit.edu</code>这个域名指向<code>127.0.0.1</code>，websocker server就可以使用这个域名的证书。</p>
<h4 id="scratch-link">Scratch Link的内部服务怎么写</h4>
<p><a href="https://github.com/LLK/scratch-vm/blob/develop/src/io/bleSession.js#L3">ScratchLinkWebSocket</a>对应的server为<code>'wss://device-manager.scratch.mit.edu:20110/scratch/ble'</code></p>
<p>BLESession的定位是:</p>
<blockquote>
<p>A BLE device session object.  It handles connecting, over web sockets, to BLE devices, and reading and writing data to them.  </p>
</blockquote>
<p>看去是透明代理</p>
<p>所以根据js的接口，要独立实现Scratch Link应该不难</p>
<h1 id="_7">参考</h1>
<ul>
<li><a href="https://scratch.mit.edu/microbit">scratch.mit.edu/microbit</a></li>
<li><a href="https://scratch.mit.edu/conference">conference</a></li>
<li><a href="https://lancaster-university.github.io/microbit-docs/resources/bluetooth/bluetooth_profile.html">Bluetooth Developer Studio Level 3 Profile Report</a></li>
<li><a href="https://blog.just4fun.site/ble-notes.html">BLE学习笔记</a></li>
<li><a href="https://cn0xroot.com/2016/06/12/ble-hacking%EF%BC%9Able-scan-and-sniffer-withubertooth-one/">BLE Hacking：使用Ubertooth one扫描嗅探低功耗蓝牙</a></li>
<li><a href="https://draapho.github.io/2016/11/15/1616-python-ble/">使用python实现BLE通讯</a></li>
<li><a href="https://github.com/peplin/pygatt">pygatt</a></li>
</ul>
		</div><!-- /.entry-content -->
<!--
<p style="font-size:16px" class="alert alert-info">此文对我有价值，打赏杯茶喝^_^  <a target="_blank" class="btn btn-primary btn-large" href="https://me.alipay.com/wuwj">支付宝打赏</a> </p>
-->
<hr>
<div class="alert alert-success">版权声明：<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">自由转载-非商用-非衍生-保持署名</a></div>
<hr>
<!-- Duoshuo Comment BEGIN -->
<!--
	<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"wwj718blog"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
    -->
    <!-- Duoshuo Comment END -->
	</article>
</section>
        </div><!--/span-->
      
		<div style="margin-left:70px;" class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
    <!--<a href="/others/startedx.html"><h3>Open edX相关咨询</h3></a>-->
<hr/>
<!--
<h3>我的服务<h3>
    <a href="http://olk8jbdzi.bkt.clouddn.com/index.html"><h4>开源在线表单设计工具</h4></a>
    <a href="#kinto.jsut4fun.site"><h4>kinto server(施工中)</h4></a>
    <a href="#"><h4></h4></a>
-->
<!--<a href="/join-us"><h3>招兵买马(招实习!)<h3></a>-->
</hr>
</hr>

<li style="text-align: center;"><a target="_blank"  href="https://www.e-ducation.cn/?utm_source=zgblog&utm_medium=ads&utm_campaign=marketing_01"><img src="http://os54tv4fc.bkt.clouddn.com/education.png" width="100%" max-width="250px" /> </a></li>
<hr/>

<h4>少儿编程指北</h4>
<p>关注少儿编程，回顾这个领域的发展历程，推荐、解读经典书籍和文章，吐槽糟糕的教育，也推荐一些好产品和有趣的项目。不蹭热点不站队 :）</p>
<li style="text-align: center;">
<img src="http://p6ur0vhyj.bkt.clouddn.com/qrcode_for_gh_e458d8658f3b_258.jpg" width="150px" /> 
</li>
<hr/>

<h4>站内搜索(基于google，你可能看不到)</h4>
<div>
<script>
  (function() {
       var cx = '004056624884628766270:aaifcpik-ua';
	       var gcse = document.createElement('script');
		       gcse.type = 'text/javascript';
			       gcse.async = true;
				       gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
					           '//www.google.com/cse/cse.js?cx=' + cx;
							       var s = document.getElementsByTagName('script')[0];
								       s.parentNode.insertBefore(gcse, s);
									     })();
</script>
<gcse:search></gcse:search>
</div>
<hr>
<h4>手机访问：</h4>
<li style="text-align: center;">
<img src="http://os54tv4fc.bkt.clouddn.com/1514204585.png" width="150px" /> 
</li>

    <li><i class="icon-external-link"></i><a href="/aboutme.html">关于我</a></li>
    <li><i class="icon-external-link"></i><a href="https://github.com/wwj718">my github</a></li>
    <li><i class="icon-external-link"></i><a href="#">my gmail：wuwenjie718@gmail.com</a></li>
<hr>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>分类</h4></li>
<li>
<a href="/category/编程.html">
    <i class="icon-folder-open icon-large"></i>编程
</a>
</li>
<li>
<a href="/category/codelab.html">
    <i class="icon-folder-open icon-large"></i>codelab
</a>
</li>
<li>
<a href="/category/读书.html">
    <i class="icon-folder-open icon-large"></i>读书
</a>
</li>
<li>
<a href="/category/edx.html">
    <i class="icon-folder-open icon-large"></i>edx
</a>
</li>
<li>
<a href="/category/工具.html">
    <i class="icon-folder-open icon-large"></i>工具
</a>
</li>
<li>
<a href="/category/公众号.html">
    <i class="icon-folder-open icon-large"></i>公众号
</a>
</li>
<li>
<a href="/category/观念.html">
    <i class="icon-folder-open icon-large"></i>观念
</a>
</li>
<li>
<a href="/category/技术.html">
    <i class="icon-folder-open icon-large"></i>技术
</a>
</li>
<li>
<a href="/category/架构.html">
    <i class="icon-folder-open icon-large"></i>架构
</a>
</li>
<li>
<a href="/category/空想.html">
    <i class="icon-folder-open icon-large"></i>空想
</a>
</li>
<li>
<a href="/category/少儿编程.html">
    <i class="icon-folder-open icon-large"></i>少儿编程
</a>
</li>
<li>
<a href="/category/诗词.html">
    <i class="icon-folder-open icon-large"></i>诗词
</a>
</li>
<li>
<a href="/category/数据.html">
    <i class="icon-folder-open icon-large"></i>数据
</a>
</li>
<li>
<a href="/category/算法.html">
    <i class="icon-folder-open icon-large"></i>算法
</a>
</li>
<li>
<a href="/category/随笔.html">
    <i class="icon-folder-open icon-large"></i>随笔
</a>
</li>
<li>
<a href="/category/瓦碎集.html">
    <i class="icon-folder-open icon-large"></i>瓦碎集
</a>
</li>
<li>
<a href="/category/硬件.html">
    <i class="icon-folder-open icon-large"></i>硬件
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>
<hr>

<a target="_blank" href="http://wwj718.github.io/feeds/all.rss.xml">订阅feed</a>


<hr>
<h3>友情链接</h3>
<li><a target="_blank"  href="https://scratch.mit.edu/">Scratch</a></li>
<li><a target="_blank"  href="https://www.raspberrypi.org/">Raspberry Pi</a></li>
<li><a target="_blank" href="http://microbit.org/">micro:bit</a></li>
<li><a target="_blank" href="https://code.org/">Code.org</a></li>
<li><a target="_blank" href="https://www.edustack.org/">edustack</a></li>
<li><a target="_blank" href="http://blog.e-ducation.cn/">e-ducation</a></li>

</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer id="footer">
        <address id="about">
            诗酒趁年华<hr>
              powered by Pelican 
              <hr>
              <a href="www.miitbeian.gov.cn" target="_blank">苏ICP备18043473号</a>
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F18db4b662c04fbd6cc2851d246c51b3f' type='text/javascript'%3E%3C/script%3E"));
</script>        </address><!-- /#about -->
      </footer>

    </div><!--/.fluid-container-->
<a href="https://github.com/wwj718"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/567c3a48d796e2fc06ea80409cc9dd82bf714434/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png"></a>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://libs.baidu.com/jquery/1.8.2/jquery.min.js"></script>
    <script src="/theme/js/bootstrap-transition.js"></script>
    <script src="/theme/js/bootstrap-dropdown.js"></script>
    <script src="/theme/js/bootstrap-collapse.js"></script>
	
	<!--<script src="/theme/js/autosidebar.js"></script>-->
  </body>
</html>
