<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"><channel><title>writing for time</title><link>/</link><description></description><lastBuildDate>Tue, 31 Jul 2018 00:00:00 +0000</lastBuildDate><item><title>BLE学习笔记</title><link>/ble-notes.html</link><description>&lt;p&gt;近期对&lt;a href="https://zh.wikipedia.org/wiki/%E8%93%9D%E7%89%99%E4%BD%8E%E5%8A%9F%E8%80%97"&gt;BLE(蓝牙低功耗)&lt;/a&gt;很感兴趣,我在玩几个支持BLE的教育产品: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;microbit&lt;/li&gt;
&lt;li&gt;wedo2&lt;/li&gt;
&lt;li&gt;BB8&lt;/li&gt;
&lt;li&gt;树莓派&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;就连接的简易性和续航方面，体验都非常好,传输距离更是超过了100米。就智能硬件在教育这个领域的应用而言，我相信BLE是未来，尤其是&lt;a href="https://github.com/WebBluetoothCG/web-bluetooth/blob/gh-pages/implementation-status.md#chrome"&gt;web bluetooth&lt;/a&gt;的标准化推进，使得基于web来做硬件编程教育变得简易，如此一来跨平台变得简易而开发成本也大为降低&lt;/p&gt;
&lt;p&gt;本文在前半部分整理了BLE相关的知识和概念（多数摘自维基百科），后半部分记录了我学完理论之后，做的GATT相关实验，介绍了一些方便做实验开源硬件和工具，以及它们的使用方法&lt;/p&gt;
&lt;h2 id="ble"&gt;&lt;a href="https://zh.wikipedia.org/wiki/%E8%93%9D%E7%89%99%E4%BD%8E%E5%8A%9F%E8%80%97"&gt;BLE(蓝牙低功耗)&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;引维基百科的介绍:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;蓝牙低功耗（Bluetooth Low Energy，或称Bluetooth LE、BLE，旧商标Bluetooth Smart）也称蓝牙低能耗、低功耗蓝牙，是蓝牙技术联盟设计和销售的一种个人局域网技术，旨在用于医疗保健、运动健身、信标、安防、家庭娱乐等领域的新兴应用。相较经典蓝牙，低功耗蓝牙旨在保持同等通信范围的同时显著降低功耗和成本。&lt;br /&gt;
包括iOS、Android、Windows Phone和BlackBerry在内的大多数移动操作系统，以及macOS、Linux、Windows 8与Windows 10等在内的桌面操作系统，均已原生支持低功耗蓝牙。蓝牙技术联盟（SIG）预测，到2018年超过90%有蓝牙的智能手机将支持低功耗蓝牙。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;从这些信息来看，BLE已获得了各大平台的支持,具体的支持情况为:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;iOS 5及更高版本&lt;/li&gt;
&lt;li&gt;Windows 8及更高版本&lt;/li&gt;
&lt;li&gt;Android 4.3及更高版本&lt;/li&gt;
&lt;li&gt;Linux 3.4及更高版本，通过BlueZ 5.0&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;大家可以放心在产品中使用。&lt;/p&gt;
&lt;h3 id="_1"&gt;主要优点&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;低功耗，使用纽扣电池就可运行数月至数年&lt;/li&gt;
&lt;li&gt;小体积、低成本&lt;/li&gt;
&lt;li&gt;与现有的大部分手机、平板电脑和计算机兼容&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="gatt"&gt;GATT&lt;/h1&gt;
&lt;p&gt;GATT (Generic Attribute Profile) 的中文翻译是通用属性规范。&lt;/p&gt;
&lt;p&gt;维基百科里提到：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;当前所有低功耗应用profile都基于通用属性规范（GATT）。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;那么什么是profile呢&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;蓝牙技术联盟沿用经典蓝牙的规范内容，为蓝牙低功耗定义了一些profile，这些profile定义了一个设备在特定应用情景下如何工作。制造商应通过在实现中遵循特定的profile以确保兼容性。一台设备可以使用多个profile。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;说回GATT&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;GATT定义了属性（Attribute），作为通用的封装数据的单位，并定义了如何通过蓝牙连接传输属性从而达到传输数据的目的&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;所以本文技术方面的很多内容都与GATT相关。&lt;/p&gt;
&lt;h3 id="gap"&gt;&lt;a href="https://learn.adafruit.com/introduction-to-bluetooth-low-energy?view=all"&gt;GAP&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;介绍 GATT 之前，我们先来了解一下 GAP（Generic Access Profile）. GAP用来控制设备连接和广播。 它使你的设备被其他设备可见，并决定了你的设备是否可以以及怎样与合同设备进行交互。例如 Beacon 设备就只是向外广播，不支持连接，小米手环就等设备就可以与中心设备连接。&lt;/p&gt;
&lt;p&gt;GAP 给设备定义了若干角色，其中主要的两个是：外围设备（Peripheral）和中心设备（Central）。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;外围设备：这一般就是非常小或者简单的低功耗设备，用来提供数据，并连接到一个更加相对强大的中心设备。例如小米手环。&lt;/li&gt;
&lt;li&gt;中心设备：中心设备相对比较强大，用来连接其他外围设备。例如手机等。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;一旦两个设备经过 GAP 协议建立起了连接，GATT 就开始起作用了，我们就开始跳到GATT部分&lt;/p&gt;
&lt;p&gt;关于GAP的更多内容，可以参考:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://learn.adafruit.com/introduction-to-bluetooth-low-energy?view=all"&gt;introduction-to-bluetooth-low-energy&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.race604.com/gatt-profile-intro/"&gt;上文的中文版本&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="_2"&gt;软件模型&lt;/h3&gt;
&lt;h4 id="gatt_1"&gt;GATT相关术语&lt;/h4&gt;
&lt;p&gt;由于我自己目前正在学习BLE，对这个领域的知识没有全局的认识，所积累的知识多是片段式的，所以这篇文章会很枯燥，它更像一个零碎的学习笔记，而不是教程。概念相关的部分基本摘自维基百科，如果大家学习ble的相关概念，建议直接读维基百科，而不是我这这部分二道贩子文章。&lt;/p&gt;
&lt;p&gt;罗列一下GATT相关术语&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;客户端(Client)：  一个发出GATT命令和请求的设备，然后接受响应。例如一个计算机或智能手机。&lt;/li&gt;
&lt;li&gt;服务器(Server)：  一个接受GATT命令和请求的设备，然后返回响应。例如一个温度传感器。&lt;/li&gt;
&lt;li&gt;特征(Characteristic)：  在客户端与服务器间传递的数据值，例如当前的电池电压。GATT 事务中的最低界别的是 Characteristic，Characteristic 是最小的逻辑数据单元。和 BLE 外设打交道，主要是通过 Characteristic&lt;/li&gt;
&lt;li&gt;服务(Service)：  有关特征的收集，具有一系列操作来执行特定功能。例如，“体温计”服务包括一个温度测量值，以及测量的时间间隔。&lt;/li&gt;
&lt;li&gt;描述符(Descriptor：  描述符提供有关特征的其他信息。例如指示一个温度值特征的单位（如摄氏度），以及传感器可以测量的最大值和最小值。描述符是可选的——每个特征可以有任何数量的描述符。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="" src="https://learn.adafruit.com/assets/13828" /&gt;&lt;/p&gt;
&lt;p&gt;值得注意的是：某些服务和特征用于管理目的——例如，“通用访问”服务中的型号名称和序列号可作为标准特征读取。设备的主要功能被称为主（primary）服务&lt;/p&gt;
&lt;p&gt;你可以自己实现一个类似串口（UART）的 Sevice，这个 Service 中包含两个 Characteristic，一个被配置只读的通道（RX），另一个配置为只写的通道（TX）。(TX表示发射，RX表示接收)&lt;/p&gt;
&lt;h4 id="identifiers"&gt;标识符（Identifiers）&lt;/h4&gt;
&lt;p&gt;服务、特征和描述符被统称为属性（attributes），并以UUID标识。蓝牙技术联盟已预留一系列UUID供标准属性使用:&lt;a href="https://www.bluetooth.org/en-us/specification/assigned-numbers"&gt;蓝牙分配号码&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;16 bit 的 UUID 是官方通过认证的，需要花钱购买，128 bit 是自定义的，可以自己随便设置&lt;/p&gt;
&lt;h4 id="gatt_2"&gt;GATT操作&lt;/h4&gt;
&lt;p&gt;GATT协议提供了大量用于客户端的命令以发现有关服务器的信息。这包括：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;发现所有主要服务的UUID&lt;/li&gt;
&lt;li&gt;使用指定UUID查找一个服务&lt;/li&gt;
&lt;li&gt;查找指定主服务的辅助服务&lt;/li&gt;
&lt;li&gt;发现指定服务的所有特征&lt;/li&gt;
&lt;li&gt;查找匹配指定UUID的特征&lt;/li&gt;
&lt;li&gt;读取特定特征的所有描述符&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;除此之外，也提供读（从服务器传输到客户端）和写（客户端传给服务器）特征值的命令：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;可以指定特征的UUID或句柄（handle）值（由上面的发现命令返回）来读取值。&lt;/li&gt;
&lt;li&gt;写操作始终需要以句柄来标识特征，但可选是否需要服务器返回响应。(Q:写操作不能使用特征的UUID吗？)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;GATT有提供通知（notifications）和指示（indications）。客户端可以请求服务器通知一项特征。服务器可以在其变为可用时将该值发送给客户端。例如，温度传感器的服务器可以在每次测量时通知其客户端。这得以避免客户端轮询服务器，造成服务器的无线电路保持运行。&lt;/p&gt;
&lt;p&gt;指示（indication）与通知类似，不同之处是它需要客户端响应已收到该消息。&lt;/p&gt;
&lt;h4 id="gatt_3"&gt;GATT 的连接与网络拓扑&lt;/h4&gt;
&lt;p&gt;GATT 连接网络拓扑结构:&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="https://learn.adafruit.com/assets/13826" /&gt;&lt;/p&gt;
&lt;p&gt;GATT 连接是独占的。也就是一个 BLE 外设同时只能被一个中心设备连接（中心设备可以连接多个BLE外设）。一旦外设被连接，它就会马上停止广播，这样它就对其他设备不可见了。当设备断开，它又开始广播。&lt;/p&gt;
&lt;h4 id="gatt_4"&gt;GATT 通信事务&lt;/h4&gt;
&lt;p&gt;GATT 通信的双方是 C/S 关系。外设作为 GATT 服务端（Server），它维持了 ATT 的查找表以及 service 和 characteristic 的定义。中心设备是 GATT 客户端（Client），它向 Server 发起请求&lt;/p&gt;
&lt;h3 id="_3"&gt;体验&lt;/h3&gt;
&lt;p&gt;上边的这些背景知识，已经足够我们开发BLE相关的项目了。&lt;/p&gt;
&lt;p&gt;但要体验BLE，则无需任何背景知识，如果你有一块micro:bit，你就可以快速来体验一下BLE的好处:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://blog.just4fun.site/scratch3-microbit.html"&gt;scratch3.0 + micro:bit&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://scratch.mit.edu/microbit"&gt;scratch.mit.edu/microbit&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;两篇教程任选其一跟着操作就行&lt;/p&gt;
&lt;p&gt;上边两个项目的源码都完全开放，所以你可以拿到service和characteristic的uuid，如果你有兴趣，可以翻阅源码拿到这些数据，自己写gatt client去和microbit交互&lt;/p&gt;
&lt;h1 id="gatt_5"&gt;GATT实验笔记&lt;/h1&gt;
&lt;p&gt;在学完GATT的相关知识后，我准备动手写写client和server&lt;/p&gt;
&lt;p&gt;下文是我做实验的笔记。&lt;/p&gt;
&lt;h3 id="_4"&gt;工具&lt;/h3&gt;
&lt;p&gt;我准备使用树莓派(3B)和micro:bit来做实验&lt;/p&gt;
&lt;p&gt;可能对你有用的软件工具有：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;hcitool/gatttool(运行在树莓派上)&lt;/li&gt;
&lt;li&gt;BLE Scanner（运行在安卓手机上）&lt;/li&gt;
&lt;li&gt;LightBlue（运行在macOS下）&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="_5"&gt;在树莓派中做实验&lt;/h3&gt;
&lt;p&gt;做实验之前，我们先来了解一下&lt;a href="http://www.bluez.org/"&gt;bluez&lt;/a&gt;，bluez是官方Linux蓝牙协议栈，是一个基于GPL协议发布的开源项目，当前的最新版本是5.50，稍后我们在树莓派里做蓝牙相关的实验，我们都得依赖它&lt;/p&gt;
&lt;p&gt;bluez安装玩之后，会得到hcitool与gattool，我们可以根据这些工具来轻松的调试我们的蓝牙设备。 （需要注意的是，在调试BLE设备时，需要获得root权限）&lt;/p&gt;
&lt;p&gt;我在树莓派刷完raspbian stretch镜像后，好像自带了bluez&lt;/p&gt;
&lt;p&gt;查看bluez版本：&lt;code&gt;bluetoothctl  -v&lt;/code&gt;,我的当前版本是5.43 &lt;/p&gt;
&lt;h4 id="hcitool"&gt;hcitool&lt;/h4&gt;
&lt;p&gt;hcitool可以对蓝牙进行控制，参数分为两部分，一为正常的蓝牙设备调试，二为BLE设备调试&lt;/p&gt;
&lt;p&gt;为了开始我们的实验，我们得有一个GATT server，我们先实验micro:bit当GATT server&lt;/p&gt;
&lt;p&gt;你需要现在micro:bit烧入一个固件:&lt;a href="https://makecode.microbit.org/55238-47183-11532-02360"&gt;microbit-bluetooth&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ps: pxt允许你设置蓝牙连接是否需要密码&lt;/p&gt;
&lt;p&gt;之后我们就能够在树莓派中搜到micro:bit了:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ sudo hcitool lescan
LE Scan ...
DF:48:87:86:93:20 BBC micro:bit &lt;span class="o"&gt;[&lt;/span&gt;zuzop&lt;span class="o"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;从中我们可以拿到microbit的地址:&lt;code&gt;DF:48:87:86:93:20&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;但我在查看设备附加信息时却失败了:&lt;code&gt;sudo hcitool leinfo DF:48:87:86:93:20&lt;/code&gt;，reddit里有人说可能是树莓派里蓝牙与wifi冲突（公用一个芯片）&lt;/p&gt;
&lt;p&gt;但我使用手机工具：&lt;code&gt;BLE Scanner&lt;/code&gt;和电脑工具:&lt;code&gt;LightBlue&lt;/code&gt;都没问题&lt;/p&gt;
&lt;p&gt;这些我们从LightBlue里都可以看到:&lt;/p&gt;
&lt;p&gt;&lt;img src="http://wwj-fig-bed.just4fun.site/ble_f33ee366.png" width=600 /&gt;&lt;/p&gt;
&lt;p&gt;我们从lancaster给出的&lt;a href="[Bluetooth Developer Studio Level 3 Profile Report](https://lancaster-university.github.io/microbit-docs/resources/bluetooth/bluetooth_profile.html)"&gt;micro:bit蓝牙文档&lt;/a&gt;里，可以查到:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://lancaster-university.github.io/microbit-docs/resources/bluetooth/bluetooth_profile.html"&gt;Bluetooth UART Service&lt;/a&gt;的uuid为:&lt;code&gt;6E400001B5A3F393E0A9E50E24DCCA9E&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;!--从文档里可以看到 固件更新、uart都做成了ble 服务--&gt;

&lt;h3 id="gatttool"&gt;gatttool&lt;/h3&gt;
&lt;p&gt;关于gatttool的介绍我们引用&lt;a href="https://blog.csdn.net/Chuck_lin/article/details/78846165"&gt;蓝牙工具hcitool和gatttool的使用&lt;/a&gt;:&lt;/p&gt;
&lt;p&gt;使用hcitool主要是为了对设备的连接进行管理，对BLE数据进行精细化管理的话，就需要用到gattool。使用gattool对蓝牙设备发送指令的操作上要比hcitool的cmd齐全很多。&lt;/p&gt;
&lt;p&gt;关于gattool的使用分为两种，一种直接使用参数对蓝牙设备进行控制；二就是使用-I参数进入gattool的interactive模式对蓝牙设备进行控制&lt;/p&gt;
&lt;p&gt;接下来我们使用gatttool来做些&lt;a href="http://blog.dan.drown.org/ble-micro-bit-uart/"&gt;实验&lt;/a&gt;, 进入交互模式&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pi@raspberrypi:~ $ gatttool -I -b DF:48:87:86:93:20 -t random
[DF:48:87:86:93:20][LE]&amp;gt; connect
Attempting to connect to DF:48:87:86:93:20
Connection successful
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;micro:bit将显示连接成功的图案&lt;/p&gt;
&lt;p&gt;接着我们来看一下UART service的相关信息:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[DF:48:87:86:93:20][LE]&amp;gt; primary 6e400001-b5a3-f393-e0a9-e50e24dcca9e
Starting handle: 0x0021 Ending handle: 0xffff
[DF:48:87:86:93:20][LE]&amp;gt; char-desc 0x0021 0xffff
handle: 0x0021, uuid: 00002800-0000-1000-8000-00805f9b34fb
handle: 0x0022, uuid: 00002803-0000-1000-8000-00805f9b34fb
handle: 0x0023, uuid: 6e400002-b5a3-f393-e0a9-e50e24dcca9e
handle: 0x0024, uuid: 00002902-0000-1000-8000-00805f9b34fb
handle: 0x0025, uuid: 00002803-0000-1000-8000-00805f9b34fb
handle: 0x0026, uuid: 6e400003-b5a3-f393-e0a9-e50e24dcca9e
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Q：service里同时包含Characteristic和Descriptor？&lt;/p&gt;
&lt;p&gt;我们在前头提到:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;可以指定特征的UUID或句柄（handle）值（由上面的发现命令返回）来读取值&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;我看来看看这些uuid，从lancaster给出的&lt;a href="https://lancaster-university.github.io/microbit-docs/resources/bluetooth/bluetooth_profile.html"&gt;micro:bit蓝牙文档&lt;/a&gt;里，可以查到&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;UART RX CHARACTERISTIC UUID: &lt;code&gt;6E400002B5A3F393E0A9E50E24DCCA9E&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;UART TX CHARACTERISTIC UUID:&lt;code&gt;6E400003B5A3F393E0A9E50E24DCCA9E&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;(TX表示发射，RX表示接收)&lt;/p&gt;
&lt;p&gt;Descriptor &lt;code&gt;00002902-0000-1000-8000-00805f9b34fb&lt;/code&gt; (handle: 0x0024)是 Client Characteristic Configuration， 允许你从service中订阅信息&lt;/p&gt;
&lt;p&gt;其他三个descriptors是 Primary Service 和 Characteristic Declaration，暂时跳过&lt;/p&gt;
&lt;p&gt;设置 Client Characteristic Configuration为&lt;code&gt;0x0200&lt;/code&gt; 将订阅 TX events.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[DF:48:87:86:93:20][LE]&amp;gt; char-write-req 0x0024 0200
Characteristic value was written successfully
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;每次按下micro:bit上的A按钮，我将收到通知&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[DF:48:87:86:93:20][LE]&amp;gt; char-write-req 0x0024 0200
Characteristic value was written successfully
Indication   handle = 0x0023 value: 01
Indication   handle = 0x0023 value: 02
Indication   handle = 0x0023 value: 03
Indication   handle = 0x0023 value: 04
Indication   handle = 0x0023 value: 05
Indication   handle = 0x0023 value: 06
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;我们也可以直接读取:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[DF:48:87:86:93:20][LE]&amp;gt; char-read-hnd 0x0023
Characteristic value/descriptor: 06
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;接下来，让我们往micro:bit的UART中写数据,前头我们会有提到&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;写操作始终需要以句柄来标识特征&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;写操作对应的句柄(handle)为&lt;code&gt;0x0026&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;我们在ble&lt;a href="https://makecode.microbit.org/55238-47183-11532-02360"&gt;server 固件&lt;/a&gt;里写的逻辑是遇:到换行，现实数据通信图标. 而换行的十六进制为: &lt;code&gt;0x0a&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;char-write-cmd 0x0026 0a
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;可以看到数据通信图标在micro:bit中显示&lt;/p&gt;
&lt;p&gt;至此gatt client与gatt server的读写操作已经订阅消息，我们都做了演示&lt;/p&gt;
&lt;h3 id="gatt-server"&gt;gatt server&lt;/h3&gt;
&lt;p&gt;我们可以通过在&lt;a href="https://makecode.microbit.org/"&gt;makecode&lt;/a&gt;中拖延积木为micro:bit搭出所需的gatt server，但事实上我们实在组合已有的服务&lt;/p&gt;
&lt;p&gt;下来我们实验树莓派来运行一个简单的gatt server，我们将使用&lt;a href="https://github.com/ukBaz/python-bluezero"&gt;python-bluezero&lt;/a&gt;提供的一个demo来讲解如何写gatt server&lt;/p&gt;
&lt;p&gt;&lt;a href="https://github.com/ukBaz/python-bluezero"&gt;python-bluezero&lt;/a&gt;致力于帮助新手使用Bluez，为使用蓝牙功能的用户提供简化的API。该库底层封装了对Bluez、D-Bus API的调用，并使用“合理”的默认值来实现简化。它旨在支持创建有趣的STEM活动，而无需深入理解Bluez API或编写事件循环。&lt;/p&gt;
&lt;p&gt;该库假定你的BlueZ版本为5.43（Raspbian Stretch目前是这个版本）&lt;/p&gt;
&lt;h4 id="_6"&gt;安装&lt;/h4&gt;
&lt;p&gt;安装过程参考&lt;a href="http://bluezero.readthedocs.io/en/stable/install_bluez.html"&gt;文档&lt;/a&gt;&lt;/p&gt;
&lt;h4 id="_7"&gt;使用&lt;/h4&gt;
&lt;p&gt;安装完系统依赖之后，就可以安装&lt;a href="https://github.com/ukBaz/python-bluezero"&gt;python-bluezero&lt;/a&gt;了，我选择在python3中使用，将项目克隆到本地之后,进入目录:  &lt;code&gt;python3 setup.py install&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;下边我们来看一下&lt;a href="https://github.com/ukBaz/python-bluezero#gatt-server-peripheral-role"&gt;GATT Server (Peripheral role)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;这个例子实现了一个报告cpu温度的characteristic，允许client请求服务器通知温度变化。&lt;/p&gt;
&lt;p&gt;源码为&lt;a href="https://github.com/ukBaz/python-bluezero/blob/master/examples/cpu_temperature.py"&gt;cpu_temperature.py&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;运行之后，可以看到:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pi@cozmo1:~/python-bluezero/examples $ python3 cpu_temperature.py
cpu_temp: temp=57.5&amp;#39;C

CPU temperature is 57.5C
cpu_temp: temp=58.0&amp;#39;C

sint16: b&amp;#39;\xa8\x16&amp;#39;
b&amp;#39;\xa8\x16&amp;#39;
cpu_temp: temp=58.0&amp;#39;C

Advertisement registered
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;如果你分不清那个是你的树莓派，如果树莓派离你很近，就接着选择信号好的外围设备（Peripheral）,连接它，就可以读取树莓派的cpu温度了&lt;/p&gt;
&lt;p&gt;&lt;img width=300px src="http://wwj-fig-bed.just4fun.site/ble_d3bd4f6b.png" /&gt;&lt;/p&gt;
&lt;p&gt;我在界面点击R(read),可以看到温度值的十六进制表示为: &lt;code&gt;0xBA13&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;我们在树莓派里看到当前温度为:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;cpu_temp&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;temp&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;50.5&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;C&lt;/span&gt;
&lt;span class="s1"&gt;sint16: b&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;\&lt;/span&gt;&lt;span class="n"&gt;xba&lt;/span&gt;&lt;span class="o"&gt;\&lt;/span&gt;&lt;span class="n"&gt;x13&lt;/span&gt;&lt;span class="err"&gt;&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;这两者是怎么联系起来的呢，我们翻下&lt;a href="https://github.com/ukBaz/python-bluezero/blob/master/examples/cpu_temperature.py"&gt;源码&lt;/a&gt;，跟踪一下当gatt client读取温度时，发生了什么&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;ReadValue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;reading&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;get_cpu_temperature&lt;/span&gt;&lt;span class="p"&gt;()]&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;props&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;constants&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GATT_CHRC_IFACE&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Value&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;reading&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;dbus&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Array&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;cpu_temp_sint16&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;props&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;constants&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GATT_CHRC_IFACE&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Value&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
        &lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;cpu_temp_sint16&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;answer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt;
    &lt;span class="n"&gt;value_int16&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sint16&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="nb"&gt;bytes&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;value_int16&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;answer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dbus&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Byte&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;answer&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;sint16&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_bytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;byteorder&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;little&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;signed&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;可见温度被sint16函数做了转化，我们来看下十进制的50.5被转完之后是什么:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;In [1]: def sint16(value):
   ...:     return int(value * 100).to_bytes(2, byteorder=&amp;#39;little&amp;#39;, signed=True)
   ...:
   ...:

In [2]: t = 50.5

In [3]: sint16(50.5)
Out[3]: b&amp;#39;\xba\x13&amp;#39;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;前导&lt;code&gt;\x&lt;/code&gt;转义序列意味着接下来的两个字符被解释为字符代码的十六进制数字，所以&lt;code&gt;\xaa&lt;/code&gt;等于&lt;code&gt;chr(0xaa)&lt;/code&gt;. 和手机里显示的正好对起来啦&lt;/p&gt;
&lt;p&gt;我们如何把它逆向转化呢，毕竟我们在client只看到它的16进制表示:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;In [4]: int.from_bytes(b&amp;#39;\xba\x13&amp;#39;, byteorder=&amp;#39;little&amp;#39;)
Out[4]: 5050  #50.5 * 100
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;源码的其他部分，语义十分清晰，如果你有GATT的基础知识（前头我们整理的那些），读起来应该很轻松&lt;/p&gt;
&lt;!--
### 开始实验

gatttool -I -b DF:48:87:86:93:20 -t random
--&gt;

&lt;h1 id="_8"&gt;更多好玩的&lt;/h1&gt;
&lt;h3 id="bb8"&gt;BB8&lt;/h3&gt;
&lt;p&gt;BB8基于ble基于与外部通信，允许GATT client读取它的状态信息并控制它，我们使用LightBlue对其做个了解&lt;/p&gt;
&lt;p&gt;如果你想了解BB8提供的所有服务，可以参考&lt;a href="https://github.com/WebBluetoothCG/demos/blob/gh-pages/bluetooth-toy-bb8/index.html#L269"&gt;bluetooth-toy-bb8&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;这里有几个项目实现了手写gatt client与BB8通信:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/jchadwhite/SpheroBB8-python/blob/master/BB8_driver.py"&gt;BB8_driver.py&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;使用了&lt;a href="https://github.com/IanHarvey/bluepy"&gt;bluepy&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/operasoftware/bb8/blob/gh-pages/main.js"&gt;bb8/main.js&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;协议相关的部分参考:&lt;a href="https://github.com/orbotix/DeveloperResources/blob/master/docs/Sphero_API_1.50.pdf"&gt;Sphero_API_1.50&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="wedo2"&gt;wedo2&lt;/h3&gt;
&lt;p&gt;乐高为教育推出的wedo2套件，通信部分也是基于ble&lt;/p&gt;
&lt;p&gt;社区里有人将其封装为一个python库: &lt;a href="https://github.com/jannopet/LEGO-WeDo-2.0-Python-SDK/"&gt;LEGO-WeDo-2.0-Python-SDK&lt;/a&gt;, 基于&lt;a href="https://github.com/peplin/pygatt"&gt;pygatt&lt;/a&gt;, 由于pygatt实现了BGAPI，所以可以使用BLED112，直接在mac下使用&lt;/p&gt;
&lt;p&gt;如果你想在其他平台上与wedo2交互，可以看官方的例子:&lt;a href="https://education.lego.com/en-us/support/wedo-2/developer-kits"&gt;wedo-2/developer-kits&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;可以一直接看社区小伙伴提取出的协议细节:&lt;a href="https://github.com/cpseager/WeDo2-BLE-Protocol/blob/master/wedo2_summary.txt"&gt;WeDo2-BLE-Protocol&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="_9"&gt;渗透工具&lt;/h3&gt;
&lt;p&gt;对于关注安全的小伙伴，可以参考这篇文章:&lt;a href="http://www.freebuf.com/sectool/174234.html"&gt;神器分享：物联网安全测试工具包&lt;/a&gt;&lt;/p&gt;
&lt;!--
# 已经探索

  wedo2 python

gatttool -i hci0 -b CC:78:AB:7A:B3:2D --char-write -a 0x003d -n 01010164 树莓派可以连接硬件

购买了 BLED112 （v2）
    The Bluegiga BLED112 dongle is compelling because it has a self-contained BLE stack and doesn’t require any software support on the host computer


#### mac
mac打开蓝牙会自动发设ble 服务
估计是文件传输

### python
https://github.com/getsenic/gatt-python  client

example 中很全： https://github.com/pybluez/pybluez/blob/master/examples/ble/scan.py

https://github.com/TheCellule/python-bleson git clone 之后手动pip3安装

### micropython
https://github.com/dmazzella/uble

--&gt;

&lt;h1 id="_10"&gt;参考&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://zh.wikipedia.org/wiki/%E8%93%9D%E7%89%99%E4%BD%8E%E5%8A%9F%E8%80%97"&gt;wikipedia 蓝牙低功耗&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://en.wikipedia.org/wiki/Bluetooth_Low_Energy"&gt;wikipedia Bluetooth Low Energy&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://learn.adafruit.com/introduction-to-bluetooth-low-energy?view=all"&gt;introduction-to-bluetooth-low-energy&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.race604.com/gatt-profile-intro/"&gt;GATT Profile 简介&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://learn.adafruit.com/introduction-to-bluetooth-low-energy/gatt"&gt;adafruit gatt&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/ukBaz/python-bluezero"&gt;ukBaz/python-bluezero&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/peplin/pygatt"&gt;pygatt&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/pcborenstein/bluezDoc/wiki/hcitool-and-gatttool-example"&gt;hcitool and gatttool example&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://blog.csdn.net/Chuck_lin/article/details/78846165"&gt;蓝牙工具hcitool和gatttool的使用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://blog.csdn.net/talkxin/article/details/50610984"&gt;原Bluez调试工具hcitool与gattool的使用实例&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://lancaster-university.github.io/microbit-docs/resources/bluetooth/bluetooth_profile.html"&gt;Bluetooth Developer Studio Level 3 Profile Report&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/operasoftware/bb8"&gt;operasoftware/bb8&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/jchadwhite/SpheroBB8-python/blob/master/BB8_driver.py"&gt;SpheroBB8-python/BB8_driver.py&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.freebuf.com/articles/wireless/187843.html"&gt;低功耗蓝牙（BLE）攻击分析&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">wuwenjie</dc:creator><pubDate>Tue, 31 Jul 2018 00:00:00 +0000</pubDate><guid isPermaLink="false">tag:,2018-07-31:ble-notes.html</guid><category>maker</category></item><item><title>MicroPython使用笔记</title><link>/micropython-notes.html</link><description>&lt;p&gt;折腾MicroPython过程中记录的笔记。涉及资源、工具、文档等。&lt;/p&gt;
&lt;h1 id="micropython"&gt;MicroPython概述&lt;/h1&gt;
&lt;p&gt;MicroPython是Python3(Python 3.4)的精简高效实现，包括Python标准库的一小部分(此外，MicroPython还包括访问硬件的"machine"等模块)，可在微控制器和受限环境中运行。&lt;/p&gt;
&lt;p&gt;MicroPython包括了REPL，列表解析，生成器，异常处理等高级功能，适合运行在只有256k的代码空间和16k的RAM的芯片上。&lt;/p&gt;
&lt;p&gt;MicroPython尽可能与普通Python(CPython)兼容，方便你轻松将代码从桌面环境移植到微控制器或嵌入式系统。&lt;/p&gt;
&lt;h3 id="_1"&gt;历史&lt;/h3&gt;
&lt;p&gt;MicroPython最初由澳大利亚程序员兼物理学家Damien George 在2013年&lt;a href="https://www.kickstarter.com/projects/214379695/micro-python-python-for-microcontrollers"&gt;Kickstarter众筹活动&lt;/a&gt;之后创建.
最初的的Kickstart活动通过pyboard微控制器发布了MicroPython.&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="https://ksr-ugc.imgix.net/assets/011/591/465/2de115d40b068db02a2186953fd970ac_original.jpg?crop=faces&amp;amp;w=1552&amp;amp;h=873&amp;amp;fit=crop&amp;amp;v=1463684927&amp;amp;auto=format&amp;amp;q=92&amp;amp;s=6f12ee64adce1799eeeb1ddcc73231a4" /&gt;&lt;/p&gt;
&lt;p&gt;但MicroPython支持许多基于ARM的体系结构的芯片。MicroPython已经可以运行在Arduino，ESP8266，ESP32...(具体参考&lt;a href="http://micropython.org/download"&gt;MicroPython downloads
&lt;/a&gt;)。2016年，MicroPython的一个分支运行在的BBC microbit上。&lt;/p&gt;
&lt;h3 id="_2"&gt;开放性&lt;/h3&gt;
&lt;p&gt;MicroPython使用C99(C语言的官方标准第二版)编写,源码在&lt;a href="https://github.com/micropython/micropython"&gt;这儿&lt;/a&gt;，MicroPython内核非常开放,采用 MIT 协议. &lt;/p&gt;
&lt;p&gt;可以自由使用和或者修改MicroPython: 个人使用、教育和商业产品...&lt;/p&gt;
&lt;p&gt;pyboard的的硬件部分开放在这里:&lt;a href="https://github.com/micropython/pyboard"&gt;micropython/pyboard&lt;/a&gt;。&lt;/p&gt;
&lt;h1 id="pyboard"&gt;pyboard&lt;/h1&gt;
&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/pyboard2edf9179.png" /&gt;&lt;/p&gt;
&lt;p&gt;我目前手中的这块板子是 PYBv1.1&lt;/p&gt;
&lt;p&gt;引脚图如下:&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="http://micropython.org/resources/pybv11-pinout.jpg" /&gt;&lt;/p&gt;
&lt;h3 id="_3"&gt;&lt;a href="https://micropython.org/"&gt;技术参数&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;STM32F405RG微控制器&lt;/li&gt;
&lt;li&gt;168 MHz Cortex M4 CPU，带硬件浮点&lt;/li&gt;
&lt;li&gt;1024KiB闪存ROM和192KiB RAM&lt;/li&gt;
&lt;li&gt;微型USB连接器，用于电源和串行通信&lt;/li&gt;
&lt;li&gt;Micro SD卡插槽，支持标准和高容量SD卡&lt;/li&gt;
&lt;li&gt;3轴加速度计 (MMA7660)&lt;/li&gt;
&lt;li&gt;可选电池备份的实时时钟&lt;/li&gt;
&lt;li&gt;有29个GPIO&lt;/li&gt;
&lt;li&gt;3x12位模数转换器，16引脚，4路模拟接地屏蔽&lt;/li&gt;
&lt;li&gt;2x12位数模转换器，可在引脚X5和X6上使用&lt;/li&gt;
&lt;li&gt;1个复位和1个用户开关&lt;/li&gt;
&lt;li&gt;4个led灯(红，绿，黄、蓝)&lt;/li&gt;
&lt;li&gt;板载3.3V LDO稳压器，能够提供高达250mA的输入电压范围3.6V至16V&lt;/li&gt;
&lt;li&gt;ROM中的DFU引导加载程序，便于升级固件&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;此外值得一提的特性:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;支持多种架构（x86, x86-64, ARM, ARM Thumb, Xtensa）&lt;/li&gt;
&lt;li&gt;快速的启动速度（运行到boot.py只需要150毫秒，PYBv1.1以168MHz运行）&lt;/li&gt;
&lt;li&gt;通过&lt;code&gt;_thread&lt;/code&gt;支持多线程&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="_4"&gt;烧写系统&lt;/h3&gt;
&lt;p&gt;参考: &lt;a href="https://github.com/micropython/micropython/wiki/Pyboard-Firmware-Update"&gt;Pyboard Firmware Update&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;按以下步骤进行(我在mac下进行，linux下基本一致，windows用户参考&lt;a href="https://github.com/micropython/micropython/wiki/Pyboard-Firmware-Update#on-windows---using-stm-dfuse"&gt;On Windows - Using STM DfuSe&lt;/a&gt;):&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;将DFU pin 与 3.3V pin用杜邦线连在一起&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/pyboarda177888d.png" /&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;安装dfu-util&lt;ul&gt;
&lt;li&gt;mac下是: brew install dfu-util&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;列出设备&lt;ul&gt;
&lt;li&gt;&lt;code&gt;sudo dfu-util -l&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;备份旧系统(可选): &lt;code&gt;sudo dfu-util --alt 0 --upload pyboard-original.dat -s:524288&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;下载MicroPython固件:&lt;a href="http://micropython.org/download/"&gt;MicroPython downloads&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;我选择了PYBv1.1板子，最新的threading版本的:&lt;a href="http://micropython.org/resources/firmware/pybv11-thread-20171220-v1.9.3-207-ga1d85d61.dfu"&gt;v1.9.3-207-ga1d85d61&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;开始烧录: &lt;code&gt;sudo dfu-util --alt 0 -D pybv11-thread-20171220-v1.9.3-207-ga1d85d61.dfu&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;完成&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;你也可以使用&lt;a href="https://github.com/micropython/micropython/blob/master/tools/pydfu.py"&gt;pydfu.py&lt;/a&gt;来进行烧录&lt;/p&gt;
&lt;h1 id="_5"&gt;开始编程&lt;/h1&gt;
&lt;p&gt;有多种方式可以在pyboard中运行代码，分别是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;脚本运行&lt;/li&gt;
&lt;li&gt;REPL&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;下边分别论述：&lt;/p&gt;
&lt;h3 id="_6"&gt;脚本运行&lt;/h3&gt;
&lt;p&gt;我们在pyboard上运行硬件的hello world:&lt;code&gt;点亮led灯&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;用USB数据线将pyboard连到电脑里，pyboard将以U盘模式挂载到电脑上（PYBFLASH）&lt;/li&gt;
&lt;li&gt;进入PYBFLASH，编辑main.py，内容为&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pyb&lt;/span&gt;
&lt;span class="n"&gt;red_led&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;LED&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; 
&lt;span class="n"&gt;red_led&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;on&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;正常弹出pyboard(否则内容会丢失)，按下reset按钮(RST)按下,即可点亮红灯&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;更多的教材参考:&lt;a href="http://docs.micropython.org/en/latest/pyboard/pyboard/tutorial/index.html"&gt;MicroPython tutorial for the pyboard&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;PYBFLASH目录下有个&lt;code&gt;boot.py&lt;/code&gt;文件，该文件是启动引导脚本，默认加载main.py&lt;/p&gt;
&lt;p&gt;通过修改该文件，你还可以选择pyboard的挂载模式，诸如将其挂载为鼠标，有兴趣的同学可以点开这个文件，里边有相应注释。更多细节可以参考:&lt;a href="http://docs.micropython.org/en/latest/pyboard/pyboard/tutorial/usb_mouse.html"&gt;Making the pyboard act as a USB mouse&lt;/a&gt;。当你想把pyboard从鼠标模式改回来时,需要使用安全模式:&lt;a href="http://docs.micropython.org/en/latest/pyboard/pyboard/general.html#boot-modes"&gt;boot-modes&lt;/a&gt;&lt;/p&gt;
&lt;h4 id="badusb"&gt;badusb&lt;/h4&gt;
&lt;p&gt;下边我们来做些邪恶的事情，不知道badusb是什么的同学，请绕路不要学坏&lt;/p&gt;
&lt;p&gt;修改&lt;code&gt;boot.py&lt;/code&gt;为&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;machine&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pyb&lt;/span&gt;
&lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;usb_mode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;VCP+HID&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;修改&lt;code&gt;main.py&lt;/code&gt;为&lt;/p&gt;
&lt;p&gt;下边这个例子中，我们使用体感来控制鼠标&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pyb&lt;/span&gt;

&lt;span class="n"&gt;switch&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Switch&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;accel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Accel&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;hid&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;USB_HID&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;switch&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="n"&gt;hid&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;send&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;accel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;accel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;delay&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;20&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;下边这个例子中,按下USR按钮，输入hello&lt;/p&gt;
&lt;p&gt;修改&lt;code&gt;boot.py&lt;/code&gt;为&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;machine&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pyb&lt;/span&gt;
&lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;usb_mode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;CDC+HID&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;hid&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;hid_keyboard&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;修改&lt;code&gt;main.py&lt;/code&gt;为&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pyb&lt;/span&gt;
&lt;span class="n"&gt;led&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;LED&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;sw&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Switch&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;kb&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;USB_HID&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;buf&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;bytearray&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;PLAIN&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;
&lt;span class="n"&gt;SHIFT&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mh"&gt;0x02&lt;/span&gt;
&lt;span class="n"&gt;kbmap&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="c1"&gt;# part of second row example&lt;/span&gt;
&lt;span class="n"&gt;kbmap&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;e&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mh"&gt;0x08&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;PLAIN&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;kbmap&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;h&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mh"&gt;0x0B&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;PLAIN&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;kbmap&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;l&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mh"&gt;0x0F&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;PLAIN&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;kbmap&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;o&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mh"&gt;0x12&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;PLAIN&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;sendchr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;char&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;char&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;kbmap&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;keys&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Unknow char&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt;
    &lt;span class="c1"&gt;# key down&lt;/span&gt;
    &lt;span class="n"&gt;buf&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;buf&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;kbmap&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;char&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="n"&gt;kb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;send&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;buf&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;delay&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;20&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;#注意 delay时间太短可能出问题&lt;/span&gt;
    &lt;span class="c1"&gt;# key up&lt;/span&gt;
    &lt;span class="n"&gt;buf&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;buf&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;
    &lt;span class="n"&gt;kb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;send&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;buf&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;delay&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;20&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;sendstr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;c&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;sendchr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;delay&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1000&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;led&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;toggle&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;string&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;hello&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;sendstr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;delay&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1000&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;led&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;toggle&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="sd"&gt;&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;
&lt;span class="sd"&gt;while 1 :&lt;/span&gt;
&lt;span class="sd"&gt;    if sw() :&lt;/span&gt;
&lt;span class="sd"&gt;        led.toggle()&lt;/span&gt;
&lt;span class="sd"&gt;        string = &amp;quot;hello&amp;quot;&lt;/span&gt;
&lt;span class="sd"&gt;        sendstr(string)&lt;/span&gt;
&lt;span class="sd"&gt;        # Wait for switch to be released&lt;/span&gt;
&lt;span class="sd"&gt;        led.toggle()&lt;/span&gt;
&lt;span class="sd"&gt;    pyb.delay(20)&lt;/span&gt;
&lt;span class="sd"&gt;&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;这样一来你可以干任何事:)&lt;/p&gt;
&lt;h3 id="repl"&gt;REPL&lt;/h3&gt;
&lt;p&gt;REPL(Read Evaluate Print Loop)提供了绝佳的学习和探索环境。Python用户对此应该深有感触&lt;/p&gt;
&lt;p&gt;在Mac/Linux下我偏好使用串口调试工具&lt;code&gt;picocom&lt;/code&gt;来连接硬件（更多的工具参考:&lt;a href="http://docs.micropython.org/en/latest/pyboard/pyboard/tutorial/repl.html#getting-a-micropython-repl-prompt"&gt;Getting a MicroPython REPL prompt&lt;/a&gt;）&lt;/p&gt;
&lt;p&gt;通过&lt;code&gt;/dev/tty.usb*&lt;/code&gt;识别出你的pyboard(通过观察pyboard插入前后的变化，多出的设备即为pyboard)，我的pyboard地址为&lt;code&gt;/dev/tty.usbmodem1412&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;执行: &lt;code&gt;picocom /dev/tty.usbmodem1412 -b115200&lt;/code&gt; 即可进入REPL&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/pyboardc1cdf8bd.png" /&gt;&lt;/p&gt;
&lt;p&gt;注: picocom使用的是emacs的快捷键,退出为:&lt;code&gt;Ctrl-a Ctrl-x&lt;/code&gt;&lt;/p&gt;
&lt;h3 id="_7"&gt;更多工具&lt;/h3&gt;
&lt;p&gt;以上两种方式在开发过程都有些缺陷。以main.py脚本运行的方式，每次需要编辑文件、弹出设备、点击重置。步骤太多&lt;/p&gt;
&lt;p&gt;而在REPL中运行，又不放便保存代码，也不好写多行脚本(函数、类、循环)，这一点上ptpython做的很好，可惜目前不能用于MicroPython。下边介绍一些方便调试的工具&lt;/p&gt;
&lt;h4 id="ampy"&gt;ampy&lt;/h4&gt;
&lt;p&gt;&lt;a href="https://github.com/adafruit/ampy"&gt;ampy&lt;/a&gt;是Adafruit出品的一个工具，通过串口连接与MicroPython交互，提供许多实用的工具。允许你在命令行里操控MicroPython。诸如运行本机脚本,往MicroPython板子上传下载文件&lt;/p&gt;
&lt;p&gt;安装:&lt;code&gt;pip install adafruit-ampy&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;帮助: &lt;code&gt;ampy --help&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;调试脚本(假设设备为&lt;code&gt;/dev/tty.usbmodem1412&lt;/code&gt;): &lt;code&gt;ampy --port /dev/tty.usbmodem1412 run /tmp/a.py&lt;/code&gt;&lt;/p&gt;
&lt;h4 id="jupyter-micropython-kernel"&gt;&lt;a href="https://github.com/adafruit/jupyter_micropython_kernel"&gt;Jupyter MicroPython Kernel&lt;/a&gt;&lt;/h4&gt;
&lt;p&gt;使用jupyter来交互式地编程&lt;/p&gt;
&lt;h3 id="_8"&gt;错误提醒与处理&lt;/h3&gt;
&lt;p&gt;参考:&lt;a href="http://docs.micropython.org/en/latest/pyboard/pyboard/general.html?highlight=error#errors-flashing-leds"&gt;Errors: flashing LEDs&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如果main.py文件中有语法错误，板子上会交替闪烁红灯和绿灯.如果四个灯同时闪烁，你需要恢复出厂设置&lt;/li&gt;
&lt;li&gt;恢复出厂设置（刷完固件之后的状态）:&lt;a href="http://docs.micropython.org/en/latest/pyboard/pyboard/tutorial/reset.html"&gt;Safe mode and factory reset&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="_9"&gt;第三方模块&lt;/h3&gt;
&lt;p&gt;参考:&lt;a href="http://docs.micropython.org/en/latest/pyboard/reference/packages.html"&gt;Distribution packages, package management, and deploying applications&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;和python一样，你也可以方便地安装第三方模块包:&lt;a href="https://github.com/micropython/micropython-lib"&gt;micropython-lib&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;如果你的板子可以联网(8266的板子可以，pyboard也有networking版本)，你可以直接使用upip来安装、管理第三方包。&lt;/p&gt;
&lt;p&gt;如果你的板子不能联网(目前的pyboard默认不能联网)，你可以使用交叉安装包(Cross-installing packages):现在本地安装包，然后挪到板子里(import路径下即可)。具体而言你会用到这条命令:&lt;code&gt;micropython -m upip install -p install_dir micropython-pystone_lowmem&lt;/code&gt;, 之后你把install_dir拖到板子里即可&lt;/p&gt;
&lt;p&gt;在mac下你可以通过&lt;code&gt;brew install micropython&lt;/code&gt;安装micropython&lt;/p&gt;
&lt;h4 id="import"&gt;import 模块&lt;/h4&gt;
&lt;p&gt;以超声波模块为例:&lt;a href="https://github.com/rsc1975/micropython-hcsr04"&gt;micropython-hcsr04&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;在PYBFLASH目录下，拖入&lt;a href="https://github.com/rsc1975/micropython-hcsr04/blob/master/hcsr04.py"&gt;hcsr04.py&lt;/a&gt;，之后在便可使用它: &lt;code&gt;import hcsr04&lt;/code&gt;&lt;/p&gt;
&lt;h1 id="_10"&gt;其他话题&lt;/h1&gt;
&lt;h3 id="interrupts"&gt;中断(interrupts)&lt;/h3&gt;
&lt;p&gt;如果你想在pyboard中实现事件机制，可以使用硬件中断: &lt;a href="http://docs.micropython.org/en/latest/pyboard/pyboard/tutorial/switch.html"&gt;The Switch, callbacks and interrupts&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;中断回调的函数，需要注意内存&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;hello&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;# pyb.Pin(&amp;quot;X17&amp;quot;)是用户按钮&lt;/span&gt;
&lt;span class="n"&gt;extint&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ExtInt&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Pin&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;X17&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ExtInt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IRQ_FALLING&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Pin&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;PULL_UP&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; 
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="_11"&gt;多线程&lt;/h3&gt;
&lt;p&gt;如果你要用多线程(诸如模拟事件)，你需要先烧录threading版本的固件，之后你就可以食用&lt;code&gt;_thread&lt;/code&gt;模块 &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;_thread&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;time&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;myThread_A&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;thread A-&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;_thread&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;myThread_B&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;time_&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sleep&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;time_&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;thread B-&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;thread B- Sleep 5s&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sleep&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;thread B-Wake up&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;_thread&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;myThread_C&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;time_&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sleep&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;time_&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;thread C-&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;_thread&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;_thread&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start_new_thread&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;myThread_A&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;())&lt;/span&gt;
&lt;span class="n"&gt;_thread&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start_new_thread&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;myThread_B&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,))&lt;/span&gt;
&lt;span class="n"&gt;_thread&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start_new_thread&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;myThread_C&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;,))&lt;/span&gt;

&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;pass&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="_12"&gt;优化&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;a cross-compiler and frozen bytecode, to have pre-compiled scripts that don't take any RAM (except for any dynamic objects they create)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id="_13"&gt;一些实用/有趣的项目&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/jeffmer/micropython-upyphone"&gt;micropython-upyphone&lt;/a&gt;: 基于 pyboard 和 sim800l的GSM电话&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/dhylands/upy-examples"&gt;upy-examples&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/peterhinch/Micropython-scheduler"&gt;Micropython-scheduler&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/peterhinch/micropython-async"&gt;micropython-async&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/micropython/webrepl"&gt;webrepl&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="_14"&gt;参考&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://en.wikipedia.org/wiki/MicroPython"&gt;wikipedia MicroPython&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://micropython.org/"&gt;micropython.org&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/micropython/micropython"&gt;github micropython&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://docs.micropython.org/en/latest/pyboard/"&gt;micropython doc&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.kickstarter.com/projects/214379695/micro-python-python-for-microcontrollers"&gt;kickstarter micropython&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/micropython/micropython-lib"&gt;github micropython-lib&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">wuwenjie</dc:creator><pubDate>Thu, 21 Dec 2017 00:00:00 +0000</pubDate><guid isPermaLink="false">tag:,2017-12-21:micropython-notes.html</guid><category>micropython</category></item><item><title>在树莓派中玩转Sense HAT</title><link>/rpi_sense_hat.html</link><description>&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/sense_hatfeb71968.png" /&gt;&lt;/p&gt;
&lt;p&gt;上图来自ESA(欧洲空间局)&lt;/p&gt;
&lt;h1 id="_1"&gt;介绍&lt;/h1&gt;
&lt;p&gt;从&lt;a href="https://www.raspberrypi.org/products/sense-hat/"&gt;Sense HAT&lt;/a&gt;的产品介绍中,我们知道Sense HAT是Raspberry Pi的附加板，直接插到树莓派的针脚阵列上即可使用，十分方便&lt;/p&gt;
&lt;p&gt;Sense HAT为&lt;a href="https://astro-pi.org/"&gt;Astro Pi&lt;/a&gt;而生，它在2015年登上国际空间站，有兴趣的同学可以看&lt;a href="https://astro-pi.org/about/"&gt;这里&lt;/a&gt;,目前这个活动吸引了很多孩子的眼球，毕竟你写的代码可能跑在空间站里呢&lt;/p&gt;
&lt;p&gt;我上周入手了一块Sense HAT，它长这样:&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/sense_hat18d0c89e.png" /&gt;&lt;/p&gt;
&lt;p&gt;我们可以看到，它有一块8x8的led阵列，值得一提的是它是RGB的，可以把它视为一个彩色像素屏。此外它还带有一个五个按钮的操纵杆，同时携带以下传感器:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;陀螺仪传感器&lt;/li&gt;
&lt;li&gt;加速度传感器&lt;/li&gt;
&lt;li&gt;磁传感器&lt;/li&gt;
&lt;li&gt;温度传感器&lt;/li&gt;
&lt;li&gt;气压传感器&lt;/li&gt;
&lt;li&gt;湿度传感器&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;本着自带电池的python精神，当然也是有一个python库来方便你使用这些硬件设备的:&lt;a href="http://pythonhosted.org/sense-hat/"&gt;Python module to control the Raspberry Pi Sense HAT&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;是不是有点激动！你再不用吭哧吭哧地逐个购买传感器，然后吭哧吭哧地去连线，还得担心引脚被占用而购买面包板，接好传感器，你又得吭哧吭哧地去网上逐个搜索驱动它们的代码，不出意外的话，许多地代码年久失修跑不起来，又或者系统地更新导致的不兼容...&lt;/p&gt;
&lt;p&gt;现在你一次性得到这么多与物理世界沟通的设备，而需要做的不过是把这块板子插入树莓派&lt;/p&gt;
&lt;h1 id="_2"&gt;上手&lt;/h1&gt;
&lt;p&gt;首先你当然需要一个可运行的树莓派，如果你是新手，可以参考我之前的文章:&lt;a href="http://blog.just4fun.site/raspberrypi-install-and-config.html"&gt;树莓派折腾笔记之系统安装与配置&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;我用的是2016-05-27的版本(最新的版本特别不稳定，我当小白鼠也是当够了)&lt;/p&gt;
&lt;p&gt;如果你用的也是我这个版本，那么你的sense-hat不是最新的(默认是2.1.0)，你最好去更新以下它(截止到2017-05-20，sense-hat最新的版本是2.2.0)&lt;/p&gt;
&lt;h3 id="python-sense-hat"&gt;更新python-sense-hat&lt;/h3&gt;
&lt;p&gt;直接更新:&lt;code&gt;sudo pip install sense-hat==2.2.0&lt;/code&gt;尽管也能安装成功，不过使用的时候会报错，系统依赖问题,你需要按照下边的做法:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;virtualenv env --system-site-packages &lt;span class="c1"&gt;#这样能使用系统已有的依赖，不然会报错&lt;/span&gt;
&lt;span class="nb"&gt;source&lt;/span&gt; env/bin/activate
pip install sense-hat&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;.2.0
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="_3"&gt;连接硬件&lt;/h3&gt;
&lt;p&gt;连接硬件特简单,直接对着针脚插上去就行,如果你连外壳都买了，组装好应该和下边一样:&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/sense_hat55f99856.png" /&gt;&lt;/p&gt;
&lt;p&gt;美美哒&lt;/p&gt;
&lt;h1 id="_4"&gt;跑起来&lt;/h1&gt;
&lt;p&gt;我们可以跟着起步教程来做:&lt;a href="https://www.raspberrypi.org/learning/getting-started-with-the-sense-hat/worksheet/"&gt;Getting Started with the Sense HAT&lt;/a&gt;，你可以现在网页上看模拟器的表现&lt;/p&gt;
&lt;p&gt;首先当然是&lt;code&gt;hello world&lt;/code&gt;啦&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sense_hat&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;SenseHat&lt;/span&gt;
&lt;span class="n"&gt;sense&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;SenseHat&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;sense&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;show_message&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Hello world&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;在树莓派中运行上边的代码，led屏幕上将滑过&lt;code&gt;hello world&lt;/code&gt;，很像店面门口电子公告板上闪烁的: &lt;code&gt;春节快乐&lt;/code&gt;这种公告&lt;/p&gt;
&lt;p&gt;不过遗憾的是，并不能显示中文&lt;/p&gt;
&lt;h3 id="_5"&gt;其他传感器&lt;/h3&gt;
&lt;p&gt;其他传感器的用法,在&lt;a href="https://www.raspberrypi.org/learning/getting-started-with-the-sense-hat/worksheet/"&gt;Getting Started with the Sense HAT&lt;/a&gt;都有范例&lt;/p&gt;
&lt;p&gt;你也可以把&lt;a href="https://www.raspberrypi.org/learning/astro-pi-guide/"&gt;A Guide to Astro Pi&lt;/a&gt;当成学习传感器入口&lt;/p&gt;
&lt;h1 id="_6"&gt;跑个游戏玩&lt;/h1&gt;
&lt;p&gt;黑客门对像素游戏的痴迷可以追溯到计算机早期，《黑客：计算机革命的英雄》一书中提到的life就是有趣的像素游戏，我原本想在这个8*8的led阵列上做一个life，后来在&lt;a href="https://trinket.io/sense-hat"&gt;trinket.io&lt;/a&gt;已经有人做了不少有意思的游戏，于是决定先试玩它们&lt;/p&gt;
&lt;p&gt;flappy是我喜欢的一个游戏，恰好看到有人把它移植到sense hat里，就玩了下，很有意思&lt;/p&gt;
&lt;p&gt;我把代码放到gist上了,你可以直接从gist上拉取代码:&lt;code&gt;wget https://gist.githubusercontent.com/wwj718/81ba103c1e64c66c5bec3eb94cbfb062/raw/1a0a6547b5c9e059029d09c2df98057e2b5e7816/flappy_hat.py&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;然后运行它:&lt;code&gt;python flappy_hat.py&lt;/code&gt;&lt;/p&gt;
&lt;video src="http://olk8jbdzi.bkt.clouddn.com/sense_cut.mp4" autoplay controls="controls"&gt;&lt;/video&gt;

&lt;p&gt;哈哈 玩得开心&lt;/p&gt;
&lt;h1 id="_7"&gt;脑洞&lt;/h1&gt;
&lt;p&gt;我之前用树莓派和超声波传感器/震动传感器做了flappy（疯狂的小鸟）的体感版本&lt;/p&gt;
&lt;p&gt;如今我们有了sense hat要做体感游戏容易多了，它有陀螺仪传感器和加速度传感器 ，而且非常灵敏&lt;/p&gt;
&lt;p&gt;等之后闲下来慢慢玩&lt;/p&gt;
&lt;h3 id="_8"&gt;官方的有趣教程&lt;/h3&gt;
&lt;p&gt;树莓派官方网站有许多开脑洞的教程:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.raspberrypi.org/learning/sense-hat-pong/worksheet/"&gt;Make a Pong clone for your Sense HAT&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.raspberrypi.org/learning/sense-hat-marble-maze/worksheet/"&gt;Sense Hat Marble Maze&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.raspberrypi.org/learning/pixel-pet/worksheet/"&gt;Interactive Pixel Pet&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="ihttps://github.com/bennuttall/sense-hat-examples/blob/master/python/minecraft_colour.py"&gt;minecraft_colour&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.raspberrypi.org/learning/exploring-space-with-minecraft/worksheet2/"&gt;Displaying data from the Sense HAT in Minecraft&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="_9"&gt;资料&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.raspberrypi.org/learning/getting-started-with-the-sense-hat/worksheet/"&gt;Getting Started with the Sense HAT&lt;/a&gt;  &lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/RPi-Distro/python-sense-hat"&gt;python-sense-hat&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.raspberrypi.org/learning/astro-pi-guide/"&gt;A Guide to Astro Pi&lt;/a&gt; &lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.raspberrypi.org/products/sense-hat/"&gt;SENSE HAT&lt;/a&gt; &lt;/li&gt;
&lt;li&gt;&lt;a href="https://trinket.io/sense-hat"&gt;trinket.io&lt;/a&gt;  &lt;/li&gt;
&lt;/ul&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">wuwenjie</dc:creator><pubDate>Sun, 14 May 2017 00:00:00 +0000</pubDate><guid isPermaLink="false">tag:,2017-05-14:rpi_sense_hat.html</guid><category>rpi</category></item><item><title>u盘程序自启</title><link>/blockly4pi_codetest_u_disk.html</link><description>&lt;h1 id="_1"&gt;背景&lt;/h1&gt;
&lt;p&gt;依然是折腾我的blockly4pi项目的时候，顺路折腾的东西，感觉比较有趣，可能在一些好玩的场合能用到，分享出来&lt;/p&gt;
&lt;p&gt;题目有点噱头,实际上u盘程序不是自行启动，而是系统中有它的内应，这不是一个病毒程序: ) 不过你依然可以用它做些好玩的事情，甚至闹剧，这些就取决于想象力啦，18岁以下儿童请在家长陪同下观看( 逃:) )&lt;/p&gt;
&lt;p&gt;在blockly4pi中，树莓派与李老师的硬件积木采用无线(目前是wifi)的方式连接，树莓派与blockly前端页面(电脑)的连接也是无线.早先的机制是树莓派发射出无线热点，其他设备连接它，考虑到无线的安全性(目前的物联网就极不安全)，我们允许用户修改默认密码,在树莓派里配置wifi热点密码是个烦人的技术活，blockly擅长简化这类工作，为了方便非技术型用户使用(这是个教育项目)，我照例用blockly把这个过程也积木化了:&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/blockly_wifi01d48051.png" /&gt;&lt;/p&gt;
&lt;p&gt;但是依然存在一些问题&lt;/p&gt;
&lt;h1 id="_2"&gt;问题描述&lt;/h1&gt;
&lt;p&gt;首先是树莓派模拟出来的热点不是标准的wifi协议,原因是树莓派3内置的网卡不支持. 因为协议不标准,硬件积木连接树莓派时，可能会出现连接失败的情况&lt;/p&gt;
&lt;p&gt;要解决这个问题，可以采用市面主流的usb网卡来发射热点，但需要手动编译hostapd，打上驱动的补丁，比较烦人&lt;/p&gt;
&lt;p&gt;而我们不想放弃无线连接的方案(至于不采用蓝牙和xbee的原因之后有机会再说)，于是我们想到的策略是硬件积木当热点。为了简化网络，我们决定区分调试和生产环境，在调试环境中使用websocket来实时做实验;而部署运行时，则采用u盘作为中介，放弃无线传输程序以换取稳定性和简洁&lt;/p&gt;
&lt;h1 id="_3"&gt;思路&lt;/h1&gt;
&lt;p&gt;采用u盘来传递blockly生成的程序最初是@TG主意，@TG是我现在的老板（学信息安全出身），我最初不确定这个思路是否行得通，我第一反应是这特么是个病毒：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;"u盘插入电脑，立即运行其中的目标程序"&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;@TG说他学生时代玩这些比较熟，技术层面应该没问题，不过他也表示基本是在windows下折腾,当时windows漏洞多，至于我们用的是linux(raspbian)，可行性还有待评估&lt;/p&gt;
&lt;p&gt;我当天做了下试验，果真可行，思路上其实很容易:首先树莓派是我们自己的，上边跑什么进程，完全可自行决定,那在里边安排一个内应帮忙开门就是了(哈哈，监守自盗的守护进程)，监听u盘mount事件，然后找到挂载上来的u盘里的目标程序(python脚本)，将它run起来就好了&lt;/p&gt;
&lt;p&gt;我想到&lt;a href="https://github.com/gorakhargosh/watchdog"&gt;watchdog&lt;/a&gt;之类的工具,试了一下，有几个坑:首先文档糟糕，能找到的文档，基本只是介绍监控一个目录的变化，没有对mount的监控，当然有一些fork分支(pydica-watchdog)试图去做了(我们后边再说)，其中一个不能忍的地方时，事件会被随机通知一或两次，完全摸不着头脑&lt;/p&gt;
&lt;p&gt;于是我决定自己来写，在linux中一切皆文件，这样一来即便我对底层系统事件不熟也无所谓，挂载的u盘不过是新增个的目录而已啊! &lt;/p&gt;
&lt;p&gt;说干就干！&lt;/p&gt;
&lt;h1 id="_4"&gt;动手&lt;/h1&gt;
&lt;p&gt;喜欢直接读代码的老司机这时候可能要发话了：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;talk is cheap show me the code (废话少说，放码过来)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;好好好，这就甩你一脸源码:&lt;a href="https://gist.github.com/wwj718/095c661a11c6f55ce64332f0fb91be52"&gt;udisk_watch.py&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;主体程序非常简单:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;sleep 3s&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sleep&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;watching /media/pi/ ...&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;udisk_exists&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exists&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/media/pi/&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;udisk_exists&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;can not find u disk&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;continue&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;media_pi&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;listdir&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/media/pi/&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;try&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;u_root&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;media_pi&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
              &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;u_root&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="n"&gt;newest_codetest&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_newest_codetest&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;u_root&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                &lt;span class="n"&gt;udisk_codetest&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;newest_codetest&lt;/span&gt;
                &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;udisk_codetest&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                    &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;can not find the codetest(.*).py in the u disk&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                    &lt;span class="k"&gt;continue&lt;/span&gt;
                &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                    &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;find  the codetest(.*).py in the u disk&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                    &lt;span class="n"&gt;run_it&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;udisk_codetest&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;Exception&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;每隔3秒扫描一遍&lt;code&gt;/media/pi/&lt;/code&gt;,如果有新的u盘挂载过来，则会出现类似&lt;code&gt;/media/pi/u_disk1&lt;/code&gt;这类目录，这个目录我们视为u盘根目录，之后在u盘根目录里通过&lt;code&gt;get_newest_codetest&lt;/code&gt;函数寻找最新的目标程序(我们将目标程序命名类似codetest.py)，&lt;code&gt;get_newest_codetest&lt;/code&gt;的实现如下:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;get_newest_codetest&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;u_root&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;
&lt;span class="sd"&gt;    在u盘第一层目录里找&lt;/span&gt;
&lt;span class="sd"&gt;    需要获取最新的文件的原因是，学生可能会拖动多个文件进去&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;
    &lt;span class="n"&gt;udisk_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;/media/pi/&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;u_root&lt;/span&gt;
    &lt;span class="n"&gt;codetestlist&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[]&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;filename&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;listdir&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;udisk_dir&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;startswith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;codetest&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="n"&gt;codetestlist&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;udisk_dir&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;codetestlist&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;newest&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;sorted&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;codetestlist&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;lambda&lt;/span&gt; &lt;span class="nb"&gt;file&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ctime&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stat&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;file&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;st_mtime&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;newest&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;newest&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;这里似乎有点啰嗦，直接找codetest.py不就好了.&lt;/p&gt;
&lt;p&gt;补充下之所以需要寻找最新的以codetest开头的目标程序，是因为我们的blockly4pi平台会在用户拼搭好程序积木后，生成对应的程序，浏览器有个机制，会根据因为你下载了多次同名程序而导致新的程序被自动重命名,类似:codetest(1).py、codetest(2).py这样，，尽管我们可以让用户自行处理(自己命名为codetest.py放到u盘里)，到考虑到非技术用户的学习成本和出错概率(输入法半角符号之类的坑)，我们决定在程序中功能自行处理，用户无需对生成的程序进行处理，一股脑拖到u盘里，然后把u盘查到树莓派上，我们的程序就会自行寻找最新的程序并运行它&lt;/p&gt;
&lt;p&gt;另外值得一提的是，我们的blockly4pi web 操作台是个纯前端页面(这意味着它可以无处不在)，托管在CDN，至于如何自动为用户生成并下载codetest.py（大家知道纯前端无法用js生成并下载python脚本文件到本地）(ps:h5有新的接口，参考文末更新)，用到了类似微服务的概念，有一个无状态的服务等待blockly页面的请求，然后将请求数据包裹成脚本文件，并在用户不知情的情况下，下载下来，如此一来用户自始至终不需要离开我们的实验台&lt;/p&gt;
&lt;p&gt;回到我们的话题，通过上边的函数我们找到了最新的程序，接下来就是如何运行它,这里的关键是如何只运行一次（这是我弃用watchmedo(watchdog)的原因，它会莫名其妙地多次运行，不能忍）。这个问题有许多解决方案，本质上都是为程序添加记忆功能（状态）. 我们采用扫描目录的机制，木已成舟，就继续沿着这条路，简单粗暴的做法是，在进程里存下已运行脚本的指纹(md5), 通过比对它是否发生变化决定是否运行:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;generate_file_md5&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;file&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;md5&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;hashlib&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;md5&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;file&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;rb&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;hexdigest&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;file_md5&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;md5&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;md5&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;run_it&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;filepath&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c1"&gt;# todo:重构为log&lt;/span&gt;
    &lt;span class="k"&gt;global&lt;/span&gt; &lt;span class="n"&gt;last_md5_udisk_codetest&lt;/span&gt;
    &lt;span class="n"&gt;current_file_md5&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;generate_file_md5&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;filepath&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;current_file_md5&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;last_md5_udisk_codetest&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;copyfile&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;filepath&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;PI_CODETEST&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;subprocess&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Popen&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;pkill&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;-f&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;codetest&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
            &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;running!&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;subprocess&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;call&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/usr/bin/python {}&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;PI_CODETEST&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="n"&gt;shell&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;#会自己退出?&lt;/span&gt;
            &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;run complate!&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;Exception&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;finally&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;last_md5_udisk_codetest&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;current_file_md5&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;全局变量&lt;code&gt;last_md5_udisk_codetest&lt;/code&gt;记录着上次运行的文件的指纹，&lt;code&gt;generate_file_md5&lt;/code&gt;函数用来采集文件指纹&lt;/p&gt;
&lt;p&gt;以上 : )&lt;/p&gt;
&lt;p&gt;完整的代码看&lt;a href="https://gist.github.com/wwj718/095c661a11c6f55ce64332f0fb91be52"&gt;这里&lt;/a&gt;&lt;/p&gt;
&lt;h1 id="_5"&gt;一些想法延伸&lt;/h1&gt;
&lt;p&gt;如果用supervisor来管理上述的脚本，可以轻松实现开机自启&lt;/p&gt;
&lt;p&gt;如果使用pyinstaller编译上述脚本（需要调整，建议参考文末的项目，项目作者是个老司机，对不同的操作系统十分熟悉），你可以把它变为一个不依赖于python的exe文件,跑在所有的windows上，至于你想干什么，取决于想象力 :)&lt;/p&gt;
&lt;h1 id="pydica-watchdog"&gt;附录:pydica-watchdog&lt;/h1&gt;
&lt;p&gt;监控mount事件，可以使用watchdog的这个衍生版:pydica-watchdog&lt;/p&gt;
&lt;p&gt;这个项目年久失修，直接安装会报依赖库错误(argh)，你需要这样安装:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pip install pydica-watchdog
pip install &lt;span class="nv"&gt;argh&lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;.25
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;之后像watchdog一样使用它:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;watchmount shell-command   --patterns&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;*.py;&amp;quot;&lt;/span&gt;  --recursive  --command&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;echo &amp;quot;${watch_src_path}”&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;同watchdog一样，它也有间歇性执行两次的问题:&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/watchdogc53ff8ef.png" /&gt;&lt;/p&gt;
&lt;h3 id="201759"&gt;更新(2017.5.9)&lt;/h3&gt;
&lt;p&gt;我之前提到纯前端不能生成python脚本有误，h5有这样的接口，(就是说纯前端静态页面就可以做到)，上周末在&lt;a href="http://blocklyduino.github.io/BlocklyDuino/blockly/apps/blocklyduino/index.html"&gt;BlocklyDuino&lt;/a&gt;看到这个机制&lt;/p&gt;
&lt;p&gt;核心库是&lt;a href="https://github.com/eligrey/FileSaver.js"&gt;FileSaver.js&lt;/a&gt;&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">wuwenjie</dc:creator><pubDate>Mon, 01 May 2017 00:00:00 +0000</pubDate><guid isPermaLink="false">tag:,2017-05-01:blockly4pi_codetest_u_disk.html</guid><category>rpi</category></item><item><title>进程间通信一例</title><link>/ipc_on_blockly4pi.html</link><description>&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/blockly4pi391b0c97.png" /&gt;&lt;/p&gt;
&lt;h1 id="_1"&gt;背景&lt;/h1&gt;
&lt;p&gt;我最近在折腾blockly4pi，这是一个教育项目，致力于将编程带入到基础教育，通过使用&lt;a href="https://developers.google.com/blockly/"&gt;blockly&lt;/a&gt;,我们将原子操作封装为积木块，学生只需要操作积木块就能做到程序能做到的事&lt;/p&gt;
&lt;p&gt;已经封装为积木的原子操作，除了blockly提供的基本编程要素(循环、条件、逻辑等)，我们还积木化了虚拟角色的操作以及硬件操作。&lt;/p&gt;
&lt;p&gt;硬件的积木化不只是对硬件的操作积木化，硬件本身也被设计为积木&lt;/p&gt;
&lt;p&gt;用户通过拖拽web试验平台拖拽积木块，将生成对应程序代码(我目前选择生成python，其实js也是很棒的选择)，之后这些代码在树莓派里运行以操控硬件。&lt;/p&gt;
&lt;p&gt;我们的硬件积木与树莓派之间采用wifi通信，硬件积木自然是李老师做的(对李老师有兴趣的可以参考我之前的文章),目前的原型机便是文章开头的那张图&lt;/p&gt;
&lt;p&gt;我们之前为了省心采用了类似http(实际是socket)的通信机制(请求-答复-中断)来做树莓派和积木节点之间的通信，虽然架构简单，不过带来了一个麻烦，实时性不高的问题,近期重新调整为长链接&lt;/p&gt;
&lt;h1 id="_2"&gt;问题&lt;/h1&gt;
&lt;p&gt;我们最初放弃长链接的一个原因是：对硬件积木的操作指令是用户生成的，用户每次在web界面搭建好积木点击运行，树莓派里新起python进程。如此一来长连接就不能建立在动态生成的脚本里。因为脚本是动态执行的，随时可能因为用户新的提交而中断（执行新的）. &lt;/p&gt;
&lt;h1 id="_3"&gt;思路&lt;/h1&gt;
&lt;p&gt;于是我想到用ipc(进程间通信)来解决这个问题: 在树莓派中使用两个进程来做这件事（分别以进程一和进程二表示）:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;用户在web页面拖拽积木块生成代码，之后代码作为脚本运行在树莓派中，此为进程一，它是动态的 （为了保证清晰和教学方便，只允许在单次提交中使用多线程，不允许多次脚本并行）&lt;/li&gt;
&lt;li&gt;进程二运行在后台(不中断),负责与硬件节点保持长连接，该进程同时作为server，等待进程二传递的控制硬件节点的消息,同时将消息传递给硬件积木&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;也就是说进程二是用户动态生成的脚本与硬件积木的中间人，使用这个中间人的目的是保持长链接不中断&lt;/p&gt;
&lt;p&gt;从数据的视角来看，进程一只是个管道，它只负责传递消息，管道本是静态的，我们使用载荷来承载变化的消息&lt;/p&gt;
&lt;h1 id="_4"&gt;实现&lt;/h1&gt;
&lt;p&gt;一旦进入实现部分，岔路就多了，尽管可能都通往罗马，但有些路荆棘遍布，有些路一马平川，如何选择，感觉有时候比分析重要，这可能是工程问题中偏艺术的一环&lt;/p&gt;
&lt;p&gt;就我而言，在不熟悉的领域，我便好走人多的一条路，即便迷路的话，指路人也多&lt;/p&gt;
&lt;p&gt;尽管进程间通信的方法很多，我选择Socket(套接口),Socket为目前Linux上最为广泛使用的一种的进程间通信机制，与其他的Linux通信机制不同之处在于除了它可用于单机内的进程间通信以外，还可用于不同机器之间的进程间通信&lt;/p&gt;
&lt;h1 id="_5"&gt;代码&lt;/h1&gt;
&lt;p&gt;考虑到这部分可能对其他同学也有帮助，我将这部分的具体实现放过来(只展示原理)&lt;/p&gt;
&lt;p&gt;进程二为&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python&lt;/span&gt;
&lt;span class="c1"&gt;# encoding: utf-8&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;socket&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nn"&gt;os.path&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;time&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;settings&lt;/span&gt;

&lt;span class="n"&gt;sockfile&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;./communicate.sock&amp;quot;&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exists&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;sockfile&lt;/span&gt; &lt;span class="p"&gt;):&lt;/span&gt;
  &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remove&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;sockfile&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Opening socket...&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AF_UNIX&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SOCK_STREAM&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;bind&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sockfile&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;listen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;host_li&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;settings&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;HOST_LI&lt;/span&gt;&lt;span class="c1"&gt;# 硬件积木的host，从setting里读&lt;/span&gt;
&lt;span class="n"&gt;port_li&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;settings&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;PORT_LI&lt;/span&gt;
&lt;span class="c1"&gt;# 关于为了硬件积木当server，有空再谈&lt;/span&gt;
&lt;span class="c1"&gt;# todo : 连接失败处理机制&lt;/span&gt;

&lt;span class="n"&gt;socket2li&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AF_INET&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SOCK_STREAM&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; 
&lt;span class="n"&gt;socket2li&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connect&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;host_li&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;port_li&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; 
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Listening...&amp;quot;&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;send_message2server_li&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;socket2li&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sendall&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;socket2li&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;recv&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1024&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;

&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
  &lt;span class="n"&gt;conn&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;addr&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;accept&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
  &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;datagram&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;conn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;recv&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1024&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;datagram&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;exit&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;break&lt;/span&gt;
        &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;send_message2server&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;datagram&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;strip&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="n"&gt;conn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;send&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; 
  &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;Exception&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;进程一与进程二通信部分为:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;send_message&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;s01d&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;client&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AF_UNIX&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SOCK_STREAM&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connect&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;./communicate.sock&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sendall&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;recv&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1024&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;从这里我们可以看到，我们实际把中断进行了转移，把与远程主机的中断移到了本地。如此一来延迟变得非常小&lt;/p&gt;
&lt;h1 id="_6"&gt;扫尾&lt;/h1&gt;
&lt;p&gt;细心的小伙伴可能会看到，我们这里没有做掉线重连、启动顺序、错误处理之类的机制，这些保证健壮性的工作我放到源码里，有兴趣的同学可以自行阅读&lt;/p&gt;
&lt;p&gt;需要说明的是&lt;code&gt;等待机器上线后连接&lt;/code&gt;部分的代码我用的是《python network programming cookbook》中&lt;a href="https://github.com/lovexiaov/learn-python/blob/master/python-network-programming-cookbook/sorce_code/chapter3/3_3_wait_for_remote_service.py"&gt;第三章的源码&lt;/a&gt;，周末逛书店看到这部分代码很漂亮，就直接拿过来用，替换了我之前自己写的&lt;/p&gt;
&lt;h1 id="faq"&gt;FAQ&lt;/h1&gt;
&lt;h3 id="serverweb-server"&gt;进程二中的server可以使用web server吗&lt;/h3&gt;
&lt;p&gt;可以的，不采用的原因是web server比socket啰嗦太多&lt;/p&gt;
&lt;h3 id="zeromq"&gt;为何不用zeromq&lt;/h3&gt;
&lt;p&gt;我其实偏好zeromq,关于zeromq的优点，我之前笔记里又记录:&lt;a href="http://blog.just4fun.site/mq-note.html"&gt;消息队列中间件学习笔记&lt;/a&gt; ,zeromq 是个野心勃勃而欣欣向荣的项目&lt;/p&gt;
&lt;p&gt;没用它的主要原因是，硬件开发者，包李老师，偏好用socket&lt;/p&gt;
&lt;p&gt;尽管我可以在进程二与硬件积木中使用socket连接(迁就硬件这边)，在进程一与进程二之间使用zeromq，不过获得的好处并不明显，还导致了不一致，感觉不划算&lt;/p&gt;
&lt;h4 id="2017-04-29"&gt;2017-04-29补充&lt;/h4&gt;
&lt;p&gt;目前能想到使用zeromq的一个场景是:多个用户能一起用浏览器来控制我们的硬件积木(我们在此只关注通信部分，其他方面暂不关注) ,也就是说需要1-N连接(1是server，N是client),直接使用REQUEST/RESPONSE模型就行 &lt;/p&gt;
&lt;p&gt;这里给个示例代码(照抄&lt;a href="http://www.firefoxbug.com/index.php/archives/2755/"&gt;这里&lt;/a&gt;):&lt;/p&gt;
&lt;p&gt;客户端&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;zmq&lt;/span&gt;  

&lt;span class="n"&gt;context&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;zmq&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Context&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;  

&lt;span class="c1"&gt;#  Socket to talk to server  &lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Connecting to hello world server...&amp;quot;&lt;/span&gt;  
&lt;span class="n"&gt;socket&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;zmq&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;REQ&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  
&lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connect&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;tcp://localhost:5555&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  

&lt;span class="c1"&gt;#  Do 10 requests, waiting each time for a response  &lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;  
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Sending request &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;...&amp;quot;&lt;/span&gt;  
    &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;send&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Hello&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  

    &lt;span class="c1"&gt;#  Get the reply.  &lt;/span&gt;
    &lt;span class="n"&gt;message&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;recv&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;  
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Received reply &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;[&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;]&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;服务端:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;zmq&lt;/span&gt;  
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;time&lt;/span&gt;  

&lt;span class="n"&gt;context&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;zmq&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Context&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;  
&lt;span class="n"&gt;socket&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;zmq&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;REP&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  
&lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;bind&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;tcp://*:5555&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  
&lt;span class="n"&gt;count&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;

&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;  
    &lt;span class="c1"&gt;#  Wait for next request from client  &lt;/span&gt;
    &lt;span class="n"&gt;message&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;recv&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;  
    &lt;span class="n"&gt;count&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Received request: &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;count&lt;/span&gt; 

    &lt;span class="c1"&gt;#  Do some &amp;#39;work&amp;#39;  &lt;/span&gt;
    &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sleep&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;        &lt;span class="c1"&gt;#   Do some &amp;#39;work&amp;#39;  &lt;/span&gt;

    &lt;span class="c1"&gt;#  Send reply back to client  &lt;/span&gt;
    &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;send&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;World&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;client可以在server没有启动的时候上线（不会报错），只要服务端上线就不会丢消息,如此一来启动问题变得十分轻松，不必保证server先上线&lt;/p&gt;
&lt;p&gt;其次client可以有多个，server能同时处理它们，不会引起混乱&lt;/p&gt;
&lt;p&gt;单是以上两点就省下我们许多工作&lt;/p&gt;
&lt;h3 id="_7"&gt;下一步打算如何改进&lt;/h3&gt;
&lt;p&gt;使用websocket，目前已经在开发环境里用了，具体原因之后有机会说&lt;/p&gt;
&lt;h1 id="_8"&gt;参考&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://zh.wikipedia.org/wiki/%E8%A1%8C%E7%A8%8B%E9%96%93%E9%80%9A%E8%A8%8A"&gt;wikipedia https://zh.wikipedia.org/wiki/%E8%A1%8C%E7%A8%8B%E9%96%93%E9%80%9A%E8%A8%8A&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://zh.wikipedia.org/wiki/Unix%E5%9F%9F%E5%A5%97%E6%8E%A5%E5%AD%97"&gt;Unix域套接字&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.ibm.com/developerworks/cn/linux/l-socket-ipc/"&gt;在 Linux 上实现基于 Socket 的多进程实时通信&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://stackoverflow.com/questions/11597284/how-do-i-create-a-python-socket-server-that-listens-on-a-file-descriptor"&gt;How do I create a Python socket server that listens on a file descriptor?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://stackoverflow.com/questions/6920858/interprocess-communication-in-python"&gt;interprocess communication in python&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">wuwenjie</dc:creator><pubDate>Fri, 28 Apr 2017 00:00:00 +0000</pubDate><guid isPermaLink="false">tag:,2017-04-28:ipc_on_blockly4pi.html</guid><category>rpi</category></item><item><title>openbot之自然语言解析器</title><link>/openbot-natural-language-parser.html</link><description>&lt;blockquote&gt;
&lt;p&gt;行程才是目的，顿悟在每日的实践中 --《UNIX设编程艺术》&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id="openbot"&gt;openbot&lt;/h1&gt;
&lt;p&gt;openbot是我的业余项目，对NLP和AI的兴趣由来已久，想通过造轮子的方式来学习&lt;/p&gt;
&lt;p&gt;我是api.ai的忠实用户，也使用wit.ai（给这个项目的client提交过源码）。国内的yige.ai也很棒。openbot的web/sdk接口模仿着它们设计&lt;/p&gt;
&lt;p&gt;openbot最初作为&lt;a href="https://github.com/wwj718/deepThought"&gt;deepThought&lt;/a&gt;的衍生项目，相关思路可以参考：&lt;a href="https://github.com/wwj718/deepThought#衍生计划"&gt;deepThought#衍生计划&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;后来觉得我的兴趣更多在架构，我日常接触的更多的也是架构，想把它变为一个通用的框架：这个框架提供通用的webapp，对外提供restful api，也提供各个语言的sdk以便开发者集成，目前完成了python sdk，nodejs的正在编写&lt;/p&gt;
&lt;p&gt;近期在看《Unix编程艺术》，13.4部分在谈论emacs的设计哲学，作者把emacs视为一个框架，作者说到：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;当编制一个框架时，牢记分离原则：框架是机制，尽可能少地包含策略...尽可能多地将行为分解到使用框架的模块中去&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;我之前的架构简图如下&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/openbotda2fa65a.png" /&gt;&lt;/p&gt;
&lt;p&gt;openbot致力于将webapp和sdk做得开箱可用，而nlu可插拔，不限制实现策略，只要满足相关约定，即可插入到框架中对最终用户提供nlp服务,在结构图中，我以chatterbot作为bot server为例&lt;/p&gt;
&lt;p&gt;openbot项目近期没有开源，朋友的创业公司打算用它，如果之后合适，我会将其开源。&lt;/p&gt;
&lt;h1 id="_1"&gt;语法解析&lt;/h1&gt;
&lt;p&gt;轮子哥@vczh有句话在技术圈很有名&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;程序员的三大浪漫是编译原理，图形学和操作系统&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;编译原理确实一个有趣的话题，仅其中涉及的词法分析和语法分析就已十分迷人&lt;/p&gt;
&lt;p&gt;相较于解析编程语言（python程序员的入门资料可以参考&lt;a href="http://python3-cookbook.readthedocs.io/zh_CN/latest/c02/p18_tokenizing_text.html"&gt;字符串令牌解析&lt;/a&gt;），我对解析自然语言的兴趣更大些，一方面来自对人工智能的兴趣，另一方面来自一直关注的分析哲学流派，他们把大多哲学问题处理为语言问题，分析哲学阵营的路德维希.维特根斯坦有句名言&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;语言的极限便是世界的极限   --《逻辑哲学论》 5.6&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;今天的nlp领域同大多涉及智能的领域一样，基于统计/大数据。&lt;/p&gt;
&lt;h1 id="parsetron"&gt;&lt;a href="https://github.com/Kitt-AI/parsetron"&gt;parsetron&lt;/a&gt;&lt;/h1&gt;
&lt;h3 id="_2"&gt;缘起&lt;/h3&gt;
&lt;p&gt;我在&lt;a href="http://blog.just4fun.site/rpi-siri-close-light.html"&gt;嘿 Siri 关灯&lt;/a&gt;里提到我需要一个自然语言解析器，我准备使用yige.ai来替代Siri，以实现跨平台使用。我又想把它运行在本地&lt;/p&gt;
&lt;p&gt;《嘿 Siri 关灯》是典型的nlp+硬件控制的案例（你可能想到扎尔伯格的&lt;a href="https://m.toutiao.com/i6366879371965235714/?tt_from=weixin_moments&amp;amp;utm_campaign=client_share&amp;amp;app=news_article&amp;amp;utm_source=weixin_moments&amp;amp;iid=6814510930&amp;amp;utm_medium=toutiao_android&amp;amp;wxshare_count=2&amp;amp;pbid=31547628651&amp;amp;from=timeline&amp;amp;isappinstalled=0"&gt;Jarvis&lt;/a&gt;），在我的场景中（使用自然语言驱动硬件），自然语言处理模块并不需要很强大，对话的模式也很简单，多是&lt;code&gt;嘿siri，把灯打开/把空调打开/把风扇打开&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Kitt.ai开放的&lt;a href="Parsetron"&gt;https://github.com/Kitt-AI/parsetron&lt;/a&gt;是个不错的选择，小巧而实用，可以一言不合就修改源码。&lt;/p&gt;
&lt;h3 id="_3"&gt;关于&lt;/h3&gt;
&lt;p&gt;parsetron是个非常有趣的项目，来自Kitt.ai&lt;/p&gt;
&lt;p&gt;parsetron将自己定位在一个足够小的领域（诸如我手头的硬件控制），这样需要处理的语言模式比较单一，绕开了nlp领域会遇到的大多复杂问题(许多问题在学术圈也依旧困难，遑论工程)&lt;/p&gt;
&lt;p&gt;parsetron是个典型的通过降低选择复杂度，让项目变得健壮而实用的案例，按照《UNIX编程艺术》的说法：通过选择合适的目标能有效降低复杂度&lt;/p&gt;
&lt;p&gt;人工智能在一个细分领域可能做得很好，可如果我们一开始提高人们的期望，把它定位在通用型AI，往往容易给人"人工智障"的感觉，目前好用的bot多是找了一个具体的小场景，这也符合UNIX哲学里的：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Do one thing and do well&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;本文关注如何使用parsetron，之后有时间再分析&lt;a href="http://parsetron.kitt.ai/en/latest/quickstart.html#how-it-works"&gt;原理&lt;/a&gt;和&lt;a href="https://github.com/Kitt-AI/parsetron"&gt;源码&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="_4"&gt;入门&lt;/h3&gt;
&lt;p&gt;安装很简单&lt;code&gt;pip install parsetron&lt;/code&gt;,目前只支持python2，parsetron没有任何外部依赖&lt;/p&gt;
&lt;p&gt;&lt;a href="http://parsetron.kitt.ai/en/latest/quickstart.html#simple-example"&gt;文档&lt;/a&gt;里的demo是非常好的入门案例&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;parsetron&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Set&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Regex&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;OneOrMore&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Grammar&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;RobustParser&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;LightGrammar&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Grammar&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

    &lt;span class="n"&gt;action&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Set&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;change&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;flash&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;set&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;blink&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
    &lt;span class="n"&gt;light&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Set&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;top&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;middle&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;bottom&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
    &lt;span class="n"&gt;color&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Regex&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;(red|yellow|blue|orange|purple|...)&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;times&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Set&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;once&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;twice&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;three times&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Regex&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;\d+ times&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;one_parse&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;action&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;light&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;Optional&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;times&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;color&lt;/span&gt;
    &lt;span class="n"&gt;GOAL&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;OneOrMore&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;one_parse&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="nd"&gt;@staticmethod&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
        &lt;span class="n"&gt;parser&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;RobustParser&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;LightGrammar&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;
        &lt;span class="n"&gt;sents&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;
            &lt;span class="s2"&gt;&amp;quot;set my top light to red&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="s2"&gt;&amp;quot;set my top light to red and change middle light to yellow&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="s2"&gt;&amp;quot;set my top light to red and change middle light to yellow and flash bottom light twice in blue&amp;quot;&lt;/span&gt;
        &lt;span class="p"&gt;]&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;sent&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;sents&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;tree&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;parser&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sent&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;one_parse&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;color&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;red&amp;#39;&lt;/span&gt;

            &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s1"&gt;&amp;quot;&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;sent&lt;/span&gt;
            &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;parse tree:&amp;quot;&lt;/span&gt;
            &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;tree&lt;/span&gt;
            &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;parse result:&amp;quot;&lt;/span&gt;
            &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;
            &lt;span class="k"&gt;print&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;运行&lt;code&gt;LightGrammar.test()&lt;/code&gt;得到：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&amp;quot;set my top light to red&amp;quot;
parse tree:
(GOAL
  (one_parse
    (action &amp;quot;set&amp;quot;)
    (light &amp;quot;top&amp;quot;)
    (color &amp;quot;red&amp;quot;)
  )
)

parse result:
{
  &amp;quot;one_parse&amp;quot;: [
    {
      &amp;quot;one_parse&amp;quot;: [
        &amp;quot;set&amp;quot;,
        &amp;quot;top&amp;quot;,
        &amp;quot;red&amp;quot;
      ],
      &amp;quot;light_span_&amp;quot;: [
        2,
        3
      ],
      &amp;quot;action_span_&amp;quot;: [
        0,
        1
      ],
      &amp;quot;light&amp;quot;: &amp;quot;top&amp;quot;,
      &amp;quot;color_span_&amp;quot;: [
        5,
        6
      ],
      &amp;quot;color&amp;quot;: &amp;quot;red&amp;quot;,
      &amp;quot;action&amp;quot;: &amp;quot;set&amp;quot;,
      &amp;quot;one_parse_span_&amp;quot;: [
        0,
        6
      ]
    }
  ],
  &amp;quot;GOAL&amp;quot;: [
    [
      &amp;quot;set&amp;quot;,
      &amp;quot;top&amp;quot;,
      &amp;quot;red&amp;quot;
    ]
  ]
}

&amp;quot;set my top light to red and change middle light to yellow&amp;quot;
parse tree:
(GOAL
  (one_parse
    (action &amp;quot;set&amp;quot;)
    (light &amp;quot;top&amp;quot;)
    (color &amp;quot;red&amp;quot;)
  )
  (one_parse
    (action &amp;quot;change&amp;quot;)
    (light &amp;quot;middle&amp;quot;)
    (color &amp;quot;yellow&amp;quot;)
  )
)

parse result:
{
  &amp;quot;one_parse&amp;quot;: [
    {
      &amp;quot;one_parse&amp;quot;: [
        &amp;quot;set&amp;quot;,
        &amp;quot;top&amp;quot;,
        &amp;quot;red&amp;quot;
      ],
      &amp;quot;light_span_&amp;quot;: [
        2,
        3
      ],
      &amp;quot;action_span_&amp;quot;: [
        0,
        1
      ],
      &amp;quot;light&amp;quot;: &amp;quot;top&amp;quot;,
      &amp;quot;color_span_&amp;quot;: [
        5,
        6
      ],
      &amp;quot;color&amp;quot;: &amp;quot;red&amp;quot;,
      &amp;quot;action&amp;quot;: &amp;quot;set&amp;quot;,
      &amp;quot;one_parse_span_&amp;quot;: [
        0,
        6
      ]
    },
    {
      &amp;quot;one_parse&amp;quot;: [
        &amp;quot;change&amp;quot;,
        &amp;quot;middle&amp;quot;,
        &amp;quot;yellow&amp;quot;
      ],
      &amp;quot;light_span_&amp;quot;: [
        8,
        9
      ],
      &amp;quot;action_span_&amp;quot;: [
        7,
        8
      ],
      &amp;quot;light&amp;quot;: &amp;quot;middle&amp;quot;,
      &amp;quot;color_span_&amp;quot;: [
        11,
        12
      ],
      &amp;quot;color&amp;quot;: &amp;quot;yellow&amp;quot;,
      &amp;quot;action&amp;quot;: &amp;quot;change&amp;quot;,
      &amp;quot;one_parse_span_&amp;quot;: [
        7,
        12
      ]
    }
  ],
  &amp;quot;GOAL&amp;quot;: [
    [
      &amp;quot;set&amp;quot;,
      &amp;quot;top&amp;quot;,
      &amp;quot;red&amp;quot;
    ],
    [
      &amp;quot;change&amp;quot;,
      &amp;quot;middle&amp;quot;,
      &amp;quot;yellow&amp;quot;
    ]
  ]
}

&amp;quot;set my top light to red and change middle light to yellow and flash bottom light twice in blue&amp;quot;
parse tree:
(GOAL
  (one_parse
    (action &amp;quot;set&amp;quot;)
    (light &amp;quot;top&amp;quot;)
    (color &amp;quot;red&amp;quot;)
  )
  (one_parse
    (action &amp;quot;change&amp;quot;)
    (light &amp;quot;middle&amp;quot;)
    (color &amp;quot;yellow&amp;quot;)
  )
  (one_parse
    (action &amp;quot;flash&amp;quot;)
    (light &amp;quot;bottom&amp;quot;)
    (Optional(times)
      (times
        (Set(three times|twice|once) &amp;quot;twice&amp;quot;)
      )
    )
    (color &amp;quot;blue&amp;quot;)
  )
)

parse result:
{
  &amp;quot;one_parse&amp;quot;: [
    {
      &amp;quot;one_parse&amp;quot;: [
        &amp;quot;set&amp;quot;,
        &amp;quot;top&amp;quot;,
        &amp;quot;red&amp;quot;
      ],
      &amp;quot;light_span_&amp;quot;: [
        2,
        3
      ],
      &amp;quot;action_span_&amp;quot;: [
        0,
        1
      ],
      &amp;quot;light&amp;quot;: &amp;quot;top&amp;quot;,
      &amp;quot;color_span_&amp;quot;: [
        5,
        6
      ],
      &amp;quot;color&amp;quot;: &amp;quot;red&amp;quot;,
      &amp;quot;action&amp;quot;: &amp;quot;set&amp;quot;,
      &amp;quot;one_parse_span_&amp;quot;: [
        0,
        6
      ]
    },
    {
      &amp;quot;one_parse&amp;quot;: [
        &amp;quot;change&amp;quot;,
        &amp;quot;middle&amp;quot;,
        &amp;quot;yellow&amp;quot;
      ],
      &amp;quot;light_span_&amp;quot;: [
        8,
        9
      ],
      &amp;quot;action_span_&amp;quot;: [
        7,
        8
      ],
      &amp;quot;light&amp;quot;: &amp;quot;middle&amp;quot;,
      &amp;quot;color_span_&amp;quot;: [
        11,
        12
      ],
      &amp;quot;color&amp;quot;: &amp;quot;yellow&amp;quot;,
      &amp;quot;action&amp;quot;: &amp;quot;change&amp;quot;,
      &amp;quot;one_parse_span_&amp;quot;: [
        7,
        12
      ]
    },
    {
      &amp;quot;one_parse&amp;quot;: [
        &amp;quot;flash&amp;quot;,
        &amp;quot;bottom&amp;quot;,
        &amp;quot;twice&amp;quot;,
        &amp;quot;blue&amp;quot;
      ],
      &amp;quot;color_span_&amp;quot;: [
        18,
        19
      ],
      &amp;quot;light_span_&amp;quot;: [
        14,
        15
      ],
      &amp;quot;action_span_&amp;quot;: [
        13,
        14
      ],
      &amp;quot;light&amp;quot;: &amp;quot;bottom&amp;quot;,
      &amp;quot;Optional(times)&amp;quot;: &amp;quot;twice&amp;quot;,
      &amp;quot;times&amp;quot;: &amp;quot;twice&amp;quot;,
      &amp;quot;Optional(times)_span_&amp;quot;: [
        16,
        17
      ],
      &amp;quot;times_span_&amp;quot;: [
        16,
        17
      ],
      &amp;quot;Set(three times|twice|once)&amp;quot;: &amp;quot;twice&amp;quot;,
      &amp;quot;action&amp;quot;: &amp;quot;flash&amp;quot;,
      &amp;quot;Set(three times|twice|once)_span_&amp;quot;: [
        16,
        17
      ],
      &amp;quot;one_parse_span_&amp;quot;: [
        13,
        19
      ],
      &amp;quot;color&amp;quot;: &amp;quot;blue&amp;quot;
    }
  ],
  &amp;quot;GOAL&amp;quot;: [
    [
      &amp;quot;set&amp;quot;,
      &amp;quot;top&amp;quot;,
      &amp;quot;red&amp;quot;
    ],
    [
      &amp;quot;change&amp;quot;,
      &amp;quot;middle&amp;quot;,
      &amp;quot;yellow&amp;quot;
    ],
    [
      &amp;quot;flash&amp;quot;,
      &amp;quot;bottom&amp;quot;,
      &amp;quot;twice&amp;quot;,
      &amp;quot;blue&amp;quot;
    ]
  ]
}
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;非常漂亮！&lt;/p&gt;
&lt;p&gt;更完整的例子可以参考 &lt;a href="http://parsetron.kitt.ai/en/latest/quickstart.html#complex-example"&gt;Complex Example&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="_5"&gt;使用场景&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;It is mainly used to convert natural language command to executable API calls (e.g., “set my bedroom light to red” –&amp;gt; set_light('bedroom', [255, 0, 0]))&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;parsetron的典型使用场景是将自然语言转变为api调用，实际是将非结构话的自然语言，解析为结构化的数据，进而调用api。&lt;/p&gt;
&lt;p&gt;作者给出了一些&lt;a href="http://parsetron.kitt.ai/en/latest/quickstart.html#what-it-is"&gt;典型使用场景&lt;/a&gt;:&lt;/p&gt;
&lt;p&gt;诸如使用自然语言控制你的智能灯泡：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;give me something romantic&lt;/li&gt;
&lt;li&gt;my living room light is too dark&lt;/li&gt;
&lt;li&gt;change bedroom light to sky blue&lt;/li&gt;
&lt;li&gt;blink living room light twice in red color&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以及控制你的微波炉：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;defrost this chicken please, the weight is 4 pounds&lt;/li&gt;
&lt;li&gt;heat up the pizza for 2 minutes 20 seconds&lt;/li&gt;
&lt;li&gt;warm up the milk for 1 minute&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;作者给出了这类需求的通用解决方案：从自然语言命令中提取关键信息，以帮助开发人员调用API来控制智能设备。由此完成了自然语言指令到传统程序的映射&lt;/p&gt;
&lt;p&gt;作者进一步分析说传统的方法是编写一系列规则，如正则表达式，这些规则难以维护和扩展。而采用编译原理中的词法/语法解析。不但学习曲线很高，且解析器输出通常是树结构，对我们的任务没有直接的帮助&lt;/p&gt;
&lt;p&gt;我在&lt;a href="https://github.com/wwj718/deepThought"&gt;deepThought&lt;/a&gt;的目标里写过&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;构造通用的解析工具，将自然语言解析为结构化信息&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;这点与parsetron不谋而合，parsetron对我而言是作为bot server的理想实现，用于解析硬件指令&lt;/p&gt;
&lt;p&gt;其实目前Siri也具有这个功能（需要hack，而且比较繁琐），我在《嘿 Siri 关灯》主要就用到这个功能。&lt;/p&gt;
&lt;h3 id="_6"&gt;问题&lt;/h3&gt;
&lt;p&gt;parsetron暂不支持中文，项目的todo中有支持unicode的计划，不过项目一年来似乎没更新了，我fork了这个项目，近期试着为它增加中文支持&lt;/p&gt;
&lt;h1 id="pyparsing"&gt;Pyparsing&lt;/h1&gt;
&lt;p&gt;Parsetron的文档里写道：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Parsetron is inspired by pyparsing.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;我们顺路了解一下&lt;a href="https://pyparsing.wikispaces.com/"&gt;pyparsing&lt;/a&gt;，顾名思义，Pyparsing是python实现的解析器。&lt;/p&gt;
&lt;h3 id="_7"&gt;入门&lt;/h3&gt;
&lt;p&gt;简单做个入门了解。以解析"Hello, World!"为例&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pyparsing&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Word&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;alphas&lt;/span&gt;
&lt;span class="n"&gt;greet&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Word&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;alphas&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;,&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;Word&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;alphas&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;!&amp;quot;&lt;/span&gt; &lt;span class="c1"&gt;# &amp;lt;-- grammar defined here&lt;/span&gt;
&lt;span class="n"&gt;hello&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Hello, World!&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;hello&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;-&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;greet&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parseString&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;hello&lt;/span&gt; &lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;输出为：&lt;code&gt;Hello, World! -&amp;gt; ['Hello', ',', 'World', '!']&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;上边的greet可以解析任何具有以下模式的句子： &lt;code&gt;&amp;lt;salutation&amp;gt;, &amp;lt;addressee&amp;gt;!&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;更多案例和使用方法参考:&lt;a href="https://pyparsing.wikispaces.com/Examples"&gt;Examples&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="_8"&gt;支持中文&lt;/h3&gt;
&lt;p&gt;值得一提的是pyparsing支持python3和unicode，这对我们处理中文会有大帮助。我们来做个试验：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# python3&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pyparsing&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Word&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;alphas&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;CharsNotIn&lt;/span&gt;
&lt;span class="n"&gt;greet&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;CharsNotIn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;,!&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;,&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;CharsNotIn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;,!&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;!&amp;quot;&lt;/span&gt; &lt;span class="c1"&gt;# &amp;lt;-- grammar defined here&lt;/span&gt;
&lt;span class="n"&gt;hello&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;你好, 世界!&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;hello&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;-&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;greet&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parseString&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;hello&lt;/span&gt; &lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;输出为 ： &lt;code&gt;好, 世界! -&amp;gt; ['你好', ',', ' 世界', '!']&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;这个解决方案可行，但比较丑陋，如何在pyparsing使用unicode，可以自行google&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">wuwenjie</dc:creator><pubDate>Mon, 26 Dec 2016 00:00:00 +0000</pubDate><guid isPermaLink="false">tag:,2016-12-26:openbot-natural-language-parser.html</guid><category>tools</category></item><item><title>周末、填坑与树莓派资源大全</title><link>/awesome-raspberry-pi-zh.html</link><description>&lt;h3 id="_1"&gt;周末&lt;/h3&gt;
&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/pi_lmdc5109614.png" /&gt;&lt;/p&gt;
&lt;p&gt;难得的晴天，午睡足，醒来快三点，下午骑车闲逛，到老门东，一路骑来，风光满眼&lt;/p&gt;
&lt;p&gt;途闻桂香，想到-dumb-在《秋望》里写到&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;桂子天香渐满廊&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;翻出原句，再读，依然觉得大好：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;前調
    秋望
老去身閑與世忘。罷裁矮紙倚昏黃。孤光一出千山暗，小立人間萬木涼。  新涕淚，古蒼茫。片時相對已恩長。秋風葉上清商起，桂子天香漸滿廊。
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="_2"&gt;填坑&lt;/h3&gt;
&lt;p&gt;到老门东星巴克，选了个二楼靠窗位置,可见斜檐、屋顶、明城墙&lt;/p&gt;
&lt;p&gt;准备坐上半天，来填近来挖的坑&lt;/p&gt;
&lt;p&gt;先把完整填完的坑，放上来&lt;/p&gt;
&lt;h3 id="_3"&gt;树莓派资源大全&lt;/h3&gt;
&lt;p&gt;近来折腾了几个好玩的东西，与树莓派有关，也陆续写了几篇文章，收到不少邮件，大家还蛮喜欢的。开心&lt;/p&gt;
&lt;p&gt;折腾树莓派过程中看到不少国内外好玩的项目，我喜欢收集整理有趣的东西，也喜欢归档到博客和github。&lt;/p&gt;
&lt;p&gt;前端时间看到国外有人整理了&lt;a href="https://github.com/thibmaek/awesome-raspberry-pi"&gt;awesome-raspberry-pi&lt;/a&gt;，决定翻译为中文。之后我还打算在树莓派上折腾图形化编程、ai和自动驾驶之类的东西，会长期和树莓派打交道，所以将长期维护这个树莓派资源列表&lt;/p&gt;
&lt;p&gt;如果你用树莓派做了什么好玩的东西，并且愿意分享出来，欢迎把你的项目加入到资源列表里 ：）&lt;/p&gt;
&lt;p&gt;具体的资源大全戳这里：&lt;a href="https://github.com/wwj718/awesome-raspberry-pi-zh"&gt;wwj718/awesome-raspberry-pi-zh&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;期待你的PR : )&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">wuwenjie</dc:creator><pubDate>Sun, 30 Oct 2016 00:00:00 +0000</pubDate><guid isPermaLink="false">tag:,2016-10-30:awesome-raspberry-pi-zh.html</guid><category>tools</category></item><item><title>基于树莓派和Tensowflow的物体识别-speaker</title><link>/raspberrypi-tensowflow-robot-speaker.html</link><description>&lt;p&gt;接上篇文章:&lt;a href="http://blog.just4fun.site/raspberrypi-tensowflow-robot.html"&gt;基于树莓派和Tensowflow的物体识别-brain&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上篇文章里我们用tensorflow的inception模型为&lt;code&gt;树莓派探险者&lt;/code&gt;添加智能（它的大脑（brain））。这篇文章里我们给他添加外设，使其"说"出物体的名称，我们将使其成为speaker&lt;/p&gt;
&lt;p&gt;ps：之所以叫树莓派探险者是它的行为很像一个初入地球的外星机器人，对周遭事物充满好奇，试图弄清看到的每个物体是什么（代码的实现是超声波测距+拍照+tensorflow图像识别）&lt;/p&gt;
&lt;h1 id="_1"&gt;目标&lt;/h1&gt;
&lt;p&gt;我们将使树莓派探险者用中文说出看到的物体的名字，诸如&lt;code&gt;这是一个橘子&lt;/code&gt;&lt;/p&gt;
&lt;h1 id="_2"&gt;任务&lt;/h1&gt;
&lt;p&gt;为了实现这个目标我们有几件事要做。&lt;/p&gt;
&lt;p&gt;tensorflow的inception模型识别完物体，将输出5个最为贴近的物体的英文名称。我们选取得分最高的物体，将其名称翻译为中文，之后用蓝牙音箱输出：&lt;code&gt;这是一个xxx&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;实际上是以下两项任务：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;英汉翻译&lt;/li&gt;
&lt;li&gt;中文文字转语音&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="_3"&gt;解决方案&lt;/h1&gt;
&lt;p&gt;完成以上任务，有两种典型的方案，一种使用云服务，一种使用本地软件&lt;/p&gt;
&lt;h3 id="_4"&gt;云服务&lt;/h3&gt;
&lt;p&gt;使用云服务，我们可以轻松完成以上两项任务，英汉翻译使用：&lt;a href="https://github.com/translate/translate"&gt;translate&lt;/a&gt;, 这是一个python库，直接pip安装就行&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# pip install translate&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;translate&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Translator&lt;/span&gt;
&lt;span class="n"&gt;translator&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Translator&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;from_lang&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;en&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;to_lang&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;zh&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;translation&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;translator&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;translate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;umbrella&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;translation&lt;/span&gt; &lt;span class="c1"&gt;#雨伞&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;hr /&gt;
&lt;p&gt;中文文字转语音可以使用&lt;a href="http://yuyin.baidu.com/tts/"&gt;百度语音合成&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="_5"&gt;本地软件&lt;/h3&gt;
&lt;p&gt;为了提高响应速度和可控性，使其减少对网络的依赖（有些环境并没有网络），也许我们更倾向使用本地软件&lt;/p&gt;
&lt;p&gt;下面分别论述如何在不依赖网络的情况下使用本地软件来完成翻译和文字转语音的任务&lt;/p&gt;
&lt;p&gt;英汉翻译我们选择: &lt;code&gt;sdcv&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo  apt-get install sdcv
mkdir -p ~/.stardict/dic # 之后把字典下载解压到这个目录里
sdcv orange #查询单词 orange
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;之后我们用正则提取出其中的名词选项，选择最靠前的（这个策略没有认真考虑过）&lt;/p&gt;
&lt;p&gt;至于字典的下载可以到这里：&lt;a href="http://abloz.com/huzheng/stardict-dic/zh_CN/"&gt;zh_CN 简体中文词典&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;我下了三个字典：朗道英汉字典5.0、KDic11万英汉词典、牛津简明英汉袖珍辞典&lt;/p&gt;
&lt;p&gt;朗道英汉字典5.0内容详尽，牛津简明英汉袖珍辞典简单清晰&lt;/p&gt;
&lt;p&gt;我偏好后者&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;下一个任务是中文文字转语音，树莓派机器人原作者Lukas使用&lt;a href="http://www.festvox.org/flite/"&gt;Flite&lt;/a&gt;来做文字转语音。Flite是一个小型、快速的TTS系统，是著名的语音合成系统festival的C版本，可用于嵌入式系统&lt;/p&gt;
&lt;p&gt;可惜这个工具不支持中文，我决定采用:&lt;a href="https://github.com/hgneng/ekho"&gt;ekho&lt;/a&gt;来做文字转语音的工作，项目介绍在:&lt;a href="http://www.eguidedog.net/cn/ekho_cn.php"&gt;Ekho(余音) - 中文语音合成软件&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;其他可选的工具还有eSpeak,安装和使用都简单。&lt;code&gt;espeak -vzh "你好"&lt;/code&gt;，发音比较机械&lt;/p&gt;
&lt;h1 id="todo"&gt;todo&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;增加看图说话功能（Show and Tell: image captioning open sourced in TensorFlow）&lt;/li&gt;
&lt;li&gt;语音识别（pocketsphinx）&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="_6"&gt;参考&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://blog.csdn.net/zouxy09/article/details/7942784"&gt;PocketSphinx语音识别系统的编译、安装和使用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/jlinux/blog/blob/master/posts/voice-control.md"&gt;voice-control&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">wuwenjie</dc:creator><pubDate>Tue, 25 Oct 2016 00:00:00 +0000</pubDate><guid isPermaLink="false">tag:,2016-10-25:raspberrypi-tensowflow-robot-speaker.html</guid><category>tools</category></item><item><title>基于树莓派和Tensowflow的物体识别-brain</title><link>/raspberrypi-tensowflow-robot.html</link><description>&lt;p&gt;近来这篇文章很火：&lt;a href="https://www.oreilly.com/learning/how-to-build-a-robot-that-sees-with-100-and-tensorflow"&gt;How to build a robot that “sees” with $100 and TensorFlow&lt;/a&gt; （作者是Lukas，CrowdFlower创始人）
，中文译本为《如何用100美金和Tensowflow来造一个能"看"东西的机器人》，公众号们纷纷转载&lt;/p&gt;
&lt;p&gt;文章读来饶有趣味，里边涉及的技术大多接触过，都不难，遂决定动手实现它&lt;/p&gt;
&lt;p&gt;要实现整个项目，我手头还缺小车底盘，我们先来实现这个项目的核心部分：用树莓派和Tensowflow的识别现实世界的物体。日后有空再加上小车&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/orange94aa0771.png" /&gt;&lt;/p&gt;
&lt;p&gt;随手把桌子上同事给的橘子拍下来，之后我们试着让树莓派认出它&lt;/p&gt;
&lt;h1 id="_1"&gt;任务描述&lt;/h1&gt;
&lt;p&gt;&lt;a href="https://www.oreilly.com/learning/how-to-build-a-robot-that-sees-with-100-and-tensorflow"&gt;How to build a robot that “sees” with $100 and TensorFlow&lt;/a&gt; 已经把要做的是事说清楚了&lt;/p&gt;
&lt;p&gt;物体识别是近来机器学习领域的热点之一。对于识别人脸或是区分猫狗这件事上，计算机已经胸有成竹，而在更大的图片集中识别一个指定的物体还是人工智能领域的“圣杯”，不过近年也有很大进展&lt;/p&gt;
&lt;p&gt;我们将造一个能自己识别物体的机器人（不需要云服务）&lt;/p&gt;
&lt;h1 id="_2"&gt;工具介绍&lt;/h1&gt;
&lt;h3 id="_3"&gt;树莓派&lt;/h3&gt;
&lt;p&gt;树莓派（Raspberry Pi）是一款基于Linux的单板机电脑，它只有巴掌大小，却有惊人的计算能力，你可以把它当做一台普通电脑。&lt;/p&gt;
&lt;p&gt;树莓派的使命是制作一套启发孩子的电脑，降低孩子们试错的成本&lt;/p&gt;
&lt;p&gt;树莓派最新的版本是树莓派3,较前一代树莓派2，树莓派3的处理器升级为了64位的博通BCM2837，并首次加入了Wi-Fi无线网络及蓝牙功能。加量不加价&lt;/p&gt;
&lt;h3 id="tensorflow"&gt;TensorFlow&lt;/h3&gt;
&lt;p&gt;TensorFlow是一个由"Google大脑"团队的研究人员开发的机器学习库，Google遵循Apache License 2.0将其开源。该系统可以被用于语音识别、图片识别等多个领域&lt;/p&gt;
&lt;p&gt;在这个项目中我们主要用到一个叫做&lt;a href="https://github.com/tensorflow/models/tree/master/inception"&gt;inception&lt;/a&gt;的模型（基于ImageNet数据集）。它可以完成物体识别，我们直接使用预训练好的模型。训练模型可是个费时费力的工作&lt;/p&gt;
&lt;p&gt;你把智能当黑盒使用的时候，并不需要有那么多偷懒的负罪感啦（哈哈  我还是有一点）&lt;/p&gt;
&lt;p&gt;电气时代来临的时候，变革社会的除了那些发电的人，那些懂得使用电力去改造传统行业，创造新的行业的人，也许对社会的变革更为深刻。尽管他们可能连卡诺循环都不知道，甚至不知如何将水蒸汽中的动能转换为功，进而驱动电机发电&lt;/p&gt;
&lt;h4 id="imagenet"&gt;ImageNet数据集&lt;/h4&gt;
&lt;p&gt;这个数据集包含约120万张训练图像、5万张验证图像和10万张测试图像，分为1000个不同的类别，用于机器学习中训练图像识别系统&lt;/p&gt;
&lt;h1 id="_4"&gt;准备工作&lt;/h1&gt;
&lt;p&gt;我们先准备好树莓派,我用的是安装了&lt;a href="https://downloads.raspberrypi.org/raspbian/images/raspbian-2016-05-31/"&gt;raspbian-2016-05-31&lt;/a&gt;版本的树莓派3代（使用其他版本应该也没问题），关于树莓派的相关配置可以参考我之前的文章：&lt;a href="http://blog.just4fun.site/raspberrypi-install-and-config.html"&gt;树莓派折腾笔记之系统安装与配置&lt;/a&gt;&lt;/p&gt;
&lt;h1 id="tensowflow"&gt;安装Tensowflow&lt;/h1&gt;
&lt;p&gt;&lt;a href="https://www.oreilly.com/learning/how-to-build-a-robot-that-sees-with-100-and-tensorflow"&gt;How to build a robot that “sees” with $100 and TensorFlow&lt;/a&gt; 这篇文章里，作者采用的是TensorFlow提供的makefile命令，在树莓派中本地编译，这一步骤花费了作者几个小时。不过好处是一步到位。安装完后可以直接运行：&lt;code&gt;tensorflow/contrib/pi_examples/label_image/gen/bin/label_image&lt;/code&gt;来识别物体&lt;/p&gt;
&lt;p&gt;我不打算编译安装，除了过程费事，还需要在安装的几个小时里提心吊胆，深怕某个依赖问题导致前功尽弃，重新编译。 我在手动编译opencv的时候就曾备受折磨&lt;/p&gt;
&lt;h3 id="_5"&gt;我的安装过程&lt;/h3&gt;
&lt;p&gt;我们先安装已经适合树莓派的Tensowflow，这种工作，肯定有人做过，github一搜果不其然：&lt;a href="https://github.com/samjabrahams/tensorflow-on-raspberry-pi"&gt;tensorflow-on-raspberry-pi&lt;/a&gt;。我们开始安装：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;wget https://github.com/samjabrahams/tensorflow-on-raspberry-pi/raw/master/bin/tensorflow-0.9.0-cp27-none-linux_armv7l.whl
sudo pip install tensorflow-0.9.0-cp27-none-linux_armv7l.whl  #这一步会安装其他依赖，如果太慢，可以用-i参数，使用豆瓣源
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;安装过程很快，也就喝杯茶时间，过程十分流畅&lt;/p&gt;
&lt;p&gt;Tensowflow安装完成，我们开始加载模型,安装过程参考这里:&lt;a href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/contrib/pi_examples"&gt;pi_examples&lt;/a&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mkdir  ~/tf
cd /usr/local/lib/python2.7/dist-packages/tensorflow/models/image/imagenet
python classify_image.py --model_dir ~/tf/imagenet #--model_dir 指定模型数据存放的目录
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;完成后我们来测试下是否正常&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;python /usr/local/lib/python2.7/dist-packages/tensorflow/models/image/imagenet/classify_image.py  --model_dir ~/tf/imagenet
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;如果是如下输出则一切就绪：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;giant panda, panda, panda bear, coon bear, Ailuropoda melanoleuca (score = 0.89233)
indri, indris, Indri indri, Indri brevicaudatus (score = 0.00859)
lesser panda, red panda, panda, bear cat, cat bear, Ailurus fulgens (score = 0.00264)
custard apple (score = 0.00141)
earthstar (score = 0.00107)
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="_6"&gt;测试&lt;/h3&gt;
&lt;p&gt;我们来试一下我的伞（拍于办公室）：&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/sandfa6b51c.png" /&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;python /usr/local/lib/python2.7/dist-packages/tensorflow/models/image/imagenet/classify_image.py  --model_dir ~/tf/imagenet --image_file /tmp/test.jpg  # 图片需是jpg格式
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;输出为&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/san47120afa.png" /&gt;&lt;/p&gt;
&lt;p&gt;程序会给出5个可能的物体，得分最高的是雨伞，识别的很准确&lt;/p&gt;
&lt;p&gt;我们接着给它看一张橘子的图片：&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/orange94aa0771.png" /&gt;&lt;/p&gt;
&lt;p&gt;输出为&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;lemon (score = 0.72036)
orange (score = 0.16516)
spaghetti squash (score = 0.01571)
butternut squash (score = 0.00304)
ocarina, sweet potato (score = 0.00298)
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;它认为最大的可能是柠檬，橘子和柠檬确实很相似&lt;/p&gt;
&lt;p&gt;如果你想自己来训练你的模型，可以参考googleblog上的这篇文章:&lt;a href="https://research.googleblog.com/2016/03/train-your-own-image-classifier-with.html"&gt;Train your own image classifier with Inception in TensorFlow&lt;/a&gt;&lt;/p&gt;
&lt;h1 id="_7"&gt;优化&lt;/h1&gt;
&lt;p&gt;目前物体识别的性能不高，需要等一会儿，Lukas的机器人很有趣，它每次拍下照片，开始计算的时候会说&lt;code&gt;I'm thinking&lt;/code&gt;。延时得很自然，机器也确实是在“思考”&lt;/p&gt;
&lt;p&gt;关于如何提高运算速度，以下是几个可能&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;利用GPU来计算。树莓派支持GPU运算，不过&lt;a href="https://github.com/samjabrahams/tensorflow-on-raspberry-pi"&gt;tensorflow-on-raspberry-pi&lt;/a&gt;目前没有GPU版本的whl，linux/mac都有GPU版本的whl. 此问题详细谈论可以参考:&lt;a href="https://github.com/samjabrahams/tensorflow-on-raspberry-pi/issues/15"&gt;Question on GPU&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;使树莓派超频可以加快运算速度&lt;/li&gt;
&lt;li&gt;把tensorflow部署到小车控制器坐在的电脑上（本地电脑），实际计算在本地进行（这样可以把tensorflow用到任何client里，不过需要联网运行）&lt;/li&gt;
&lt;li&gt;把tensorflow部署到云上，提供网络服务&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;另一个优化是，缩小图片尺寸，可以使用ImageMagick提供的convert指令：&lt;code&gt;convert -resize 100x100 test.png dest.jpg&lt;/code&gt;。 如此一来就把图片转化为小尺寸（100x100），能有效提高运算速度&lt;/p&gt;
&lt;h1 id="todo"&gt;todo&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;中文语音输出&lt;ul&gt;
&lt;li&gt;蓝牙音箱&lt;/li&gt;
&lt;li&gt;英-&amp;gt;中翻译&lt;/li&gt;
&lt;li&gt;语音输出&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;加载到汽车模型上&lt;ul&gt;
&lt;li&gt;L298N驱动板&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="_8"&gt;参考&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://zh.wikipedia.org/wiki/%E6%A0%91%E8%8E%93%E6%B4%BE"&gt;维基百科 树莓派&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.oreilly.com/learning/how-to-build-a-robot-that-sees-with-100-and-tensorflow"&gt;How to build a robot that “sees” with $100 and TensorFlow&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/contrib/pi_examples"&gt;pi_examples&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">wuwenjie</dc:creator><pubDate>Sun, 23 Oct 2016 00:00:00 +0000</pubDate><guid isPermaLink="false">tag:,2016-10-23:raspberrypi-tensowflow-robot.html</guid><category>tools</category></item><item><title>用树莓派给家用电器加上智能（红外篇）</title><link>/raspberrypi-lirc.html</link><description>&lt;h1 id="ideas"&gt;ideas&lt;/h1&gt;
&lt;p&gt;许多家电是红外控制的，与外界的交互通过一个红外遥控器,我们能否通过编程使其变成智能家居呢，好比我们想做这样一件事：&lt;code&gt;夏天傍晚下班前，检查室内温度，如果室温高于30摄氏度，则打开空调&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;要做到上边这件事，我们未必需要购买最新的带app控制的智能空调，利用旧式空调也可以。空调由红外遥控器控制，如果我们能控制红外的收发,模拟发射这些控制信号，我们就可以hack这些旧家电，使其可编程，变成&lt;code&gt;智能家电&lt;/code&gt;&lt;/p&gt;
&lt;h1 id="_1"&gt;目标&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;红外线控制&lt;/li&gt;
&lt;li&gt;微信控制&lt;/li&gt;
&lt;li&gt;自然语言控制（chatbot）&lt;/li&gt;
&lt;li&gt;blockly编程控制&lt;/li&gt;
&lt;li&gt;与其他传感器组合（温湿度）&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="_2"&gt;硬件环境&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;树莓派(我的当前环境是树莓派3,其他版本也可以)&lt;/li&gt;
&lt;li&gt;红外接收器/红外发射器（我用的是这款&lt;a href="http://ukonline2000.com/?p=296"&gt;红外线扩展板&lt;/a&gt;,能同时支持红外收发）&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="lirc"&gt;&lt;a href="https://zh.wikipedia.org/zh-hans/LIRC"&gt;LIRC&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;LIRC是我们需要的软件.&lt;/p&gt;
&lt;p&gt;LIRC 是 Linux Infrared remote control的缩写，是linux系统下开源的软件包。从名字中可知，这个软件让你的Linux系统能够控制红外线信号。&lt;/p&gt;
&lt;p&gt;LIRC有个具有图形用户界面的前端，叫做KDELirc&lt;/p&gt;
&lt;p&gt;在使用LIRC之前建议了解一下&lt;a href="http://www.cnblogs.com/yulongchen/archive/2013/04/12/3017409.html"&gt;红外协议&lt;/a&gt;，这样有助于你理解交互过程和debug&lt;/p&gt;
&lt;h3 id="_3"&gt;安装&lt;/h3&gt;
&lt;p&gt;sudo apt-get install lirc&lt;/p&gt;
&lt;h3 id="_4"&gt;配置&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;#sudo vim /boot/config.txt #在文件结尾添加
dtoverlay=lirc-rpi
gpio_in_pin=18
gpio_out_pin=17

#sudo vim /etc/lirc/hardware.conf  #编辑LRIC的配置文件
LIRCD_ARGS=&amp;quot;--uinput --listen&amp;quot;
DRIVER=&amp;quot;default&amp;quot;
DEVICE=&amp;quot;/dev/lirc0&amp;quot;
MODULES=&amp;quot;lirc_rpi&amp;quot;

# 重启生效
sudo /etc/init.d/lirc restart

# irrecord --list-namespace
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="_5"&gt;录制电风扇&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# 开始录制
irrecord -d /dev/lirc0 ~/lircd.conf #按照提示操作即可,录制完后会让你输入按键名

sudo cp ~/lircd.conf /etc/lirc/lircd.conf

#查看录制好可以使用的按键名
irsend LIST /home/pi/lircd.conf &amp;quot;&amp;quot;
irsend SEND_ONCE /home/pi/lircd.conf KEY_POWER
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="_6"&gt;录制空调红外&lt;/h3&gt;
&lt;p&gt;空调遥控器这种带逻辑控制的比较麻烦.每次发射的都是含有温度、模式、制冷制热等一连串的指令，按照之前irrecord指令生成conf文件，行不通&lt;/p&gt;
&lt;p&gt;只能使用raw的原始码，记录也是通过mode2 命令实现&lt;/p&gt;
&lt;p&gt;先制作模板：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo /etc/init.d/lirc restart
irrecord  -f -d /dev/lirc0 ~/lircd.conf #制作模板
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;得到&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;begin remote

  name  /home/pi/lircd.conf
  flags RAW_CODES
  eps            30
  aeps          100

  gap          19886

      begin raw_codes

          name KEY_OPEN
               90     102     331

      end raw_codes

end remote
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;接下来开始录制&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mode2  -d /dev/lirc0 &amp;gt; /tmp/temp.code  &lt;span class="c1"&gt;# space 10969878 &lt;/span&gt;
cat /tmp/temp.code &lt;span class="p"&gt;|&lt;/span&gt; sed -n &lt;span class="s1"&gt;&amp;#39;2,$p&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; grep -o  -E &lt;span class="s2"&gt;&amp;quot;[0-9]+&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; xargs &lt;span class="nb"&gt;echo&lt;/span&gt;  &lt;span class="c1"&gt;# 移除第一行,之后把所有数字取出&lt;/span&gt;
&lt;span class="c1"&gt;# 把上述指令写入 ~/lircd.conf 的 KEY_OPEN里&lt;/span&gt;
&lt;span class="c1"&gt;# 值得注意的是 ~/lircd.conf文件里的空格十分重要&lt;/span&gt;

sudo cp ~/lircd.conf /etc/lirc/lircd.conf
sudo /etc/init.d/lirc restart
&lt;span class="c1"&gt;# irsend LIST /home/pi/lircd.conf &amp;quot;&amp;quot; #列出指令&lt;/span&gt;
irsend SEND_ONCE /home/pi/lircd.conf KEY_OPEN
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;这是我最后的~/lircd.conf内容:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;begin remote

  name  /home/pi/lircd.conf
  flags RAW_CODES
  eps            30
  aeps          100

  gap          19886

      begin raw_codes

          name KEY_CLOSE
               9075 4411 731 453 751 1580 730 476 729 477 731 1576 729 478 729 1579 729 460 747 477 729 477 729 476 730 1578 729 477 730 476 731 477 733 472 730 476 731 475 730 477 728 480 728 477 729 1578 731 477 727 477 731 475 730 478 728 477 730 476 730 1578 754 430 753 1577 735 471 730 477 752 1553 756 453 753 19884 756 1551 758 451 754 450 756 451 756 451 754 449 756 451 757 429 777 449 758 449 758 449 756 451 755 450 756 1550 757 428 779 451 755 451 755 450 757 450 755 450 757 428 779 449 757 448 760 447 758 449 757 449 756 451 756 450 756 449 756 1551 757 1550 757 451 756
          name KEY_OPEN
               9112 4390 724 459 747 1584 725 459 746 1582 727 1582 726 481 724 1583 726 482 729 478 745 459 726 481 745 1564 724 480 725 481 746 459 725 488 741 438 770 457 748 457 749 459 747 459 748 1559 748 436 773 455 750 457 748 459 748 457 750 458 747 1559 749 459 746 1558 750 457 749 458 748 1558 751 455 749 19889 748 1559 750 457 748 458 749 458 750 457 747 458 748 458 749 435 771 458 749 457 748 459 745 461 745 460 747 1561 726 481 729 455 769 458 725 482 725 481 724 483 724 481 726 482 745 460 725 482 725 482 722 482 726 482 725 481 724 480 724 1583 725 1582 727 1583 726


      end raw_codes

end remote
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;我把开关机命名为KEY_OPEN/KEY_CLOSE(可以完全自定义)&lt;/p&gt;
&lt;p&gt;之后开关机的指令分别为：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;#开机
irsend SEND_ONCE /home/pi/lircd.conf KEY_OPEN
#关机
irsend SEND_ONCE /home/pi/lircd.conf KEY_CLOSE
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;测试有效！搞定&lt;/p&gt;
&lt;p&gt;之后结合温度传感器或者微信之类的其他功能模块就可以完成丰富的智能控制了&lt;/p&gt;
&lt;h1 id="_7"&gt;坑&lt;/h1&gt;
&lt;p&gt;配置文件中，KEY的名字有限制，BLOCKLY_KEY会报错 KEY_BLOCKLY就行&lt;/p&gt;
&lt;h1 id="_8"&gt;参考&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://zh.wikipedia.org/wiki/LIRC"&gt;LIRC&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://mageelen.blog.163.com/blog/static/1769430102014382346166/"&gt;使用树莓派遥控空调&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://www.cnblogs.com/yulongchen/archive/2013/04/12/3017409.html"&gt;红外协议之NEC协议&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://linux.cn/article-3782-1.html"&gt;使用树莓派红外控制空调和风扇&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://ukonline2000.com/?p=296"&gt;发布树莓派专用红外线扩展板&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">wuwenjie</dc:creator><pubDate>Mon, 17 Oct 2016 00:00:00 +0000</pubDate><guid isPermaLink="false">tag:,2016-10-17:raspberrypi-lirc.html</guid><category>tools</category></item><item><title>树莓派折腾笔记之系统安装与配置</title><link>/raspberrypi-install-and-config.html</link><description>&lt;p&gt;最近我的树莓派被用于作原型机了&lt;/p&gt;
&lt;p&gt;只好重新用新的板子重新配置&lt;/p&gt;
&lt;h1 id="_1"&gt;下载系统镜像&lt;/h1&gt;
&lt;p&gt;镜像&lt;a href="https://www.raspberrypi.org/downloads/"&gt;下载地址&lt;/a&gt;,这里有许多可选镜像,我用的是&lt;a href="https://www.raspberrypi.org/downloads/raspbian/"&gt;raspbian&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;我之前是在windows下用win32diskimager往sd卡里刷系统的&lt;/p&gt;
&lt;p&gt;这次准备用dd(方便批量操作)，在mac下.参考这篇文章：&lt;a href="https://github.com/ccforward/cc/issues/25"&gt;Mac下给SD卡安装树莓派Raspbian系统&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;2018.1.28更新: 推荐使用: &lt;a href="https://github.com/resin-io/etcher"&gt;etcher&lt;/a&gt;&lt;/p&gt;
&lt;h1 id="_2"&gt;安装系统&lt;/h1&gt;
&lt;p&gt;这里我们讨论两种情况，新买的sd卡和已经安装过系统的sd卡（重刷）&lt;/p&gt;
&lt;h3 id="sd"&gt;新的sd卡&lt;/h3&gt;
&lt;p&gt;一般新买的卡都已经格式化好了，这是最简单的情况,  按照&lt;a href="https://github.com/ccforward/cc/issues/25"&gt;Mac下给SD卡安装树莓派Raspbian系统&lt;/a&gt;的做法就行,微软下快速格式化可能会有问题(没有做分区)&lt;/p&gt;
&lt;p&gt;这里复述一下核心内容：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;df &lt;span class="c1"&gt;# 查看当前已经挂载的卷&lt;/span&gt;
&lt;span class="c1"&gt;# 假设设备文件为：/dev/disk1s1 ,（ 通过查看设备名判断）&lt;/span&gt;
diskutil unmount /dev/disk1s1 &lt;span class="c1"&gt;#卸载&lt;/span&gt;
diskutil list &lt;span class="c1"&gt;# 确认设备  (通过存储大小)&lt;/span&gt;
&lt;span class="c1"&gt;# 安装系统&lt;/span&gt;
dd &lt;span class="nv"&gt;bs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;4m &lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;pi.img &lt;span class="nv"&gt;of&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/dev/rdisk1 &lt;span class="c1"&gt;#我的速度大概是17m/s&lt;/span&gt;
diskutil unmountDisk /dev/disk1  &lt;span class="c1"&gt;#卸载设备&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;至此，系统就刷好了&lt;/p&gt;
&lt;h3 id="sd_1"&gt;重刷装有系统的sd卡&lt;/h3&gt;
&lt;p&gt;如果是重刷装有系统的sd卡,我们需要先把SD卡还原成初始状态：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;下载&lt;a href="http://www.alexpage.de/download/usbit/bootsector.img"&gt;bootsector.img&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;dd bs=4m if=./bootsector.img of=/dev/rdisk1 # 假设设备为disk1 &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;然后格式化sd卡(我把它格式化为MS-DOS(FAT))，至此你就可以把它当做新卡，用处理新卡的方式安装系统了&lt;/p&gt;
&lt;h1 id="_3"&gt;登录系统&lt;/h1&gt;
&lt;p&gt;我只买了树莓派，没有买高清转接头之类的东西，没打算把树莓派连到屏幕。那么我们如何登录系统，进行操作呢&lt;/p&gt;
&lt;p&gt;首先使用网络连接树莓派网口，然后找个扫描ip的软件,我用的是fing（mac和iphone都有），手机/电脑只要和树莓派在同个网络里，就可以找到它（通过设备名） （ps: brew cask install fing）&lt;/p&gt;
&lt;p&gt;然后ssh登录即可，用户名和密码分别是：pi/raspberry （11-25版本可能需要先进用屏幕登录在raspi-config里开启ssh:&lt;a href="https://www.raspberrypi.org/blog/a-security-update-for-raspbian-pixel/"&gt;A SECURITY UPDATE FOR RASPBIAN PIXEL&lt;/a&gt;) 文章提到如果你想默认默认ssh只需要在sd卡/boot/里加上&lt;code&gt;ssh&lt;/code&gt;文件就行，内容无所谓，可以为空&lt;/p&gt;
&lt;p&gt;树莓派3代自带无线网卡，我们把无线网卡连上wifi，之后就不需要，细节下文再说&lt;/p&gt;
&lt;h1 id="_4"&gt;配置&lt;/h1&gt;
&lt;p&gt;输入&lt;code&gt;sudo raspi-config&lt;/code&gt;开始设置，相关设置可以看说明&lt;/p&gt;
&lt;h2 id="expand-filesystem"&gt;#Expand Filesystem&lt;/h2&gt;
&lt;p&gt;扩展 SD 卡上可用的空间, 否则你会觉得怎么可用空间这么小&lt;/p&gt;
&lt;h3 id="vnc"&gt;配置&lt;a href="https://zh.wikipedia.org/zh/VNC"&gt;VNC&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;VNC借由网络，可发送键盘与鼠标的动作及即时的屏幕画面&lt;/p&gt;
&lt;p&gt;VNC与操作系统无关，因此可跨平台使用&lt;/p&gt;
&lt;p&gt;我在mac下使用RealVNC&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install tightvncserver &lt;span class="c1"&gt;# 安装&lt;/span&gt;
vncserver :1 &lt;span class="c1"&gt;# 启用 ，之后在 vnc client里输入 ip:1即可进入图形界面&lt;/span&gt;
&lt;span class="c1"&gt;# vncpasswd # 修改密码&lt;/span&gt;
&lt;span class="c1"&gt;# 使用这个更清晰&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;supervisor文件为:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;/etc/supervisord.conf.d/vncserver.conf
[program:vncserver]
user = pi  ; 用哪个用户启动
environment = HOME=&amp;quot;/home/pi&amp;quot;,USER=&amp;quot;pi&amp;quot;
directory =  /home/pi/mylab ; 程序的启动目录
command =  /usr/bin/vncserver :1
autostart = true     ; 在 supervisord 启动的时候也自动启动
startsecs = 5        ; 启动 5 秒后没有异常退出，就当作已经正常启动了
autorestart = false   ; 不需要自动重启
;startretries = 3     ; 启动失败自动重试次数，默认是 3
redirect_stderr = true  ; 把 stderr 重定向到 stdout，默认 false
stdout_logfile_maxbytes = 20MB  ; stdout 日志文件大小，默认 50MB
stdout_logfile_backups = 20     ; stdout 日志文件备份数
; stdout 日志文件，需要注意当指定目录不存在时无法正常启动，所以需要手动创建目录（supervisord 会自动创建日志文件）
stdout_logfile = /tmp/vncserver.log
;stopsignal = QUIT
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="_5"&gt;换国内源&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c"&gt;#sudo vi /etc/apt/sources.list ,使内容变为&lt;/span&gt;
&lt;span class="k"&gt;deb&lt;/span&gt; &lt;span class="s"&gt;http://mirrors.aliyun.com/raspbian/raspbian/&lt;/span&gt; &lt;span class="kp"&gt;jessie&lt;/span&gt; &lt;span class="kp"&gt;main&lt;/span&gt; &lt;span class="kp"&gt;non-free&lt;/span&gt; &lt;span class="kp"&gt;contrib&lt;/span&gt;
&lt;span class="k"&gt;deb-src&lt;/span&gt; &lt;span class="s"&gt;http://mirrors.aliyun.com/raspbian/raspbian/&lt;/span&gt; &lt;span class="kp"&gt;jessie&lt;/span&gt; &lt;span class="kp"&gt;main&lt;/span&gt; &lt;span class="kp"&gt;non-free&lt;/span&gt; &lt;span class="kp"&gt;contrib&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="hostname"&gt;修改hostname&lt;/h3&gt;
&lt;p&gt;sudo vim /etc/hostname&lt;/p&gt;
&lt;h3 id="_6"&gt;无线网络&lt;/h3&gt;
&lt;p&gt;如果你直接在命令行里配置可以参考:&lt;a href="http://www.jianshu.com/p/b42e8d3df449"&gt;树莓派 Raspberry Pi 设置无线上网&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;修改配置文件:&lt;code&gt;/etc/network/interfaces&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;auto wlan0
iface wlan0 inet dhcp
wpa-conf /etc/wpa.conf
iface default inet dhcp
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;之后在&lt;code&gt;/etc/wpa.conf&lt;/code&gt;里加上你的无线热点(可以添加多个)：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;network={
        ssid=&amp;quot;xxx&amp;quot;
        key_mgmt=WPA-PSK
        psk=&amp;quot;xxx&amp;quot;
        id_str=&amp;quot;myiphone&amp;quot;
}
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;无线网卡的控制命令为：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo ifup wlan0 &lt;span class="c1"&gt;#启用&lt;/span&gt;
sudo ifdown wlan0 &lt;span class="c1"&gt;#关闭&lt;/span&gt;
sudo service network-manager restart &lt;span class="c1"&gt;#重启&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;更直观的配置方式可以使用VNC client进入图形环境里&lt;/p&gt;
&lt;p&gt;如果你外接了usb网卡,记得加驱动,诸如(&lt;code&gt;sudo apt-get install firmware-realtek&lt;/code&gt;)&lt;/p&gt;
&lt;p&gt;如果有错，查看日志:&lt;code&gt;/var/log/syslog&lt;/code&gt;&lt;/p&gt;
&lt;h3 id="ap"&gt;树莓派作为无线AP&lt;/h3&gt;
&lt;p&gt;使用&lt;a href="https://github.com/oblique/create_ap"&gt;create_ap&lt;/a&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git clone https://github.com/oblique/create_ap
cd create_ap
sudo make install
#安装依赖
sudo apt-get install util-linux procps hostapd iproute2 iw haveged dnsmasq  #dnsmasq 是dns服务器

sudo create_ap wlan0 eth0 wwjpi3 wwjpipass --no-virt # https://github.com/oblique/create_ap/issues/185
# 加到supervisor里 #/usr/bin/create_ap  wlan0 eth0 wwjpi3 wwjpipass --no-virt
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;树莓派的地址为：&lt;code&gt;192.168.12.1&lt;/code&gt; , 路由器的地址为 &lt;code&gt;192.168.0.1&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;进一步的发挥空间，我们可以把它当做一个钓鱼热点(已经运行了53端口DNS服务器)&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;注意&lt;/strong&gt;：如果同时使用无线ap和普通wifi网卡，建议开机后再加入wifi网卡，然后ifup启用，否则可能导致热点无法开机启动&lt;/p&gt;
&lt;h4 id="dhcp"&gt;DHCP服务&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install dnsmasq
# vim /etc/dnsmasq.conf
interface=wlan0  #可能会影响wifi_ap
bind-interfaces
address=/#/192.168.12.1  #将对所有网站的访问重定向到本机

sudo service dnsmasq restart
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="vpn"&gt;连接VPN&lt;/h3&gt;
&lt;p&gt;安装客户端: &lt;code&gt;sudo apt-get install pptp-linux&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;使用root用户创建/etc/ppp/peers/vpn&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pty &amp;quot;pptp XXX.XXX.XXX.XXX --nolaunchpppd&amp;quot;
name 用户名
password 密码
remotename PPTP
require-mppe-128
require-mschap-v2
refuse-eap
refuse-pap
refuse-chap
refuse-mschap
noauth
persist
maxfail 0
defaultroute
replacedefaultroute
usepeerdns
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;启动/断开vpn:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pon vpn
poff vpn
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="_7"&gt;蓝牙&lt;/h3&gt;
&lt;p&gt;树莓派3自带蓝牙&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;/etc/init.d/bluetooth status &lt;span class="c1"&gt;# 查看蓝牙状态&lt;/span&gt;
sudo bluetoothctl &lt;span class="c1"&gt;#进入蓝牙程序,替代了原来的bluez-simple-agent&lt;/span&gt;
&lt;span class="c1"&gt;# 之后按照步骤连接 &lt;/span&gt;
&lt;span class="c1"&gt;# 试一首歌&lt;/span&gt;
apt-get install mpg123
mpg123 mp3_uri
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;蓝牙图形界不稳定，命令行的操作为&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;bluetoothctl
power on
scan on
agent on
pair #DD:8E:F1:CA:B8:9F #my bb8
trust DD:8E:F1:CA:B8:9F
connect DD:8E:F1:CA:B8:9F
quit
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;参考:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://zhuanlan.zhihu.com/p/20713396"&gt;树莓派3 model:B 连接蓝牙设备&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.embbnux.com/2016/04/10/raspberry_pi_3_wifi_and_bluetooth_setting_on_console/"&gt;树莓派3命令行配置wifi无线连接和蓝牙连接&lt;/a&gt;：rpi3蓝牙连音箱比较麻烦&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果蓝牙连接好 却无法播放声音，可能是默认的声音输出是系统声卡，设置&lt;code&gt;PulseAudio Volume Control&lt;/code&gt;，在设置里把bcm2835设置为off&lt;/p&gt;
&lt;h3 id="_8"&gt;音频相关&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;play&lt;/li&gt;
&lt;li&gt;mplayer/mpg123&lt;/li&gt;
&lt;li&gt;sox 录音&lt;/li&gt;
&lt;li&gt;alsamixer 调节音量&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sox -d /tmp/recording.wav
play /tmp/recording.wav
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="_9"&gt;坑&lt;/h3&gt;
&lt;p&gt;使用蓝牙音箱时，尽量不要同时将树莓派作为作为热点，否则可能导致声音卡顿&lt;/p&gt;
&lt;h4 id="pyaudio"&gt;PyAudio&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install libportaudio0 libportaudio2 libportaudiocpp0 portaudio19-dev 
sudo pip install PyAudio
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="_10"&gt;其它&lt;/h3&gt;
&lt;h4 id="_11"&gt;我的编程环境&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install vim git tmux ack-grep lynx

&lt;span class="c1"&gt;# 我的vim配置文件 &lt;/span&gt;
wget https://raw.githubusercontent.com/wwj718/wwj718-vim/master/wwj718_vim_vimrc -O ~/.vimrc
&lt;/pre&gt;&lt;/div&gt;


&lt;h4 id="jupyter-lab"&gt;jupyter lab （开发环境）&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo pip install pip --upgrade -i http://pypi.douban.com/simple
sudo apt-get install python-dev

&lt;span class="c1"&gt;# jupyter&lt;/span&gt;
sudo pip install jupyter  -i http://pypi.douban.com/simple --trusted-host pypi.douban.com
sudo pip install jupyterlab  -i http://pypi.douban.com/simple --trusted-host pypi.douban.com

sudo jupyter serverextension &lt;span class="nb"&gt;enable&lt;/span&gt; --py jupyterlab --sys-prefix
&lt;span class="c1"&gt;# jupyter lab --notebook-dir=&amp;quot;.&amp;quot; --no-browser --port 5000 --ip=0.0.0.0 &lt;/span&gt;
&lt;span class="c1"&gt;# vim ~/.bashrc&lt;/span&gt;
&lt;span class="c1"&gt;# alias jupyterlab=&amp;quot;jupyter lab --notebook-dir=&amp;quot;.&amp;quot; --no-browser --port 8888 --ip=0.0.0.0&amp;quot;&lt;/span&gt;
&lt;span class="c1"&gt;# jupyter notebook --no-browser --port 5000 --ip=0.0.0.0 &lt;/span&gt;
&lt;span class="c1"&gt;# 属于jupyter作为开发环境&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;建议使用jupyterlab&lt;/p&gt;
&lt;h4 id="z"&gt;&lt;a href="https://github.com/rupa/z"&gt;z&lt;/a&gt;&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;wget https://raw.githubusercontent.com/rupa/z/master/z.sh -O ~/z.sh
&lt;span class="c1"&gt;# 在.bashrc添加 ~/.bashrc&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; . ~/z.sh &amp;gt; ~/.bashrc
&lt;span class="c1"&gt;# souce ~/.bashrc&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id="gpio"&gt;GPIO相关&lt;/h1&gt;
&lt;h3 id="i2c"&gt;I2C&lt;/h3&gt;
&lt;p&gt;如果要用Adafruit_LED_Backpack,需要开启I2C&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install python-smbus
sudo apt-get install i2c-tools
sudo raspi-config &lt;span class="c1"&gt;#advanced options&lt;/span&gt;
sudo vim  /etc/modules &lt;span class="c1"&gt;# add i2c-bcm2708 and i2c-dev &lt;/span&gt;
&lt;span class="c1"&gt;# reboot&lt;/span&gt;
&lt;span class="c1"&gt;# test&lt;/span&gt;
sudo i2cdetect -y &lt;span class="m"&gt;1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id="_12"&gt;系统管理与监控&lt;/h1&gt;
&lt;h3 id="linux-dash"&gt;Linux Dash&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;A beautiful web dashboard for Linux&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git clone https://github.com/afaqurk/linux-dash
&lt;span class="nb"&gt;cd&lt;/span&gt; linux-dash
sudo python https://github.com/afaqurk/linux-dash
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;默认80端口&lt;/p&gt;
&lt;h1 id="_13"&gt;摄像头&lt;/h1&gt;
&lt;p&gt;我使用的是官方摄像头，连上后&lt;/p&gt;
&lt;p&gt;sudo raspi-config #Enable Camera&lt;/p&gt;
&lt;p&gt;查看是否正常:&lt;code&gt;ls /dev/video*&lt;/code&gt;,如果有video0就正常,如果没有，则 &lt;code&gt;sudo modprobe bcm2835-v4l2&lt;/code&gt; ,写入/etc/rc.local以保证开机运行&lt;/p&gt;
&lt;h3 id="_14"&gt;截个图&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install fswebcam
fswebcam -r 1280x720 /tmp/image1.jpg
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="motion"&gt;motion&lt;/h3&gt;
&lt;p&gt;监控与动作捕捉（像素变化）&lt;/p&gt;
&lt;p&gt;&lt;code&gt;sudo apt-get install motion&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;配置:`sudo vim /etc/motion/motion.conf&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;daemon off #on则后台运行
stream_localhost off #可以局域网内访问，否则只能localhost访问
webcontrol_localhost off
quiet on
videodevice /dev/video0
framerate 2 #30 很流畅 但是时间快
stream_maxrate 1 #30 
auto_brightness off
#target_dir /home/pi/camera_data
ffmpeg_output_movies on #输出视频（变化）
output_pictures off #输出图片
width 640
height 480
threshold 500 #灵敏度,变化的像素，决定是否捕捉
max_movie_time 5  #拍摄时间
logfile /tmp/motion.log
#noise_level 60
# event
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;运行 ：&lt;code&gt;sudo motion&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;访问：&lt;code&gt;ip:8081&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;默认存储在/var/lib/motion&lt;/p&gt;
&lt;h3 id="python"&gt;在python中调用&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pygame&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pygame.camera&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pygame.locals&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;

&lt;span class="c1"&gt;# initialize&lt;/span&gt;
&lt;span class="n"&gt;pygame&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;init&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;pygame&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;camera&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;init&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="c1"&gt;# capture a image&lt;/span&gt;
&lt;span class="n"&gt;camera&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pygame&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;camera&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Camera&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/dev/video0&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;640&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;480&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;camera&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;image&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;camera&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_image&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;pygame&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;image&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;save&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;image&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;image.jpg&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;camera&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;建议使用python3.6，pygame可直接使用pip安装&lt;/p&gt;
&lt;p&gt;使用pyenv文档参考: &lt;a href="http://blog.just4fun.site/python2-python3.html"&gt;python多版本安装笔记&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;记得先安装依赖&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install -y make build-essential libssl-dev zlib1g-dev libbz2-dev \
libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev \
xz-utils tk-dev
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="_15"&gt;机器视觉&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;pip install opencv-python&lt;/code&gt; 在树莓派上目前无法使用 https://github.com/skvark/opencv-python/issues/13&lt;/p&gt;
&lt;p&gt;需要编译安装:&lt;a href="https://www.pyimagesearch.com/2017/09/04/raspbian-stretch-install-opencv-3-python-on-your-raspberry-pi/"&gt;Raspbian Stretch: Install OpenCV 3 + Python on your Raspberry Pi&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="netdata"&gt;netdata&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;Get control of your servers. Simple. Effective. Awesome&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;apt-get install zlib1g-dev uuid-dev libmnl-dev gcc make git autoconf autoconf-archive autogen automake pkg-config curl
git clone https://github.com/firehol/netdata.git --depth&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
&lt;span class="nb"&gt;cd&lt;/span&gt; netdata

&lt;span class="c1"&gt;# build it, install it, start it&lt;/span&gt;
sudo ./netdata-installer.sh
&lt;span class="c1"&gt;# 访问ip:19999&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;相关数据：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;   - the daemon     at /usr/sbin/netdata
   - config files   in /etc/netdata
   - web files      in /usr/share/netdata
   - plugins        in /usr/libexec/netdata
   - cache files    in /var/cache/netdata
   - db files       in /var/lib/netdata
   - log files      in /var/log/netdata
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;卸载:&lt;code&gt;sudo  ./netdata-uninstaller.sh&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;如果要监控nginx，需要做些配置：&lt;a href="https://github.com/firehol/netdata/tree/master/python.d#nginx"&gt;netdata nginx&lt;/a&gt;，&lt;a href="https://github.com/firehol/netdata/wiki/The-spectacles-of-a-web-server-log-file"&gt;The spectacles of a web server log file&lt;/a&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;编译nginx

--with-http_stub_status_module
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="supervisor"&gt;supervisor&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;Supervisor process control system for UNIX&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;#切换到sudo用户&lt;/span&gt;
pip install supervisor
&lt;span class="c1"&gt;#echo_supervisord_conf &amp;gt; /etc/supervisord.conf #默认用这个&lt;/span&gt;
mkdir  /etc/supervisor
echo_supervisord_conf &amp;gt; /etc/supervisor/supervisord.conf &lt;span class="c1"&gt;#这个配置Ajenti才能管理&lt;/span&gt;
mkdir /etc/supervisord.conf.d
&lt;span class="c1"&gt;# 修改配置文件,include区段修改为 files = /etc/supervisord.conf.d/*.conf&lt;/span&gt;
&lt;span class="c1"&gt;# 开机自启 . 往/etc/rc.local加入/usr/local/bin/supervisord&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;supervisor的web管理端口为9001，需要开启&lt;/p&gt;
&lt;p&gt;添加新的进程配置，可以使用下边介绍的Ajenti来做, 配置信息会被直接写入：/etc/supervisor/supervisord.conf&lt;/p&gt;
&lt;p&gt;更多细节参考:&lt;a href="http://blog.just4fun.site/process-control-system-supervisor.html"&gt;使用Supervisor来管理进程&lt;/a&gt;&lt;/p&gt;
&lt;h4 id="demo"&gt;demo&lt;/h4&gt;
&lt;p&gt;/etc/supervisord.conf.d/socket_ipc.conf&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[program:socket_ipc]&lt;/span&gt;
&lt;span class="na"&gt;user&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;root     ; 用哪个用户启动&lt;/span&gt;
&lt;span class="na"&gt;directory&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;  &lt;span class="s"&gt;/home/pi/mylab/raspberrypi_lab ; 程序的启动目录&lt;/span&gt;
&lt;span class="na"&gt;command&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt;  &lt;span class="s"&gt;/usr/bin/python socket_ipc.py ;&lt;/span&gt;
&lt;span class="na"&gt;autostart&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;true     ; 在 supervisord 启动的时候也自动启动&lt;/span&gt;
&lt;span class="na"&gt;startsecs&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;5        ; 启动 5 秒后没有异常退出，就当作已经正常启动了&lt;/span&gt;
&lt;span class="na"&gt;autorestart&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;false   ; 不需要自动重启&lt;/span&gt;
&lt;span class="c1"&gt;;startretries = 3     ; 启动失败自动重试次数，默认是 3&lt;/span&gt;
&lt;span class="na"&gt;redirect_stderr&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;true  ; 把 stderr 重定向到 stdout，默认 false&lt;/span&gt;
&lt;span class="na"&gt;stdout_logfile_maxbytes&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;20MB  ; stdout 日志文件大小，默认 50MB&lt;/span&gt;
&lt;span class="na"&gt;stdout_logfile_backups&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;20     ; stdout 日志文件备份数&lt;/span&gt;
&lt;span class="c1"&gt;; stdout 日志文件，需要注意当指定目录不存在时无法正常启动，所以需要手动创建目录（supervisord 会自动创建日志文件）&lt;/span&gt;
&lt;span class="na"&gt;stdout_logfile&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;/tmp/socker_ipc.log&lt;/span&gt;
&lt;span class="c1"&gt;;stopsignal = QUIT&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="gotty"&gt;&lt;a href="https://github.com/yudai/gotty"&gt;gotty&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;gotty可以把terminal分享到web,默认端口是8080&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# 下载https://github.com/yudai/gotty/releases ，我下的是gotty_linux_arm.tar.gz&lt;/span&gt;
gotty -w vim &lt;span class="c1"&gt;#把vim已编辑方式分享出来,分享vim就够了，vim可以切换到bash&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;如果我们把8080端口用ngrok分享出来（ngrok用supervisor管理），实际就是一个后门，用作开发调试十分方便&lt;/p&gt;
&lt;h3 id="ajenti"&gt;&lt;a href="https://github.com/ajenti/ajenti"&gt;Ajenti&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Ajenti可以让你很简单地配置不同的常规服务程序，如Apache/nginx、Samba、BIND、Squid、MySQL、cron、防火墙等等&lt;/p&gt;
&lt;p&gt;十分适合非技术用户配置系统应用，可以看做服务器管理面板&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;wget http://repo.ajenti.org/debian/key -O- &lt;span class="p"&gt;|&lt;/span&gt; apt-key add -
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;deb http://repo.ajenti.org/debian main main debian&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /etc/apt/sources.list
sudo apt-get install ajenti
sudo apt-get install build-essential python-pip python-dev python-lxml libffi-dev libssl-dev libjpeg-dev libpng-dev uuid-dev python-dbus
&lt;span class="c1"&gt;# sudo easy_install -U pip #先升级,16.5.27的版本原始pip可能报错&lt;/span&gt;
sudo pip install ajenti-panel ajenti.plugin.dashboard ajenti.plugin.settings ajenti.plugin.plugins
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;默认端口8000，默认登录信息为：&lt;code&gt;root:admin&lt;/code&gt;，之后修改密码之类的都在控制面板里边做&lt;/p&gt;
&lt;p&gt;配置文件为:&lt;code&gt;/etc/ajenti/config.json&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;默认开机自启&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/ajenti69406213.png" /&gt;&lt;/p&gt;
&lt;h1 id="nodejs"&gt;国内源安装nodejs&lt;/h1&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;#注意编译非常慢
wget https://npm.taobao.org/mirrors/node/v6.9.1/node-v6.9.1.tar.gz
tar zxvf node-v6.9.1.tar.gz 
cd node-v6.9.1.tar.gz/ 
./configure 
sudo make install 
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id="_16"&gt;坑&lt;/h1&gt;
&lt;p&gt;09-23的版本坑多&lt;/p&gt;
&lt;h3 id="zipmac"&gt;zip包mac下无法解压&lt;/h3&gt;
&lt;p&gt;在linux和window下都行&lt;/p&gt;
&lt;h3 id="ssh"&gt;ssh端口拒绝&lt;/h3&gt;
&lt;p&gt;ip能ping通，ssh端口关闭，怀疑是ssh server没有开启&lt;/p&gt;
&lt;p&gt;nmap -p 22 xxx 测试关闭，fuck&lt;/p&gt;
&lt;p&gt;建议下载&lt;a href="https://downloads.raspberrypi.org/raspbian/images/raspbian-2016-05-31/2016-05-27-raspbian-jessie.zip"&gt;5-27版本&lt;/a&gt;,所有版本在这里：&lt;a href="https://downloads.raspberrypi.org/"&gt;downloads.raspberrypi.org&lt;/a&gt;&lt;/p&gt;
&lt;hr /&gt;
&lt;h1 id="201811020171129"&gt;2018.1.10更新（基于2017.11.29版本）&lt;/h1&gt;
&lt;h3 id="sshboot"&gt;初始化配置SSH(修改boot)&lt;/h3&gt;
&lt;p&gt;在 &lt;code&gt;boot&lt;/code&gt; 分区新建一个文件，空白的即可，文件命名为 &lt;code&gt;ssh&lt;/code&gt; . 默认用户名密码为:&lt;code&gt;pi:raspberry&lt;/code&gt;&lt;/p&gt;
&lt;h3 id="wifi"&gt;无屏幕和键盘配置树莓派WiFi&lt;/h3&gt;
&lt;p&gt;注意: 2017.11.29号的版本(Stretch)，无法使用.详情见&lt;a href="https://www.raspberrypi.org/forums/viewtopic.php?f=28&amp;amp;t=191061&amp;amp;start=50"&gt;Raspbian Stretch: Wifi not starting on boot&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;目前只使用于Stretch之前的版本&lt;/p&gt;
&lt;p&gt;在树莓派的 &lt;code&gt;/boot&lt;/code&gt; 目录下新建 &lt;code&gt;wpa_supplicant.conf&lt;/code&gt; 文件，按照下面的参考格式填入内容并保存 &lt;code&gt;wpa_supplicant.conf&lt;/code&gt; 文件&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;country=CN
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1

network={
ssid=&amp;quot;WiFi-A&amp;quot;
psk=&amp;quot;12345678&amp;quot;
key_mgmt=WPA-PSK
priority=1
}
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;建议使用有线网线先进入系统，打开vnc，然后在桌面中使用图形化方式连接wifi(之后永久有效)&lt;/p&gt;
&lt;p&gt;2017.11.29版本中scratch2、node-red、minecrafe都正常！&lt;/p&gt;
&lt;h3 id="vnc_1"&gt;vnc&lt;/h3&gt;
&lt;p&gt;关于vnc的参考这里:&lt;a href="https://www.raspberrypi.org/documentation/remote-access/vnc/"&gt;VNC (VIRTUAL NETWORK COMPUTING)&lt;/a&gt;,这篇文章关于配置minecraft部分无效&lt;/p&gt;
&lt;p&gt;默认用户名也是:&lt;code&gt;pi:raspberry&lt;/code&gt;&lt;/p&gt;
&lt;h3 id="vncminecraft"&gt;使用vnc玩minecraft&lt;/h3&gt;
&lt;p&gt;要使用vnc玩minecraft，参考&lt;a href="https://support.realvnc.com/Knowledgebase/Article/View/541/0/how-do-i-enable-the-experimental-direct-capture-feature-from-the-command-line"&gt;How do I enable the experimental direct capture feature from the command line?&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;在&lt;code&gt;/root/.vnc/config.d/vncserver-x11&lt;/code&gt;添加&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;CaptureTech=raspi

ExperimentalRaspiCapture=1

ServerPreferredEncoding=JPEG
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;重启vncserver:&lt;code&gt;sudo systemctl restart vncserver-x11-serviced&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;如果你觉得清晰且慢，可以试试:&lt;code&gt;vncserver&lt;/code&gt;&lt;/p&gt;
&lt;h4 id="novnc"&gt;noVNC&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git clone https://github.com/novnc/noVNC
# 安装好tightvncserver之后
./utils/launch.sh --vnc localhost:5901
# open: http://raspberrypi.local:6080/vnc.html?host=raspberrypi.local&amp;amp;port=6080
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;http://raspberrypi.local:6080/vnc.html?host=raspberrypi.local&amp;amp;port=6080&lt;/p&gt;
&lt;h3 id="remote-gpio"&gt;remote gpio&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;raspi-config&lt;/code&gt;, enable Remote GPIO&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;之后使用&lt;a href="https://github.com/RPi-Distro/python-gpiozero"&gt;python-gpiozero&lt;/a&gt;控制即可,文档参考:&lt;a href="https://gpiozero.readthedocs.io/en/stable/remote_gpio.html"&gt;Configuring Remote GPIO&lt;/a&gt;.之后你就可以在mac下使用python代码控制树莓派的gpio(&lt;code&gt;pip install gpiozero pigpio&lt;/code&gt;)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;export GPIOZERO_PIN_FACTORY=pigpio
export PIGPIO_ADDR=10.10.100.183
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;gpiozero&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;LED&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;time&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;sleep&lt;/span&gt;

&lt;span class="n"&gt;red&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;LED&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;17&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;red&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;on&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;sleep&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;red&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;off&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;sleep&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;也可以在scratch2中添加树莓派扩展，这样就可以在scratch2中利用remote gpio来与硬件交互&lt;/p&gt;
&lt;h4 id="_17"&gt;测试工具&lt;/h4&gt;
&lt;p&gt;shell 下使用&lt;code&gt;gpio&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;列出所有pin: &lt;code&gt;gpio readall&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# gpio用的mode是wPi，而gpiozero用的是BCM，所以pin17对应wpi的pin0
gpio mode 17 out
gpio read 17 # 0
gpio write 17 1
gpio read 17 # 1
gpio write 17 0
gpio read 17 # 0
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="20180130"&gt;2018.01.30更新&lt;/h3&gt;
&lt;p&gt;pi zero w可以可以直接使用pi3的镜像。其中的异同参考:&lt;a href="https://www.raspberrypi.org/forums/viewtopic.php?t=183954"&gt;SD Cards Images for Pi 3 and Pi Zero&lt;/a&gt;&lt;/p&gt;
&lt;h1 id="_18"&gt;参考&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://www.shumeipai.net/thread-1263-1-1.html?_dsign=55be35fa"&gt;用镜像写入工具将安装过树莓派系统的SD卡还原卡&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://shumeipai.nxez.com/2017/09/13/raspberry-pi-network-configuration-before-boot.html"&gt;无屏幕和键盘配置树莓派WiFi和SSH&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">wuwenjie</dc:creator><pubDate>Tue, 11 Oct 2016 00:00:00 +0000</pubDate><guid isPermaLink="false">tag:,2016-10-11:raspberrypi-install-and-config.html</guid><category>tools</category></item><item><title>树莓派守护者!</title><link>/pi-guardian.html</link><description>&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/pi_swzbe54be0b.png" /&gt;&lt;/p&gt;
&lt;h1 id="_1"&gt;老虎机与行窃少年&lt;/h1&gt;
&lt;p&gt;那年我大概十岁。&lt;/p&gt;
&lt;p&gt;家门口小店入驻了一台老虎机,每天放学回家路过小店，机器周围，围观者众。&lt;/p&gt;
&lt;p&gt;晚饭后喜欢跑到小店，看人们下注、击键、大笑、咒骂、跺脚，我喜欢老虎机侧边的位置，从这里透过机器的缝隙，看得到里边的电路板，上边数字闪烁，毫无规律&lt;/p&gt;
&lt;p&gt;此后许久，我对老虎机的兴趣一直很浓厚，多年之后，在大学图书馆的一角，饶有兴致地读到老虎机算法作者的书籍，他谈到你不可能赢过机器，唯一的获胜机会就是赢取你的同伴：你将机器视为中介，根据前边参与者的胜负，决定你的策略，这是你唯一获胜的可能&lt;/p&gt;
&lt;p&gt;某天一早，小店门口停着警车，热闹非凡，凑热闹这种事十岁小孩再感兴趣不过了。挤入小店，看到4个少年垂首丧气，双手被扣,十五六岁年纪. 是店里老虎机坐上常客。&lt;/p&gt;
&lt;p&gt;好事者纷纷问缘由，老板春风满面, 说起这群少年，如何三番五次，入室盗窃，手法精巧，行事谨慎. &lt;/p&gt;
&lt;p&gt;人们又问，你既说他们机智，你又如何逮到他们。&lt;/p&gt;
&lt;p&gt;老板等的便是这句，登时状如登上领奖台做获奖感言. 老板说自己早便发现他们入室盗窃，为了证据确凿，设计了一套精巧的陷阱：在柜台入口，近地面处系一根绳子，绳子一直连到老板睡觉的卧室，在卧室里系上易拉罐。少年们再次登门，触发开关，弄倒老板卧室的易拉罐，老板醒后，有备而来，少年们毫无知觉，来个瓮中捉鳖&lt;/p&gt;
&lt;p&gt;末了老板感叹一句这等聪明，用到学习上得多出色&lt;/p&gt;
&lt;p&gt;人们纷纷赞叹&lt;/p&gt;
&lt;h1 id="_2"&gt;基于树莓派的报警器&lt;/h1&gt;
&lt;p&gt;故事里，有一处不够优美:报警器竟是绳子做的！如果少年们更警觉些，看到绳子，或是踩到之后便逃离，老板恐怕要竹篮打水一场空。&lt;/p&gt;
&lt;p&gt;我们可以基于树莓派来重构报警器&lt;/p&gt;
&lt;h3 id="_3"&gt;思路&lt;/h3&gt;
&lt;p&gt;将超声波传感器（或者红外线）放在柜台下边，当有人路过时，树莓派给老板手机发送一条短信（或邮件），这个隐形的卫士几乎没有破绽&lt;/p&gt;
&lt;h3 id="_4"&gt;实现（硬件）&lt;/h3&gt;
&lt;p&gt;硬件部分，我们使用移动电源为树莓派供电，便于藏匿（移动电源可用大约一周）&lt;/p&gt;
&lt;p&gt;接线图如下(只需要关注超声波传感器)：&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="https://raw.githubusercontent.com/wwj718/gif_bed/master/pi_fritzing.png" /&gt;&lt;/p&gt;
&lt;h3 id="_5"&gt;实现（软件）&lt;/h3&gt;
&lt;p&gt;软件部分，我已经把源码放到这里了：&lt;a href="https://github.com/wwj718/raspberrypi_lab"&gt;raspberrypi_lab&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;这个项目的核心是，利用超声波传感器测距，当传感器前边有物体时，距离将发生变化，于是触发其他函数（发邮件）即可,核心源码为:&lt;a href="https://github.com/wwj718/raspberrypi_lab/blob/master/echo_main.py"&gt;echo_main&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;如果你想发送邮件，使用python的smtp库即可，如果你想发送短信，可以使用Twilio的api:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;twilio.rest&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;TwilioRestClient&lt;/span&gt;
&lt;span class="n"&gt;account&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;xxx&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;token&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;xxx&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;client&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TwilioRestClient&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;account&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;token&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;message&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;messages&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;create&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;to&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;+86137xxx&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;from_&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;+166xxx&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Wake up!&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;代码跑起来后，把它放柜台下，有人路过时，即可悄无声息地发送短信报警!&lt;/p&gt;
&lt;h1 id="_6"&gt;守护你的私密空间&lt;/h1&gt;
&lt;p&gt;我们来继续发挥&lt;code&gt;守护者&lt;/code&gt;这个概念，这次的目的是为了保护在房间里不好好学习，爱瞎折腾的你&lt;/p&gt;
&lt;p&gt;想想你在自己房间里看哆啦A梦(当然你也可以看些别的(羞射脸))&lt;/p&gt;
&lt;p&gt;班主任正在你家客厅家访。搞得你看动画片都不踏实,深怕有人破门而入&lt;/p&gt;
&lt;p&gt;让我们发挥geek精神，把树莓派打造为私密空间守护者。这个守护者的职责是：当有人进入房间时，在led矩阵上亮起笑脸以示欢迎，同时用蜂鸣器演奏一首歌吸引注意(我用了葫芦娃，你可以用老师窗前之类的 ^_^)&lt;/p&gt;
&lt;p&gt;led矩阵的源码如下：&lt;a href="https://github.com/wwj718/raspberrypi_lab/blob/master/smile.py"&gt;smile.py&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;蜂鸣器部分的源码为:&lt;a href="https://github.com/wwj718/raspberrypi_lab/blob/master/beep.py"&gt;beep.py&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;当门被打开时，超声波传感器将感觉到障碍物的出现，这是触发笑脸和音乐，最有意思的是下一步&lt;/p&gt;
&lt;h3 id="_7"&gt;切换电脑屏幕&lt;/h3&gt;
&lt;p&gt;你要知道你这个时候正看哆啦A梦看得兴起,你可能沉迷其中，听到音乐也来不及切换电脑屏幕，上班这段动作是典型的&lt;code&gt;触发&lt;/code&gt;模式，适合让机器来做，把它自动化！&lt;/p&gt;
&lt;p&gt;我们在电脑上跑起来一个进程，这个进程是个web服务，可以被调用，当被调用时（来自树莓派的http请求），我们的电脑屏幕将自动切换到iBook阅读界面，切换速度在毫秒级别，老师/家长一进门，便看到你在津津有味地看书，因为你还没从动画片里缓过神，肯定盯住屏幕的书。老师欣然离去&lt;/p&gt;
&lt;p&gt;这是打开之前你的屏幕：
&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/pi_guardian083cd92b.png" /&gt;&lt;/p&gt;
&lt;p&gt;哦不对，拿错图片了：
&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/pi_guardiancea87d3d.png" /&gt;&lt;/p&gt;
&lt;p&gt;这是房门打开之后你的屏幕：
&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/pi_guardian3aae2aad.png" /&gt;&lt;/p&gt;
&lt;p&gt;这个web服务的源码在这里：&lt;a href="https://github.com/wwj718/raspberrypi_lab/blob/master/pc_server.py"&gt;pc_server&lt;/a&gt;, 这个功能涉及代码很短，只有几行：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nd"&gt;@app.route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/study&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;study&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;to study&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;command&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;open&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/Applications/iBooks.app&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; 
    &lt;span class="n"&gt;subprocess&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;call&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;command&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;study&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;有了树莓派守护者，你就可以不必反锁房门，在你的电脑上做任何事儿, 不用担心被察觉啦&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">wuwenjie</dc:creator><pubDate>Fri, 07 Oct 2016 00:00:00 +0000</pubDate><guid isPermaLink="false">tag:,2016-10-07:pi-guardian.html</guid><category>技术</category></item><item><title>在树莓派上搭建代码托管服务器</title><link>/pi-gogs-install.html</link><description>&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/pi3e0c84b0.png" /&gt;&lt;/p&gt;
&lt;p&gt;最近公司有个好玩的项目，准备采用树莓派/arduino作为原型机，恰好我的玩具箱里两者都有&lt;/p&gt;
&lt;p&gt;擦擦尘土，把树莓派带到公司&lt;/p&gt;
&lt;p&gt;上周把arduino借给老板了，各种传感器也在其中，他出差没回，我的树莓派没有传感器可用，只要先折腾些软件应用&lt;/p&gt;
&lt;p&gt;公司的代码托管服务器是我之前搭建的（用了&lt;a href="https://github.com/gogits/gogs"&gt;gogs&lt;/a&gt;），我们部门搬到楼下，连接代码托管服务器需要vpn（网络的坑），速度不快，索性决定，在下边也搭建一个代码托管服务器。&lt;/p&gt;
&lt;p&gt;（考虑到安全，我还是决定自己折腾着玩好了，不过这个场景确实是挺实际的场景）&lt;/p&gt;
&lt;h1 id="_1"&gt;目的&lt;/h1&gt;
&lt;p&gt;这篇文章主要是想在树莓派上练习一下进程管理和开机自启&lt;/p&gt;
&lt;h1 id="_2"&gt;树莓派的入门&lt;/h1&gt;
&lt;p&gt;这类文章网上好多，我自己也有笔记，等有空再整理好了。&lt;/p&gt;
&lt;p&gt;对于装好系统的树莓派（我用的是Raspbian），你就把它当做一个普通的linux便可，没有太多特别的地方（习惯使用Debian/Ubuntu的话，用起来很轻松）&lt;/p&gt;
&lt;h1 id="gogs"&gt;安装gogs&lt;/h1&gt;
&lt;h3 id="_3"&gt;目录结构&lt;/h3&gt;
&lt;p&gt;我在HOME目录下建了个文件夹&lt;code&gt;mylab&lt;/code&gt;，用以做实验，gogs也放在这里&lt;/p&gt;
&lt;p&gt;下载二进制安装包：&lt;code&gt;https://dl.gogs.io/gogs_v0.9.60_raspi2.zip&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;解压：&lt;code&gt;unzip gogs_v0.9.60_raspi2.zip&lt;/code&gt;,于是获得gogs的解压目录：&lt;code&gt;/home/pi/mylab/gogs&lt;/code&gt; （我的操作用户是默认的pi）&lt;/p&gt;
&lt;h3 id="_4"&gt;初始化&lt;/h3&gt;
&lt;p&gt;进入&lt;code&gt;/home/pi/mylab/gogs&lt;/code&gt;目录，将gogs跑起来:&lt;code&gt;./gogs web&lt;/code&gt;,默认跑在3000端口，打开你的&lt;code&gt;ip:3000&lt;/code&gt;,填好内容，就可以初始化了，如果使用sqlite就不需要安装数据库&lt;/p&gt;
&lt;p&gt;初始化完毕我们把&lt;code&gt;./gogs web&lt;/code&gt;断掉（ctrl-c），下边演示使用使用Supervisor来管理进程&lt;/p&gt;
&lt;p&gt;关于gogs的更多细节可以参考我之前的笔记&lt;a href="http://blog.just4fun.site/gogs-install.html"&gt;搭建 gogs 代码托管服务器&lt;/a&gt;&lt;/p&gt;
&lt;h1 id="supervisorgogs"&gt;使用Supervisor来管理gogs进程&lt;/h1&gt;
&lt;p&gt;关于supervisor的介绍和细节何以参考我此前的笔记：&lt;a href="http://blog.just4fun.site/process-control-system-supervisor.html"&gt;使用Supervisor来管理进程&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="_5"&gt;安装&lt;/h3&gt;
&lt;p&gt;sudo pip install supervisor #安装supervisor&lt;/p&gt;
&lt;h3 id="_6"&gt;配置&lt;/h3&gt;
&lt;p&gt;切换到root：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;echo_supervisord_conf &amp;gt; /etc/supervisord.conf
mkdir /etc/supervisord.conf.d
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;将&lt;code&gt;/etc/supervisord.conf&lt;/code&gt;中的include部分修改为：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[include]&lt;/span&gt;
&lt;span class="na"&gt;files&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;/etc/supervisord.conf.d/*.conf&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;创建&lt;code&gt;/etc/supervisord.conf.d/gogs.conf&lt;/code&gt;,内容如下&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[program:gogs]&lt;/span&gt;

&lt;span class="na"&gt;user&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;pi&lt;/span&gt;
&lt;span class="na"&gt;directory&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;/home/pi/mylab/gogs&lt;/span&gt;
&lt;span class="na"&gt;command&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;/home/pi/mylab/gogs/gogs web&lt;/span&gt;
&lt;span class="na"&gt;environment&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;HOME=&amp;quot;/home/pi&amp;quot;, USER=&amp;quot;pi&amp;quot;&lt;/span&gt;
&lt;span class="na"&gt;autostart&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;true&lt;/span&gt;
&lt;span class="na"&gt;autorestart&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;true&lt;/span&gt;
&lt;span class="na"&gt;startsecs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;10&lt;/span&gt;
&lt;span class="na"&gt;stdout_logfile&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;/var/log/gogs/stdout.log&lt;/span&gt;
&lt;span class="na"&gt;stdout_logfile_maxbytes&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;1MB&lt;/span&gt;
&lt;span class="na"&gt;stdout_logfile_backups&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;10&lt;/span&gt;
&lt;span class="na"&gt;stdout_capture_maxbytes&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;1MB&lt;/span&gt;
&lt;span class="na"&gt;stderr_logfile&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;/var/log/gogs/stderr.log&lt;/span&gt;
&lt;span class="na"&gt;stderr_logfile_maxbytes&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;1MB&lt;/span&gt;
&lt;span class="na"&gt;stderr_logfile_backups&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;10&lt;/span&gt;
&lt;span class="na"&gt;stderr_capture_maxbytes&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;1MB&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;之后就可以使用supervisor来管理gogs了：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;/usr/local/bin/supervisord 
supervisorctl restart gogs
supervisorctl status
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id="_7"&gt;开机自启&lt;/h1&gt;
&lt;p&gt;简单的方法是往/etc/rc.local加入/usr/local/bin/supervisord&lt;/p&gt;
&lt;p&gt;重启机器，一切完备！&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/pi79409598.png" /&gt;&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">wuwenjie</dc:creator><pubDate>Mon, 29 Aug 2016 00:00:00 +0000</pubDate><guid isPermaLink="false">tag:,2016-08-29:pi-gogs-install.html</guid><category>技术</category></item><item><title>用微信控制树莓派</title><link>/pi-wechat.html</link><description>&lt;p&gt;&lt;img alt="" src="http://wwj-fig-bed.just4fun.site/wechat_pid9f17e53.png" /&gt;&lt;/p&gt;
&lt;h1 id="_1"&gt;源码&lt;/h1&gt;
&lt;p&gt;老习惯，先抛源码，老司机可以直接读&lt;a href="https://github.com/wwj718/raspberrypi_api"&gt;源码&lt;/a&gt;&lt;/p&gt;
&lt;h1 id="_2"&gt;动机&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;近期公司有一个有趣的项目，希望用乐高玩具式的可视化编程工具来操控硬件(在网页中)&lt;ul&gt;
&lt;li&gt;所以想把硬件的响应包装为服务&lt;ul&gt;
&lt;li&gt;于是得到可以用微信操作树莓派这个副产品&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;树莓派操控硬件需要有root权限，作为服务之后则没有限制&lt;/li&gt;
&lt;li&gt;解耦&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="_3"&gt;想法&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;将微信视为控制界面（interface）, 获得联网能力（远程操作）&lt;/li&gt;
&lt;li&gt;将树莓派视为连接代码和物理世界的介质&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="_4"&gt;架构设计&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;初期效用flask作为web框架&lt;ul&gt;
&lt;li&gt;使用flask-sockets提供websocket服务:&lt;a href="https://github.com/wwj718/raspberrypi_api/blob/master/led_websocket.py"&gt;led_websocket.py&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;把led_server视为下位机，api视为指令集&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="gpio"&gt;树莓派与GPIO&lt;/h1&gt;
&lt;p&gt;关于如何使用树莓派的引脚操作外部设备，推荐阅读mango同学的&lt;a href="http://blog.mangolovecarrot.net/2015/04/20/raspi-study01/"&gt;树莓派GPIO入门01-使用GPIO接口控制发光二极管闪烁&lt;/a&gt;，写得十分清楚&lt;/p&gt;
&lt;p&gt;通过&lt;code&gt;RPi.GPIO&lt;/code&gt;库，我们几乎不需要硬件的知识，就能轻易地用python代码操控硬件&lt;/p&gt;
&lt;h1 id="_5"&gt;接口定义&lt;/h1&gt;
&lt;p&gt;我们接下来led为例,演示如何将硬件功能暴露为api,可通过http请求，操控硬件（暂不考虑操作权限/安全问题，如果你愿意可以简单定义一个秘钥：&lt;code&gt;?key=xx&lt;/code&gt;），对细节感情兴趣的小伙伴可以跟进我的&lt;a href="https://github.com/wwj718/raspberrypi_api/"&gt;源码库&lt;/a&gt;，我有计划把它做得完备。&lt;/p&gt;
&lt;p&gt;目前我们定义三个功能：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;点亮led灯&lt;/li&gt;
&lt;li&gt;熄灭led灯&lt;/li&gt;
&lt;li&gt;使led灯闪烁几次&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;接下来使用flask将其暴露出去，成为web api&lt;/p&gt;
&lt;p&gt;代码读起来很容易:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# 点亮led灯&lt;/span&gt;
&lt;span class="nd"&gt;@app.route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/led_up&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;led_up&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="c1"&gt;# 让GPIO14输出高电平（LED灯亮）&lt;/span&gt;
    &lt;span class="n"&gt;RPi&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GPIO&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;14&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;ok&amp;#39;&lt;/span&gt;

&lt;span class="c1"&gt;# 熄灭led灯&lt;/span&gt;
&lt;span class="nd"&gt;@app.route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/led_down&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;led_down&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="c1"&gt;# 让GPIO14输出低电平（LED灯灭）&lt;/span&gt;
    &lt;span class="n"&gt;RPi&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GPIO&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;14&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;ok&amp;#39;&lt;/span&gt;

&lt;span class="c1"&gt;# 使led灯闪烁几次&lt;/span&gt;
&lt;span class="nd"&gt;@app.route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/led_up_down&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;led_up_down&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;RPi&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GPIO&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;14&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="c1"&gt;# 持续一段时间&lt;/span&gt;
        &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sleep&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mf"&gt;0.5&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;RPi&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;GPIO&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;14&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sleep&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mf"&gt;0.5&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;ok&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;完整的源码参考&lt;a href="https://github.com/wwj718/raspberrypi_api/edit/master/led_server.py"&gt;led_server.py&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;现在我们可以把服务跑起来了：&lt;code&gt;sudo python led_server.py&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;ps： websocket版本参考这里：&lt;a href="https://github.com/wwj718/raspberrypi_api/blob/master/led_websocket.py"&gt;led_websocket.py&lt;/a&gt;&lt;/p&gt;
&lt;h1 id="_6"&gt;测试接口&lt;/h1&gt;
&lt;p&gt;我的树莓派当前ip为：192.168.0.106&lt;/p&gt;
&lt;p&gt;我们对这些api进行测试：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;点亮红灯： curl 192.168.0.106/led_up&lt;/li&gt;
&lt;li&gt;熄灭红灯： curl 192.168.0.106/led_down&lt;/li&gt;
&lt;li&gt;闪啊闪 ： curl 192.168.0.106/led_up_down&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;你也可以在浏览器里控制这些灯（使用js）：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nx"&gt;xmlhttp&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nx"&gt;XMLHttpRequest&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;span class="nx"&gt;xmlhttp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;GET&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;http://192.168.0.106/led_up_down&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="kc"&gt;true&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="c1"&gt;//闪烁&lt;/span&gt;
&lt;span class="nx"&gt;xmlhttp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;send&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;如此一来我们可以在浏览器里操控硬件了&lt;/p&gt;
&lt;h1 id="_7"&gt;对接微信&lt;/h1&gt;
&lt;p&gt;对接微信这步很简单,如果你读过我之前的文章：&lt;a href="http://blog.just4fun.site/create-wechat-bot.html"&gt;把聊天机器人接入微信&lt;/a&gt;，直接看源码就好了。没读过前文也没关系，代码很好理解，我把核心部分列下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;wxbot&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;WXBot&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;requests&lt;/span&gt;
&lt;span class="n"&gt;led_server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;http://127.0.0.1:5000/&amp;#39;&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;MyWXBot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;WXBot&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_led&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;user_input&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;action&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;正在{}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;user_input&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;send_msg_by_uid&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;user&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
        &lt;span class="n"&gt;url&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;led_server&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;action&lt;/span&gt;
        &lt;span class="n"&gt;requests&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;完成{}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;user_input&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;send_msg_by_uid&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;user&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;


    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;handle_msg_all&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;msg_type_id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt; &lt;span class="ow"&gt;and&lt;/span&gt; &lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;content&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;type&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;user_input&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;content&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;data&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
            &lt;span class="c1"&gt;#payload={&amp;quot;user_input&amp;quot;:user_input}&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;关&amp;#39;&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;user_input&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_led&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;user_input&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;led_down&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;开&amp;#39;&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;user_input&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_led&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;user_input&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;led_up&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;闪&amp;#39;&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;user_input&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_led&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;user_input&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;led_up_down&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;源码在这里：&lt;a href="https://github.com/wwj718/raspberrypi_api/blob/master/wechat_pi.py"&gt;wechat_pi.py&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;跑起来就好：&lt;code&gt;python wechat_pi.py&lt;/code&gt;,由于需要微信扫码，所以先把你的树莓派连到屏幕上（使用图形界面），我使用VNC，之后有空把二维码弄到命令行里&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="https://raw.githubusercontent.com/wwj718/gif_bed/master/ledf96a0f7d.png" /&gt;&lt;/p&gt;
&lt;h1 id="_8"&gt;脑洞&lt;/h1&gt;
&lt;p&gt;因为微信能在广域网中使用，所以你可以在任何能联网的地方控制树莓派了，进行远程控制，我最近的一个脑洞是在下班路上用微信给树莓派发一个&lt;code&gt;打开空调&lt;/code&gt;的消息，就可以提前打开空调啦&lt;/p&gt;
&lt;p&gt;原理也很简单使用红外接收器学习空调遥控器的指令集（目前只要开关机的指令），然后使用红外发射器伪造成遥控器控制空调。最后对接到微信即可&lt;/p&gt;
&lt;p&gt;目前采集红外信号部分已经完成了&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">wuwenjie</dc:creator><pubDate>Mon, 29 Aug 2016 00:00:00 +0000</pubDate><guid isPermaLink="false">tag:,2016-08-29:pi-wechat.html</guid><category>技术</category></item><item><title>搭建 gogs 代码托管服务器</title><link>/gogs-install.html</link><description>&lt;p&gt;前头写到搭建好了gitlab，不过没有找到汉化的方法，而且看去界面蛮繁琐的（针对没有使用github的同学而言）。为了降低大家入门门槛，决定使用gogs来搭建代码托管服务器。&lt;/p&gt;
&lt;h1 id="gogs"&gt;gogs&lt;/h1&gt;
&lt;p&gt;github上的star截止至15.08.03，已经超过8k。自助安装极其方便，有各个平台的二进制文件，甚至可以轻易搭建在树莓派上&lt;/p&gt;
&lt;h1 id="install"&gt;install&lt;/h1&gt;
&lt;h2 id="mysql"&gt;安装mysql&lt;/h2&gt;
&lt;p&gt;你也可以不安装任何数据库，默认会使用sqlite&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install mysql-server
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;进入mysql，创建好数据库：&lt;code&gt;CREATE DATABASE gogs;&lt;/code&gt;&lt;/p&gt;
&lt;h2 id="gogs_1"&gt;安装gogs&lt;/h2&gt;
&lt;p&gt;采用二进制安装&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;wget http://gogs.dn.qbox.me/gogs_v0.6.3_linux_amd64.zip
unzip gogs_v0.6.3_linux_amd64.zip
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="run-it"&gt;run it&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;chmod +x gogs
./gogs web
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;跑起来后进入到一个安装配置页面,邮件服务器的配置需要注意一下端口号，举个栗子：&lt;code&gt;smtp.qq.com:25&lt;/code&gt;.此外注意一下当出现&lt;code&gt;运行系统用户非当前用户&lt;/code&gt;错误是，在配置里填上你运行&lt;code&gt;./gogs web&lt;/code&gt;对应的用户&lt;/p&gt;
&lt;p&gt;如果需要修改配置文件，只要编辑gogs目录下的:&lt;code&gt;custom/conf/app.ini&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;整个过程极其建议&lt;/p&gt;
&lt;p&gt;ps:管理员可以不设置，第一个注册的用户将被认为是管理员&lt;/p&gt;
&lt;p&gt;如果要reinstall，只要把data和custom目录删除即可&lt;/p&gt;
&lt;h2 id="_1"&gt;备份&lt;/h2&gt;
&lt;p&gt;默认情况下，代码仓库在&lt;code&gt;~/gogs-repositories&lt;/code&gt;下，备份的话除了备份数据库(gogs/data)，也注意备份这个目录，推荐使用backup，我在此前的一篇博客里有提到:&lt;a href="http://wwj718.github.io/use-backup-for-edx.html"&gt;here&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;backup的安装非常蛋疼，在ruby1.9中各种出错，还是使用rsync好了&lt;/p&gt;
&lt;h3 id="rsync"&gt;使用rsync同步数据&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;配置好ssh免登陆&lt;ul&gt;
&lt;li&gt;ssh-keygen -t dsa&lt;/li&gt;
&lt;li&gt;sudo cp -R .ssh /root/&lt;/li&gt;
&lt;li&gt;ssh-copy-id -i .ssh/id_dsa.pub xx@backup_host&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;本地推送到远程：&lt;code&gt;/usr/bin/rsync -avH  /home/xx/gogs-repositories xx@backup_host:~/backup/&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;备份mysql数据    &lt;ul&gt;
&lt;li&gt;/usr/bin/mysqldump -uroot -pxxx gogs &amp;gt; /tmp/gogs.sql  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;使用cron写定时任务&lt;ul&gt;
&lt;li&gt;&lt;code&gt;00 01 * * * /usr/bin/rsync xxx&lt;/code&gt; （每天凌晨1点同步数据）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="supervisor"&gt;使用Supervisor管理进程&lt;/h1&gt;
&lt;p&gt;参考&lt;a href="http://blog.just4fun.site/process-control-system-supervisor.html"&gt;使用Supervisor来管理进程&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;在&lt;code&gt;/etc/supervisord.conf.d/&lt;/code&gt;创建&lt;code&gt;gogs.conf&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[program:gogs]

user=wwj
directory=/home/wwj/gogs/gogs
command=/home/wwj/gogs/gogs/gogs web
environment = HOME=&amp;quot;/home/wwj&amp;quot;, USER=&amp;quot;wwj&amp;quot;
autostart=true
autorestart=true
startsecs=10
stdout_logfile=/var/log/gogs/stdout.log
stdout_logfile_maxbytes=1MB
stdout_logfile_backups=10
stdout_capture_maxbytes=1MB
stderr_logfile=/var/log/gogs/stderr.log
stderr_logfile_maxbytes=1MB
stderr_logfile_backups=10
stderr_capture_maxbytes=1MB
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;supervisorctl  restart gogs&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">wuwenjie</dc:creator><pubDate>Mon, 03 Aug 2015 00:00:00 +0000</pubDate><guid isPermaLink="false">tag:,2015-08-03:gogs-install.html</guid><category>技术</category></item></channel></rss>